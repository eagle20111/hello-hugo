<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥ | Jian&#39;s Blog</title>
<meta name="keywords" content="Horovod">
<meta name="description" content="reference: [1].https://www.cnblogs.com/rossiXYZ/p/14856543.html 0 æ‘˜è¦ Horovod æ˜¯Uberäº2017å¹´å‘å¸ƒçš„ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ï¼Œåœ¨ä¸šç•Œå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚ æœ¬ç³»åˆ—å°†é€šè¿‡æºç åˆ†ææ¥å¸¦é¢†å¤§å®¶äº†è§£ Hor">
<meta name="author" content="Jian">
<link rel="canonical" href="https://jianye0428.github.io/en/posts/notes/2022-10-08_horovod_2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.1ea9c8832138446635789668415e5c75b8a534b191ee749a44f5ab404c9f27c2.css" integrity="sha256-HqnIgyE4RGY1eJZoQV5cdbilNLGR7nSaRPWrQEyfJ8I=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jianye0428.github.io/favicon/jian_icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://jianye0428.github.io/favicon/jian_icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jianye0428.github.io/favicon/jian_icon.png">
<link rel="apple-touch-icon" href="https://jianye0428.github.io/favicon/apple-touch-icon.png">
<link rel="mask-icon" href="https://jianye0428.github.io/favicon/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://jianye0428.github.io/en/posts/notes/2022-10-08_horovod_2/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<meta name="baidu-site-verification" content="code-9oLyeix0aK" />
<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4a41bf85d719f0e8c3165fc76904f546";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>



<script defer crossorigin="anonymous" src="/js/katex.min.8f5024e83d2055dd60e021751066111b0057e230db34911dd56242d67f0a4c86.js" integrity="sha256-j1Ak6D0gVd1g4CF1EGYRGwBX4jDbNJEd1WJC1n8KTIY="></script>


<script defer crossorigin="anonymous" src="/js/auto-render.min.b09accad850e4e87b8a2fc8b93fae790def79172b68de72fd777958c52e566ad.js" integrity="sha256-sJrMrYUOToe4ovyLk/rnkN73kXK2jecv13eVjFLlZq0="></script>

<script>
    
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });

    
    window.WebFontConfig = {
        custom: {
            families: ['KaTeX_AMS', 'KaTeX_Caligraphic:n4,n7', 'KaTeX_Fraktur:n4,n7',
            'KaTeX_Main:n4,n7,i4,i7', 'KaTeX_Math:i4,i7', 'KaTeX_Script',
            'KaTeX_SansSerif:n4,n7,i4', 'KaTeX_Size1', 'KaTeX_Size2', 'KaTeX_Size3',
            'KaTeX_Size4', 'KaTeX_Typewriter'],
        },
    };
</script>


<script defer crossorigin="anonymous" src="/js/webfontloader.min.min.d1c6c39d18e2decb5c99dc9efc579098ab37b9654725df3f9c0737bc2dd00760.js" integrity="sha256-0cbDnRji3stcmdye/FeQmKs3uWVHJd8/nAc3vC3QB2A="></script>


 

<script async src="https://www.googletagmanager.com/gtag/js?id=G-C6GDZ56F4S"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-C6GDZ56F4S', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥" />
<meta property="og:description" content="reference: [1].https://www.cnblogs.com/rossiXYZ/p/14856543.html 0 æ‘˜è¦ Horovod æ˜¯Uberäº2017å¹´å‘å¸ƒçš„ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ï¼Œåœ¨ä¸šç•Œå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚ æœ¬ç³»åˆ—å°†é€šè¿‡æºç åˆ†ææ¥å¸¦é¢†å¤§å®¶äº†è§£ Hor" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jianye0428.github.io/en/posts/notes/2022-10-08_horovod_2/" /><meta property="og:image" content="https://i.loli.net/2021/09/26/3OMGXylm8HUYJ6p.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-08T17:25:41&#43;08:00" />
<meta property="article:modified_time" content="2022-10-08T17:25:41&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://i.loli.net/2021/09/26/3OMGXylm8HUYJ6p.png"/>

<meta name="twitter:title" content="æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥"/>
<meta name="twitter:description" content="reference: [1].https://www.cnblogs.com/rossiXYZ/p/14856543.html 0 æ‘˜è¦ Horovod æ˜¯Uberäº2017å¹´å‘å¸ƒçš„ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ï¼Œåœ¨ä¸šç•Œå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚ æœ¬ç³»åˆ—å°†é€šè¿‡æºç åˆ†ææ¥å¸¦é¢†å¤§å®¶äº†è§£ Hor"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://jianye0428.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥",
      "item": "https://jianye0428.github.io/en/posts/notes/2022-10-08_horovod_2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥",
  "name": "æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥",
  "description": "reference: [1].https://www.cnblogs.com/rossiXYZ/p/14856543.html 0 æ‘˜è¦ Horovod æ˜¯Uberäº2017å¹´å‘å¸ƒçš„ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ï¼Œåœ¨ä¸šç•Œå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚ æœ¬ç³»åˆ—å°†é€šè¿‡æºç åˆ†ææ¥å¸¦é¢†å¤§å®¶äº†è§£ Hor",
  "keywords": [
    "Horovod"
  ],
  "articleBody": "reference: [1].https://www.cnblogs.com/rossiXYZ/p/14856543.html\n0 æ‘˜è¦ Horovod æ˜¯Uberäº2017å¹´å‘å¸ƒçš„ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ï¼Œåœ¨ä¸šç•Œå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚\næœ¬ç³»åˆ—å°†é€šè¿‡æºç åˆ†ææ¥å¸¦é¢†å¤§å®¶äº†è§£ Horovodã€‚ç³»åˆ—å¤§çº¦æœ‰15 ï½ 18 ç¯‡ï¼Œæœ¬æ–‡æ˜¯ç³»åˆ—ç¬¬äºŒç¯‡ï¼Œä»ç”¨æˆ·è§’åº¦åˆ‡å…¥ Horovodã€‚\nå‰ä¸€ç¯‡å‚è§å¦‚ä¸‹ï¼š\næ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[1] â€“ åŸºç¡€çŸ¥è¯†\n1 Horovod ç®€ä»‹ Horovod æ˜¯Uberäº2017å¹´å‘å¸ƒçš„ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ï¼Œæ”¯æŒTensorFlowï¼ŒKerasï¼ŒPyTorchå’ŒMXNetã€‚Horovod çš„åå­—æ¥è‡ªäºä¿„å›½ä¼ ç»Ÿæ°‘é—´èˆè¹ˆï¼Œèˆè€…æ‰‹ç‰µæ‰‹å›´æˆä¸€ä¸ªåœˆè·³èˆï¼Œä¸åˆ†å¸ƒå¼ TensorFlow æµç¨‹ä½¿ç”¨ Horovod äº’ç›¸é€šä¿¡çš„åœºæ™¯å¾ˆåƒã€‚\nå› ä¸ºå„ä¸ªæœºå™¨å­¦ä¹ æ¡†æ¶å¯¹äºåº•å±‚é›†åˆé€šä¿¡åº“ï¼ˆ ncclï¼Œopenmpiï¼Œgloo ç­‰ç­‰ï¼‰çš„åˆ©ç”¨æ°´å¹³å¯èƒ½å„ä¸ç›¸åŒï¼Œä½¿å¾—ä»–ä»¬æ— æ³•å……åˆ†åˆ©ç”¨è¿™äº›åº•å±‚é›†åˆé€šä¿¡åº“çš„å¨åŠ›ã€‚å› è€Œï¼Œhovorod å°±æ•´åˆè¿™äº›æ¡†æ¶ï¼Œæä¾›ä¸€ä¸ªæ˜“ç”¨é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚\nUberçš„å·¥ç¨‹å¸ˆå°±æ˜¯æ ¹æ®FaceBookçš„ä¸€ç¯‡paperï¼šâ€œAccurate, Large Minibatch SGD: Training ImageNet in 1 Hourâ€å’Œç™¾åº¦çš„ä¸€ç¯‡â€œBringing HPC Techniques to Deep Learningâ€ æ”¹è¿›å¹¶å‘å¸ƒäº†å¼€æºæ¡†æ¶Horovodã€‚\nHorovod ç›¸æ¯”äºç™¾åº¦çš„å·¥ä½œï¼Œå¹¶æ— å­¦æœ¯ä¸Šçš„è´¡çŒ®ã€‚ä½†æ˜¯ Horovod æ‰å®çš„å·¥ç¨‹å®ç°ï¼Œä½¿å¾—å®ƒå—åˆ°äº†æ›´å¤šçš„å…³æ³¨ã€‚å®ƒæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºå¯¹ RingAllReduce è¿›è¡Œäº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ï¼Œä½¿å…¶æ”¯æŒå¤šç§ä¸åŒçš„æ¡†æ¶ã€‚åŒæ—¶å¼•å…¥äº† Nvidia NCCLï¼Œå¯¹ GPU æ›´åŠ å‹å¥½ã€‚\nHorovodä¾èµ–äºNvidiaçš„ NCCL2 åš All Reduceï¼Œä¾èµ–äºMPIåšè¿›ç¨‹é—´é€šä¿¡ï¼Œç®€åŒ–äº†åŒæ­¥å¤š GPU æˆ–å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼è®­ç»ƒçš„å¼€å‘æµç¨‹ã€‚ç”±äºä½¿ç”¨äº†NCCL2ï¼ŒHorovodä¹Ÿå¯ä»¥åˆ©ç”¨ä»¥ä¸‹åŠŸèƒ½ï¼šNVLINKï¼ŒRDMAï¼ŒGPUDirectRDMAï¼Œè‡ªåŠ¨æ£€æµ‹é€šä¿¡æ‹“æ‰‘ï¼Œèƒ½å¤Ÿå›é€€åˆ° PCIe å’Œ TCP/IP é€šä¿¡ã€‚\næˆ‘ä»¬éœ€è¦å‡ ä¸ªé—®é¢˜æ¥å¼•å¯¼åˆ†æï¼š\nHovorod æ€ä¹ˆè¿›è¡Œæ•°æ®åˆ†å‰²ï¼Ÿ Hovorod æ€ä¹ˆè¿›è¡Œè®­ç»ƒä»£ç åˆ†å‘ï¼Ÿ Hovorod å¯åŠ¨æ—¶å€™ï¼Œpython å’Œ C++ éƒ½åšäº†ä»€ä¹ˆï¼Ÿ å¦‚ä½•ç¡®ä¿ Hovorod å¯åŠ¨æ—¶å€™æ­¥éª¤ä¸€è‡´ï¼› 2 Hovorod æœºåˆ¶æ¦‚è¿° 2.1 Horovod æœºåˆ¶ Horovodä½¿ç”¨æ•°æ®å¹¶è¡ŒåŒ–ç­–ç•¥åœ¨GPUä¸Šåˆ†é…è®­ç»ƒã€‚\nåœ¨æ•°æ®å¹¶è¡ŒåŒ–ä¸­ï¼Œä½œä¸šä¸­çš„æ¯ä¸ªGPUéƒ½ä¼šæ¥æ”¶å…¶è‡ªå·±çš„æ•°æ®æ‰¹å¤„ç†çš„ç‹¬ç«‹åˆ‡ç‰‡ï¼Œå³å®ƒçš„â€œæ‰¹å¤„ç†åˆ‡ç‰‡â€ã€‚ æ¯ä¸ªGPUéƒ½ä½¿ç”¨è‡ªå·±åˆ†é…åˆ°çš„æ•°æ®æ¥ç‹¬ç«‹è®¡ç®—ï¼Œè¿›è¡Œæ¢¯åº¦æ›´æ–°ã€‚\nå‡å¦‚ä½¿ç”¨ä¸¤ä¸ªGPUï¼Œæ‰¹å¤„ç†å¤§å°ä¸º32ï¼Œåˆ™ç¬¬ä¸€ä¸ªGPUå°†å¤„ç†å‰16æ¡è®°å½•çš„æ­£å‘ä¼ æ’­å’Œå‘åä¼ æ’­ï¼Œä»¥åŠç¬¬äºŒä¸ªGPUå¤„ç†å16æ¡è®°å½•çš„æ­£å‘ä¼ æ’­å’Œå‘åä¼ æ’­ã€‚ç„¶åï¼Œè¿™äº›æ¢¯åº¦æ›´æ–°å°†åœ¨GPUä¹‹é—´å¹³å‡åœ¨ä¸€èµ·ï¼Œæœ€ååº”ç”¨äºæ¨¡å‹ã€‚\næ¯ä¸€ä¸ªè¿­ä»£çš„æ“ä½œæ–¹æ³•å¦‚ä¸‹ï¼š\næ¯ä¸ª worker å°†ç»´æŠ¤è‡ªå·±çš„æ¨¡å‹æƒé‡å‰¯æœ¬å’Œè‡ªå·±çš„æ•°æ®é›†å‰¯æœ¬ã€‚\næ”¶åˆ°æ‰§è¡Œä¿¡å·åï¼Œæ¯ä¸ªå·¥ä½œè¿›ç¨‹éƒ½ä¼šä»æ•°æ®é›†ä¸­æå–ä¸€ä¸ªä¸ç›¸äº¤çš„æ‰¹æ¬¡ï¼Œå¹¶è®¡ç®—è¯¥æ‰¹æ¬¡çš„æ¢¯åº¦ã€‚\nWorkers ä½¿ç”¨ring all-reduceç®—æ³•æ¥åŒæ­¥å½¼æ­¤çš„æ¢¯åº¦ï¼Œä»è€Œåœ¨æœ¬åœ°æ‰€æœ‰èŠ‚ç‚¹ä¸Šè®¡ç®—åŒæ ·çš„å¹³å‡æ¢¯åº¦ã€‚\nå°†æ¯ä¸ªè®¾å¤‡ä¸Šçš„æ¢¯åº¦ tensor åˆ‡åˆ†æˆé•¿åº¦å¤§è‡´ç›¸ç­‰çš„ num_devices ä¸ªåˆ†ç‰‡ï¼Œåç»­æ¯ä¸€æ¬¡é€šä¿¡éƒ½å°†ç»™ä¸‹ä¸€ä¸ªé‚»å±…å‘é€ä¸€ä¸ªè‡ªå·±çš„åˆ†ç‰‡ï¼ˆåŒæ—¶ä»ä¸Šä¸€ä¸ªé‚»å±…æ¥å—ä¸€ä¸ªæ–°åˆ†ç‰‡ï¼‰ã€‚\nScatterReduce é˜¶æ®µï¼šé€šè¿‡ num_devices - 1 è½®é€šä¿¡å’Œç›¸åŠ ï¼Œåœ¨æ¯ä¸ª device ä¸Šéƒ½è®¡ç®—å‡ºä¸€ä¸ª tensor åˆ†ç‰‡çš„å’Œï¼Œå³æ¯ä¸ª device å°†æœ‰ä¸€ä¸ªå—ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰device ä¸­è¯¥å—ä¸­æ‰€æœ‰å€¼çš„æ€»å’Œï¼›å…·ä½“å¦‚ä¸‹ï¼š\nAllGather é˜¶æ®µï¼šé€šè¿‡ num_devices - 1 è½®é€šä¿¡å’Œè¦†ç›–ï¼Œå°†ä¸Šä¸ªé˜¶æ®µè®¡ç®—å‡ºçš„æ¯ä¸ª tensor åˆ†ç‰‡çš„å’Œ å¹¿æ’­åˆ°å…¶ä»– deviceï¼›æœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½æ‹¥æœ‰æ‰€æœ‰tensoråˆ†ç‰‡å’Œã€‚å…·ä½“å¦‚ä¸‹ï¼š åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šåˆå¹¶åˆ†ç‰‡ï¼Œå¾—åˆ°æ¢¯åº¦å’Œï¼Œç„¶åé™¤ä»¥ num_devicesï¼Œå¾—åˆ°å¹³å‡æ¢¯åº¦ï¼› æ¯ä¸ª worker å°† æ¢¯åº¦æ›´æ–° åº”ç”¨äºå…¶æ¨¡å‹çš„æœ¬åœ°å‰¯æœ¬ã€‚\næ‰§è¡Œä¸‹ä¸€ä¸ªbatchã€‚\n3 ç¤ºä¾‹ä»£ç  3.1 æ‘˜è¦ä»£ç  æˆ‘ä»¬æ­¤å¤„ç»™å‡ºå®˜ç½‘ç¤ºä¾‹ä»£ç éƒ¨åˆ†æ‘˜è¦ï¼Œå…·ä½“åˆ†æå‚è§ä¸‹é¢ä»£ç ä¸­çš„æ³¨é‡Šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 import tensorflow as tf import horovod.tensorflow.keras as hvd # Horovod: initialize Horovod. hvd.init() # åˆå§‹åŒ– Horovodï¼Œå¯åŠ¨ç›¸å…³çº¿ç¨‹å’ŒMPIçº¿ç¨‹ # Horovod: pin GPU to be used to process local rank (one GPU per process) # ä¾æ® local rank ä¸ºä¸åŒçš„è¿›ç¨‹åˆ†é…ä¸åŒçš„GPU gpus = tf.config.experimental.list_physical_devices('GPU') for gpu in gpus: tf.config.experimental.set_memory_growth(gpu, True) if gpus: tf.config.experimental.set_visible_devices(gpus[hvd.local_rank()], 'GPU') (mnist_images, mnist_labels), _ = \\ tf.keras.datasets.mnist.load_data(path='mnist-%d.npz' % hvd.rank()) # åˆ‡åˆ†æ•°æ® dataset = tf.data.Dataset.from_tensor_slices( (tf.cast(mnist_images[..., tf.newaxis] / 255.0, tf.float32), tf.cast(mnist_labels, tf.int64)) ) dataset = dataset.repeat().shuffle(10000).batch(128) mnist_model = tf.keras.Sequential([ tf.keras.layers.Conv2D(32, [3, 3], activation='relu'), ...... tf.keras.layers.Dense(10, activation='softmax') ]) # Horovod: adjust learning rate based on number of GPUs. scaled_lr = 0.001 * hvd.size() # æ ¹æ®Workerçš„æ•°é‡å¢åŠ å­¦ä¹ ç‡çš„å¤§å° opt = tf.optimizers.Adam(scaled_lr) # Horovod: add Horovod DistributedOptimizer. # æŠŠå¸¸è§„TensorFlow Optimizeré€šè¿‡HorovodåŒ…è£…èµ·æ¥ï¼Œè¿›è€Œä½¿ç”¨ ring-allreduce æ¥å¾—åˆ°å¹³å‡æ¢¯åº¦ opt = hvd.DistributedOptimizer( opt, backward_passes_per_step=1, average_aggregated_gradients=True) # Horovod: Specify `experimental_run_tf_function=False` to ensure TensorFlow # uses hvd.DistributedOptimizer() to compute gradients. mnist_model.compile(loss=tf.losses.SparseCategoricalCrossentropy(), optimizer=opt, metrics=['accuracy'], experimental_run_tf_function=False) callbacks = [ hvd.callbacks.BroadcastGlobalVariablesCallback(0), # å¹¿æ’­åˆå§‹åŒ–ï¼Œå°†æ¨¡å‹çš„å‚æ•°ä»ç¬¬ä¸€ä¸ªè®¾å¤‡ä¼ å‘å…¶ä»–è®¾å¤‡ï¼Œä»¥ä¿è¯åˆå§‹åŒ–æ¨¡å‹å‚æ•°çš„ä¸€è‡´æ€§ hvd.callbacks.MetricAverageCallback(), hvd.callbacks.LearningRateWarmupCallback(initial_lr=scaled_lr, warmup_epochs=3, verbose=1), ] # Horovod: save checkpoints only on worker 0 to prevent other workers from corrupting them. # åªæœ‰è®¾å¤‡0éœ€è¦ä¿å­˜æ¨¡å‹å‚æ•°ä½œä¸ºcheckpoint if hvd.rank() == 0: callbacks.append(tf.keras.callbacks.ModelCheckpoint('./checkpoint-{epoch}.h5')) # Horovod: write logs on worker 0. verbose = 1 if hvd.rank() == 0 else 0 # Train the model. # Horovod: adjust number of steps based on number of GPUs. mnist_model.fit(dataset, steps_per_epoch=500 // hvd.size(), callbacks=callbacks, epochs=24, verbose=verbose) 3.2 horovodrun Horovodè®­ç»ƒè„šæœ¬æœªä½œä¸ºPythonè„šæœ¬å¯åŠ¨ã€‚ ä¾‹å¦‚ï¼Œæ‚¨ä¸èƒ½ä½¿ç”¨python train.pyè¿è¡Œæ­¤è„šæœ¬ã€‚ éœ€è¦é‡‡ç”¨ç‰¹æ®Šçš„CLIå‘½ä»¤ horovodrun æ¥å¯åŠ¨ï¼ˆè®­ç»ƒä»£ç  train.py éœ€è¦æ‰‹åŠ¨æ‹·è´åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä¸”ç›®å½•ç›¸åŒï¼‰ï¼š\n1 $ horovodrun -np 4 -H localhost:4 python train.py 4 è¿è¡Œé€»è¾‘ æˆ‘ä»¬æŒ‰ç…§é¡ºåºæ¢³ç†ï¼Œçœ‹çœ‹åœ¨ç¨‹åºåˆå§‹åŒ–è¿‡ç¨‹èƒŒåéƒ½åšäº†ä»€ä¹ˆã€‚\n4.1 å¼•å…¥pythonæ–‡ä»¶ å¦‚ä¸‹ä»£ç ä¼šå¼•å…¥å„ç§ç›¸å…³pythonæ–‡ä»¶ã€‚\n1 2 import tensorflow as tf import horovod.tensorflow.keras as hvd 4.2 åˆå§‹åŒ– in python python ä¸–ç•Œçš„åˆå§‹åŒ–ä½äº horovod-master/horovod/mxnet/mpi_ops.py\n4.2.1 å¼•å…¥SOåº“ 4.2.1.1 SOåº“ horovod/tensorflow/mpi_ops.py ä¹‹ä¸­ä¼šå¼•å…¥SOåº“ã€‚ æ¯”å¦‚ dist-packages/horovod/tensorflow/mpi_lib.cpython-36m-x86_64-linux-gnu.soã€‚\nSOåº“ å°±æ˜¯ horovod ä¸­ C++ ä»£ç ç¼–è¯‘å‡ºæ¥çš„ç»“æœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 def _load_library(name): \"\"\"Loads a .so file containing the specified operators. \"\"\" filename = resource_loader.get_path_to_datafile(name) library = load_library.load_op_library(filename) return library # Check possible symbol not found error from tensorflow version mismatch try: MPI_LIB = _load_library('mpi_lib' + get_ext_suffix()) except Exception as e: check_installed_version('tensorflow', tf.__version__, e) raise e else: check_installed_version('tensorflow', tf.__version__) 4.2.2.2 SOä½œç”¨ å¼•å…¥åº“çš„ä½œç”¨æ˜¯è·å–åˆ° C++ çš„å‡½æ•°ï¼Œå¹¶ä¸”ç”¨ python å°è£…ä¸€ä¸‹ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ python ä¸–ç•Œä½¿ç”¨ C++ä»£ç äº†ã€‚\nç”±ä¸‹æ–‡å¯ä»¥çœ‹å‡ºæ¥ï¼Œpython çš„ _allreduce å‡½æ•°å°±ä¼šæŠŠåŠŸèƒ½è½¬å‘ç»™ C++ï¼Œç”± MPI_LIB.horovod_allreduce å®Œæˆã€‚\n1 2 3 4 5 6 7 8 def _allreduce(tensor, name=None, op=Sum, prescale_factor=1.0, postscale_factor=1.0, ignore_name_scope=False): if name is None and not _executing_eagerly(): name = 'HorovodAllreduce_%s' % _normalize_name(tensor.name) return MPI_LIB.horovod_allreduce(tensor, name=name, reduce_op=op, prescale_factor=prescale_factor, postscale_factor=postscale_factor, ignore_name_scope=ignore_name_scope) 4.2.2 åˆå§‹åŒ–é…ç½® æˆ‘ä»¬æ‘˜å½•äº†ä¸»è¦éƒ¨åˆ†ï¼Œå°±æ˜¯åˆå§‹åŒ– _HorovodBasicsï¼Œç„¶åä» _HorovodBasics å†…è·å–å„ç§å‡½æ•°ï¼Œå˜é‡å’Œé…ç½®ï¼Œæ¯”å¦‚æ˜¯å¦ç¼–è¯‘äº†mpiï¼Œglooç­‰ç­‰.\n1 2 3 4 5 6 7 8 9 10 11 12 13 from horovod.common.basics import HorovodBasics as _HorovodBasics _basics = _HorovodBasics(__file__, 'mpi_lib') # import basic methods init = _basics.init size = _basics.size local_size = _basics.local_size rank = _basics.rank local_rank = _basics.local_rank mpi_built = _basics.mpi_built gloo_enabled = _basics.gloo_enabled ...... 4.2.3 hvd.init() åˆå§‹åŒ– é¦–å…ˆéœ€è¦ç”¨ hvd.init() æ¥åˆå§‹åŒ–ï¼Œhorovod ç®¡ç†çš„æ‰€æœ‰çŠ¶æ€éƒ½ä¼šä¼ åˆ° hvd å¯¹è±¡ä¸­ã€‚\n1 2 # Horovod: initialize Horovod. hvd.init() æ­¤å¤„è°ƒç”¨çš„æ˜¯ HorovodBasics ä¸­çš„å‡½æ•°ï¼Œæˆ‘ä»¬çœ‹çœ‹åšäº†ä»€ä¹ˆã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œè¿™éƒ¨åˆ†ä¼šä¸€ç›´æ·±å…¥åˆ° C++ä¸–ç•Œï¼Œè°ƒç”¨äº†å¤§é‡çš„ MPI_LIB_CTYPES å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦è¿›å…¥åˆ° C++çš„ä¸–ç•Œçœ‹çœ‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 def init(self, comm=None): \"\"\"A function that initializes Horovod. \"\"\" atexit.register(self.shutdown) if not isinstance(comm, list): mpi_built = self.MPI_LIB_CTYPES.horovod_mpi_built() from mpi4py import MPI if MPI._sizeof(MPI.Comm) == ctypes.sizeof(ctypes.c_int): MPI_Comm = ctypes.c_int else: MPI_Comm = ctypes.c_void_p self.MPI_LIB_CTYPES.horovod_init_comm.argtypes = [MPI_Comm] comm_obj = MPI_Comm.from_address(MPI._addressof(comm)) self.MPI_LIB_CTYPES.horovod_init_comm(comm_obj) else: comm_size = len(comm) self.MPI_LIB_CTYPES.horovod_init( (ctypes.c_int * comm_size)(*comm), ctypes.c_int(comm_size)) ç›®å‰é€»è¾‘å¦‚ä¸‹å›¾ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 Import python files + | | v Import C++ SO files | | | v Create _HorovodBasics + | | v hvd.init() + Python | +------------------------------------------+ C++ | | v 4.3 åˆå§‹åŒ– in C++ 4.3.1 horovod_init_comm åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒHorovod ä¼šï¼š\nè°ƒç”¨ MPI_Comm_dup è·å–ä¸€ä¸ª Communicatorï¼Œè¿™æ ·å°±æœ‰äº†å’Œ MPI åè°ƒçš„åŸºç¡€ã€‚ ç„¶åè°ƒç”¨ InitializeHorovodOnceã€‚ 1 2 3 4 void horovod_init_comm(MPI_Comm comm) { MPI_Comm_dup(comm, \u0026mpi_context.mpi_comm); InitializeHorovodOnce(nullptr, 0); } 4.3.2 InitializeHorovodOnce InitializeHorovodOnce æ˜¯åˆå§‹åŒ–çš„ä¸»è¦å·¥ä½œï¼Œä¸»è¦æ˜¯ï¼š\nä¾æ®æ˜¯å¦ç¼–è¯‘äº† mpi æˆ–è€… glooï¼Œå¯¹å„è‡ªçš„ context è¿›è¡Œå¤„ç†ï¼Œä¸º globalstate åˆ›å»ºå¯¹åº”çš„ controllerï¼› å¯åŠ¨äº†åå°çº¿ç¨‹ BackgroundThreadLoop ç”¨æ¥åœ¨å„ä¸ªworkerä¹‹é—´åè°ƒï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 void horovod_init(const int* ranks, int nranks) { InitializeHorovodOnce(ranks, nranks); } void InitializeHorovodOnce(const int* ranks, int nranks) { // Ensure background thread is only started once. if (!horovod_global.initialize_flag.test_and_set()) { horovod_global.control_operation = ParseControllerOpsFromEnv(); horovod_global.cpu_operation = ParseCPUOpsFromEnv(); #if HAVE_MPI // ä¾æ®æ˜¯å¦ç¼–è¯‘äº†MPIè¿›è¡Œå¤„ç† // Enable mpi is it's used either in cpu data transfer or controller if (horovod_global.cpu_operation == LibType::MPI || horovod_global.control_operation == LibType::MPI) { mpi_context.Enable(); } if (horovod_global.control_operation == LibType::MPI){ // åˆ›å»ºä¸€ä¸ª MPIController å¯¹è±¡ horovod_global.controller.reset(new MPIController( horovod_global.response_cache, horovod_global.tensor_queue, horovod_global.timeline, horovod_global.parameter_manager, horovod_global.group_table, mpi_context)); horovod_global.controller-\u003eSetRanks(ranks, nranks); } #endif #if HAVE_GLOO // ä¾æ®æ˜¯å¦ç¼–è¯‘äº† GLOO è¿›è¡Œå¤„ç† // Enable gloo is it's used either in cpu data transfer or controller if (horovod_global.cpu_operation == LibType::GLOO || horovod_global.control_operation == LibType::GLOO) { gloo_context.Enable(); } if (horovod_global.control_operation == LibType::GLOO) { horovod_global.controller.reset(new GlooController( horovod_global.response_cache, horovod_global.tensor_queue, horovod_global.timeline, horovod_global.parameter_manager, horovod_global.group_table, gloo_context)); } #endif // Reset initialization flag // å¯åŠ¨åå°çº¿ç¨‹ horovod_global.initialization_done = false; horovod_global.background_thread = std::thread( BackgroundThreadLoop, std::ref(horovod_global)); } // Wait to ensure that the background thread has finished initializing MPI. while (!horovod_global.initialization_done) { std::this_thread::sleep_for(std::chrono::milliseconds(1)); } } 4.3.3 HorovodGlobalState åœ¨ C++ ä¸–ç•Œï¼ŒHorovodGlobalState èµ·åˆ°äº†é›†ä¸­ç®¡ç†å„ç§å…¨å±€å˜é‡çš„ä½œç”¨ã€‚\nHorovodGlobalState åœ¨ horovod ä¸­æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå…¶ä¸­çš„å…ƒç´ å¯ä»¥ä¾›ä¸åŒçš„çº¿ç¨‹è®¿é—®ã€‚HorovodGlobalState åœ¨åŠ è½½ C++ çš„ä»£ç æ—¶å€™å°±å·²ç»åˆ›å»ºäº†ï¼ŒåŒæ—¶åˆ›å»ºçš„è¿˜æœ‰å„ç§ contextï¼ˆmpi_context, nccl_context, gpu_contextï¼‰ã€‚\nHorovod ä¸»è¦ä¼šåœ¨backgroundThreadLoop ä¸­å®Œæˆ HorovodGlobalState ä¸åŒå…ƒç´ åˆå§‹åŒ–ï¼Œæ¯”è¾ƒé‡è¦çš„æœ‰ï¼š\ncontroller ç®¡ç†æ€»ä½“é€šä¿¡æ§åˆ¶æµï¼› tensor_queue ä¼šå¤„ç†ä»å‰ç«¯è¿‡æ¥çš„é€šä¿¡éœ€æ±‚ï¼ˆallreduceï¼Œbroadcast ç­‰)ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // All the Horovod state that must be stored globally per-process. HorovodGlobalState horovod_global; #if HAVE_MPI MPIContext mpi_context; #endif #if HAVE_GLOO GlooContext gloo_context; #endif .... std::unique_ptr\u003cOperationManager\u003e op_manager; HorovodGlobalState æ‘˜è¦å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 struct HorovodGlobalState { // Background thread running MPI communication. std::thread background_thread; // åå°çº¿ç¨‹ï¼Œç”¨æ¥åœ¨å„ä¸ªworkerä¹‹é—´åè°ƒ ParameterManager parameter_manager; // ç»´æŠ¤åå°æ€»ä½“å‚æ•°é…ç½® // Encapsulates the fusion buffers, handles resizing and auto-tuning of buffer // size. FusionBufferManager fusion_buffer; // èåˆtensorï¼Œä»¥ä¾¿ç¼©å‡é€šä¿¡å¼€é”€ std::shared_ptr\u003cController\u003e controller; //ç®¡ç†æ€»ä½“é€šä¿¡æ§åˆ¶æµ TensorQueue tensor_queue; //å¤„ç†ä»å‰ç«¯è¿‡æ¥çš„é€šä¿¡éœ€æ±‚ï¼ˆallreduceï¼Œbroadcast ç­‰ï¼‰ // Pointer to shared buffer for allgather void* shared_buffer = nullptr; // LRU cache of Responses ResponseCache response_cache; // Information on registered groups. GroupTable group_table; ~HorovodGlobalState() { // Make sure that the destructor of the background thread is safe to // call. If a thread is still joinable (not detached or complete) its // destructor cannot be called. if (background_thread.joinable()) { shut_down = true; background_thread.join(); } } }; ç›®å‰å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 Import python files + | | v Import C++ SO files | | | v Create _HorovodBasics + | | v hvd.init() + Python | +-------------------------------------------------------------------------------------------------------------+ | c++ | v +-----------------------------+ | HorovodGlobalState | horovod_init_comm | | + +------------------+ | | | | horovod_global +---------\u003e | TensorQueue | | | | | | v | | | background_thread | | mpi_context | | | InitializeHorovodOnce +------------\u003e | | | ParameterManager | + | | | | | | gloo_context | | FusionBufferManager | | | | | | | | | | Controller | v | op_manager | | | background_threa | | | ResponseCache | +------------------+ | | | shared_buffer | +-----------------------------+ å¦‚å›¾ï¼š\nè‡³æ­¤ï¼Œhorovod å·²ç»åˆå§‹åŒ–å®Œæˆï¼Œç”¨æˆ·ä»£ç å¯ä»¥ä½¿ç”¨äº†ã€‚\n4.3 hvd æ¦‚å¿µ åœ¨ç”¨æˆ·ä»£ç ä¸­ï¼Œæ¥ä¸‹æ¥æ˜¯rankæ¦‚å¿µã€‚\n1 2 3 hvd.local_rank() hvd.rank() æˆ‘ä»¬ä»‹ç»ä¸‹å‡ ä¸ªç›¸å…³æ¦‚å¿µï¼š\nHorovodä¸ºè®¾å¤‡ä¸Šçš„æ¯ä¸ªGPUå¯åŠ¨äº†è¯¥è®­ç»ƒè„šæœ¬çš„ä¸€ä¸ªå‰¯æœ¬ã€‚local rankå°±æ˜¯åˆ†é…ç»™æŸä¸€å°è®¡ç®—æœºä¸Šæ¯ä¸ªæ‰§è¡Œè®­ç»ƒçš„å”¯ä¸€ç¼–å·ï¼ˆä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯è¿›ç¨‹å·æˆ–è€…GPUè®¾å¤‡çš„IDå·ï¼‰ï¼ŒèŒƒå›´æ˜¯ 0 åˆ° n-1ï¼Œå…¶ä¸­ n æ˜¯è¯¥è®¡ç®—æœºä¸ŠGPUè®¾å¤‡çš„æ•°é‡ã€‚ rank å¯ä»¥è®¤ä¸ºæ˜¯ä»£è¡¨åˆ†å¸ƒå¼ä»»åŠ¡é‡Œçš„ä¸€ä¸ªæ‰§è¡Œè®­ç»ƒçš„å”¯ä¸€å…¨å±€ç¼–å·ï¼ˆç”¨äºè¿›ç¨‹é—´é€šè®¯ï¼‰ã€‚Rank 0 åœ¨Horovodä¸­é€šå¸¸å…·æœ‰ç‰¹æ®Šçš„æ„ä¹‰ï¼šå®ƒæ˜¯è´Ÿè´£æ­¤åŒæ­¥çš„è®¾å¤‡ã€‚ åœ¨ç™¾åº¦çš„å®ç°ä¸­ï¼Œä¸åŒ Rank çš„è§’è‰²æ˜¯ä¸ä¸€æ ·çš„ï¼ŒRank 0 ä¼šå……å½“ coordinator çš„è§’è‰²ã€‚å®ƒä¼šåè°ƒæ¥è‡ªå…¶ä»– Rank çš„ MPI è¯·æ±‚ï¼Œæ˜¯ä¸€ä¸ªå·¥ç¨‹ä¸Šçš„è€ƒé‡ã€‚è¿™ä¸€è®¾è®¡ä¹Ÿè¢«åæ¥çš„ Horovod é‡‡ç”¨ã€‚ Rank 0 ä¹Ÿç”¨æ¥æŠŠå‚æ•°å¹¿æ’­åˆ°å…¶ä»–è¿›ç¨‹ \u0026 å­˜å‚¨ checkpointã€‚ world_sizeï¼šè¿›ç¨‹æ€»æ•°é‡ï¼Œä¼šç­‰åˆ°æ‰€æœ‰world_sizeä¸ªè¿›ç¨‹å°±ç»ªä¹‹åæ‰ä¼šå¼€å§‹è®­ç»ƒã€‚ hvd.init è¿™éƒ¨åˆ†çš„ç›®çš„å°±æ˜¯è®©å¹¶è¡Œè¿›ç¨‹ä»¬å¯ä»¥çŸ¥é“è‡ªå·±è¢«åˆ†é…çš„ rank / local rank ç­‰ä¿¡æ¯ï¼Œäºæ˜¯åç»­å¯ä»¥æ ¹æ® local rankï¼ˆæ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„ç¬¬å‡ å¼  GPU å¡ï¼‰ æ¥è®¾ç½®æ‰€éœ€çš„æ˜¾å­˜åˆ†é…ã€‚\n4.5 æ•°æ®å¤„ç† æ¥ä¸‹æ¥æ˜¯æ•°æ®å¤„ç†ã€‚\n1 2 3 4 5 dataset = tf.data.Dataset.from_tensor_slices( (tf.cast(mnist_images[..., tf.newaxis] / 255.0, tf.float32), tf.cast(mnist_labels, tf.int64)) ) dataset = dataset.repeat().shuffle(10000).batch(128) è¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦è¯´æ˜ï¼š\né¦–å…ˆï¼Œè®­ç»ƒçš„æ•°æ®éœ€è¦æ”¾ç½®åœ¨ä»»ä½•èŠ‚ç‚¹éƒ½èƒ½è®¿é—®çš„åœ°æ–¹ã€‚\nå…¶æ¬¡ï¼ŒHorovod éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œéœ€è¦åœ¨ä¸åŒæœºå™¨ä¸ŠæŒ‰Rankè¿›è¡Œåˆ‡åˆ†ï¼Œä»¥ä¿è¯æ¯ä¸ªGPUè¿›ç¨‹è®­ç»ƒçš„æ•°æ®é›†æ˜¯ä¸ä¸€æ ·çš„ã€‚\næ•°æ®é›†æœ¬ä½“éœ€è¦å‡ºäºæ•°æ®å¹¶è¡Œæ€§çš„éœ€æ±‚è€Œè¢«æ‹†åˆ†ä¸ºå¤šä¸ªåˆ†ç‰‡ï¼ŒHorovodçš„ä¸åŒå·¥ä½œèŠ‚ç‚¹éƒ½å°†åˆ†åˆ«è¯»å–è‡ªå·±çš„æ•°æ®é›†åˆ†ç‰‡ã€‚\nä» PyTorch ç¤ºä¾‹è„šæœ¬çœ‹å¾—æ›´åŠ æ¸…æ¥šã€‚\n1 2 3 4 5 # Horovod: use DistributedSampler to partition the training data. train_sampler = torch.utils.data.distributed.DistributedSampler( train_dataset, num_replicas=hvd.size(), rank=hvd.rank()) train_loader = torch.utils.data.DataLoader( train_dataset, batch_size=args.batch_size, sampler=train_sampler, **kwargs) DataLoaderçš„é‡‡æ ·å™¨ç»„ä»¶ä»è¦ç»˜åˆ¶çš„æ•°æ®é›†ä¸­è¿”å›å¯è¿­ä»£çš„ç´¢å¼•ã€‚ PyTorchä¸­çš„é»˜è®¤é‡‡æ ·å™¨æ˜¯é¡ºåºçš„ï¼Œè¿”å›åºåˆ—0, 1, 2, â€¦, n ã€‚ Horovodä½¿ç”¨å…¶DistributedSamplerè¦†ç›–äº†æ­¤è¡Œä¸ºï¼Œè¯¥DistributedSamplerå¤„ç†è·¨è®¡ç®—æœºçš„æ•°æ®é›†åˆ†åŒºã€‚ DistributedSampleræœ¬èº«æ¥å—ä¸¤ä¸ªå‚æ•°ä½œä¸ºè¾“å…¥ï¼š hvd.size() (GPUçš„æ€»æ•°ï¼Œä¾‹å¦‚16)å’Œhvd.rank() (ä»æ€»ä½“åˆ—è¡¨ä¸­åˆ†é…ç»™è¯¥è®¾å¤‡çš„IDï¼Œä¾‹å¦‚0â€¦15)ã€‚\nPytorchä½¿ç”¨çš„æ˜¯æ•°æ®åˆ†å¸ƒå¼è®­ç»ƒï¼Œæ¯ä¸ªè¿›ç¨‹å®é™…ä¸Šæ˜¯ç‹¬ç«‹åŠ è½½æ•°æ®çš„ï¼Œæ‰€ä»¥éœ€è¦åŠ è½½ç›¸åŒæ•°æ®é›†åç”¨ä¸€å®šçš„è§„åˆ™æ ¹æ®rankæ¥é¡ºåºåˆ‡å‰²è·å–ä¸åŒçš„æ•°æ®å­é›†ï¼ŒDistributedSamplerå°±æ˜¯ç”¨æ¥ç¡®ä¿dataloaderåªä¼šloadåˆ°æ•´ä¸ªæ•°æ®é›†çš„ä¸€ä¸ªç‰¹å®šå­é›†çš„åšæ³•(å®é™…ä¸Šä¸ç”¨Pytorchæä¾›çš„DistributedSamplerå·¥å…·ï¼Œè‡ªå·±åšåŠ è½½æ•°æ®ååˆ‡åˆ†word_sizeä¸ªå­é›†æŒ‰ranké¡ºåºæ‹¿åˆ°å­é›†æ•ˆæœä¹Ÿæ˜¯ä¸€æ ·)ã€‚\nåŒæ—¶ä¸ºäº†èƒ½å¤ŸæŒ‰é¡ºåºåˆ’åˆ†æ•°æ®å­é›†ï¼Œæ‹¿åˆ°ä¸åŒéƒ¨åˆ†æ•°æ®ï¼Œæ‰€ä»¥æ•°æ®é›†ä¸èƒ½å¤Ÿè¿›è¡Œéšæœºæ‰“æ•£ï¼Œæ‰€ä»¥ç”¨äº†å‚æ•° 'shuffle': Falseã€‚\n4.6 å¹¿æ’­åˆå§‹åŒ–å˜é‡ ä»¥ä¸‹ä»£ç å®Œæˆå¹¿æ’­åˆå§‹åŒ–çš„åŠŸèƒ½ã€‚\n1 hvd.callbacks.BroadcastGlobalVariablesCallback(0) è¿™å¥ä»£ç ä¿è¯çš„æ˜¯ rank 0 ä¸Šçš„æ‰€æœ‰å‚æ•°åªåœ¨ rank 0 åˆå§‹åŒ–ï¼Œç„¶åå¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå³å˜é‡ä»ç¬¬ä¸€ä¸ªæµç¨‹å‘å…¶ä»–æµç¨‹ä¼ æ’­ï¼Œä»¥å®ç°å‚æ•°ä¸€è‡´æ€§åˆå§‹åŒ–ã€‚\nä¸‹é¢å°±ä»‹ç»ä¸‹ Horvod ä¹‹ä¸­å¹¿æ’­çš„ä½¿ç”¨ã€‚\n4.6.1 å¹¿æ’­å®šä¹‰ å¹¿æ’­çš„å…·ä½“å®ç°æ˜¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 class BroadcastGlobalVariablesCallbackImpl(object): def __init__(self, backend, root_rank, device='', *args): super(BroadcastGlobalVariablesCallbackImpl, self).__init__(*args) self.backend = backend self.root_rank = root_rank self.device = device self.broadcast_done = False def on_batch_end(self, batch, logs=None): if self.broadcast_done: return with tf.device(self.device): if hvd._executing_eagerly() and hasattr(self.model, 'variables'): # TensorFlow 2.0 or TensorFlow eager hvd.broadcast_variables(self.model.variables, root_rank=self.root_rank) hvd.broadcast_variables(self.model.optimizer.variables(), root_rank=self.root_rank) else: bcast_op = hvd.broadcast_global_variables(self.root_rank) self.backend.get_session().run(bcast_op) self.broadcast_done = True 4.6.2 broadcast_variables broadcast_variables è°ƒç”¨äº† _make_broadcast_group_fn å®ŒæˆåŠŸèƒ½ï¼Œå¯ä»¥çœ‹åˆ°å¯¹äº æ‰§è¡Œå›¾ çš„æ¯ä¸ªå˜é‡ï¼Œè°ƒç”¨äº† broadcastã€‚\n1 2 3 4 5 6 7 8 9 10 def broadcast_variables(variables, root_rank): \"\"\"Broadcasts variables from root rank to all other processes. Arguments: variables: variables for broadcast root_rank: rank of the process from which global variables will be broadcasted to all other processes. \"\"\" broadcast_group = _make_broadcast_group_fn() return broadcast_group(variables, root_rank) ä»¥åŠ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @_cache def _make_broadcast_group_fn(): if _executing_eagerly(): # Eager mode will parallelize independent control flow def broadcast_group(variables, root_rank): for var in variables: var.assign(broadcast(var, root_rank)) return _make_subgraph(broadcast_group) else: # Graph mode requires an Op def broadcast_group(variables, root_rank): return tf.group(*[var.assign(broadcast(var, root_rank)) for var in variables]) return broadcast_group 4.6.3 è°ƒç”¨ MPI broadcast å°±æ˜¯è°ƒç”¨äº† MPI å‡½æ•°çœŸæ­£å®Œæˆäº†åŠŸèƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 def broadcast(tensor, root_rank, name=None, ignore_name_scope=False): \"\"\"An op which broadcasts the input tensor on root rank to the same input tensor on all other Horovod processes. The broadcast operation is keyed by the name of the op. The tensor type and shape must be the same on all Horovod processes for a given name. The broadcast will not start until all processes are ready to send and receive the tensor. Returns: A tensor of the same shape and type as `tensor`, with the value broadcasted from root rank. \"\"\" if name is None and not _executing_eagerly(): name = 'HorovodBroadcast_%s' % _normalize_name(tensor.name) return MPI_LIB.horovod_broadcast(tensor, name=name, root_rank=root_rank, ignore_name_scope=ignore_name_scope) 4.6.4 åŒæ­¥å‚æ•° åœ¨åå°è¿›ç¨‹ä¸­ï¼Œä¼šæ ¹æ®æƒ…å†µå®šæœŸåŒæ­¥å‚æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 bool RunLoopOnce(HorovodGlobalState\u0026 state) { // ä¸šåŠ¡é€»è¾‘åŠŸèƒ½ if (state.parameter_manager.IsAutoTuning()) { bool should_sync = state.parameter_manager.Update(tensor_names, total_tensor_size); // çœ‹çœ‹æ˜¯å¦éœ€è¦åŒæ­¥ï¼Œå¦‚æœéœ€è¦ï¼Œå°±åŒæ­¥ã€‚ if (should_sync) { state.controller-\u003eSynchronizeParameters(); } } ...... } åŒæ­¥å‚æ•°ä»£ç ä¹Ÿæ˜¯è°ƒç”¨äº† Bcast åŠŸèƒ½å®Œæˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 void Controller::SynchronizeParameters() { ParameterManager::Params param; if (is_coordinator_) { // rank 0 æ‰§è¡Œæ“ä½œ param = parameter_manager_.GetParams(); } void* buffer = (void*)(\u0026param); size_t param_size = sizeof(param); Bcast(buffer, param_size, 0, Communicator::GLOBAL); if (!is_coordinator_) { // worker æ‰§è¡Œæ“ä½œ parameter_manager_.SetParams(param); } } 4.7 DistributedOptimizer æœ€åéœ€è¦é…ç½®DistributedOptimizerï¼Œè¿™å°±æ˜¯å…³é”®ç‚¹ä¹‹ä¸€ã€‚\n1 2 3 # Horovod: add Horovod DistributedOptimizer. opt = hvd.DistributedOptimizer( opt, backward_passes_per_step=1, average_aggregated_gradients=True) TF Optimizer æ˜¯æ¨¡å‹è®­ç»ƒçš„å…³é”®APIï¼Œå¯ä»¥è·å–åˆ°æ¯ä¸ªOPçš„æ¢¯åº¦å¹¶ç”¨æ¥æ›´æ–°æƒé‡ã€‚HVD åœ¨åŸå§‹ TF Optimizerçš„åŸºç¡€ä¸ŠåŒ…è£…äº†hvd.DistributedOptimizerã€‚\nDistributedOptimizeråŒ…è£…å™¨å°†åŸå§‹ä¼˜åŒ–å™¨ä½œä¸ºè¾“å…¥ï¼Œå°†æ¢¯åº¦è®¡ç®—å§”æ‰˜ç»™å®ƒã€‚ å³DistributedOptimizerä¼šè°ƒç”¨åŸå§‹ä¼˜åŒ–å™¨è¿›è¡Œæ¢¯åº¦è®¡ç®—ã€‚è¿™æ ·ï¼Œåœ¨é›†ç¾¤ä¸­æ¯å°æœºå™¨éƒ½ä¼šç”¨åŸå§‹ä¼˜åŒ–å™¨å¾—åˆ°è‡ªå·±çš„æ¢¯åº¦ï¼ˆLocal Gradientï¼‰ã€‚\nHorovod DistributedOptimizeræ¥ä¸‹æ¥ä¼šä½¿ç”¨all-reduceæˆ–all-gatheræ¥å®Œæˆå…¨å±€æ¢¯åº¦å½’å¹¶ï¼Œç„¶åå°†è¿™äº›å¹³å‡æ¢¯åº¦åº”ç”¨äºæ‰€æœ‰è®¾å¤‡ã€‚\næˆ‘ä»¬æ¢³ç†ä¸‹å…¶ä¸­çš„è°ƒç”¨å…³ç³»ï¼š\nhvd.DistributedOptimizerç»§æ‰¿ keras Optimizerï¼Œåœ¨è®¡ç®—æ—¶å€™ï¼Œä¾ç„¶ç”±ä¼ å…¥çš„åŸå§‹ä¼˜åŒ–å™¨åšè®¡ç®—ã€‚ åœ¨å¾—åˆ°è®¡ç®—çš„æ¢¯åº¦ä¹‹åï¼Œè°ƒç”¨ hvd.allreduce æˆ–è€… hvd.allgather æ¥è®¡ç®—ã€‚ æœ€åå®æ–½è¿™äº›å¹³å‡ä¹‹åçš„æ¢¯åº¦ã€‚ä»è€Œå®ç°æ•´ä¸ªé›†ç¾¤çš„æ¢¯åº¦å½’å¹¶æ“ä½œã€‚ å…·ä½“åæ–‡ä¼šè¯¦ç»†ä»‹ç»ã€‚\n4.8 æœªæ¥å¯èƒ½ Horovod ç›®å‰æ¶æ„çš„åŸºç¡€æ˜¯ï¼šæœºå™¨å­¦ä¹ çš„æ¨¡å‹å‚æ•°åœ¨ä¸€å¼  GPU ä¸Šå¯ä»¥å­˜ä¸‹ã€‚\næœªæ¥æ˜¯å¦å¯ä»¥æŠŠæ¨¡å‹åˆ†ç‰‡ç»“åˆè¿›æ¥ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„çœ‹ç‚¹ã€‚\nå¦å¤–ï¼Œå¦‚æœæ¨¡å‹çš„å…¨è¿æ¥å±‚è¾ƒå¤šï¼Œåˆ™å…¨è¿æ¥å±‚çš„å¼ºè€¦åˆæ€§ç»“åˆ allreduce ç±»ä¼¼ bsp çš„åŒæ­¥æœºåˆ¶ï¼Œè¿˜æ˜¯ä¼šè®©ç½‘ç»œé€šä¿¡æ—¶é—´æˆä¸ºç“¶é¢ˆã€‚å› æ­¤ï¼Œåœ¨ ring-allreduce ç¯å¢ƒä¸‹ï¼ŒåŒæ­¥åè®®çš„æ”¹é€ ï¼Œæ¯”å¦‚åˆ©ç”¨ SSP æ¥æ›¿æ¢ BSPï¼Œæˆ–è€…åˆ©ç”¨æ¢¯åº¦å‹ç¼©æ¥åŠ å¿« allreduce è¿›ç¨‹ä¹Ÿæ˜¯å€¼å¾—æ¢ç´¢çš„æ–¹å‘ã€‚\n5 æ€»ç»“ é’ˆå¯¹æ–‡åˆæå‡ºçš„å‡ ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç°åœ¨å›ç­”å¦‚ä¸‹ï¼š\nHovorod æ€ä¹ˆè¿›è¡Œæ•°æ®åˆ†å‰²ï¼Ÿ ç­”æ¡ˆï¼šæœ‰çš„æ¡†æ¶å¯ä»¥è‡ªåŠ¨åšæ•°æ®åˆ†å‰²ã€‚å¦‚æœæ¡†æ¶ä¸æä¾›ï¼Œåˆ™éœ€è¦ç”¨æˆ·è‡ªå·±è¿›è¡Œæ•°æ®åˆ†å‰²ï¼Œä»¥ä¿è¯æ¯ä¸ªGPUè¿›ç¨‹è®­ç»ƒçš„æ•°æ®é›†æ˜¯ä¸ä¸€æ ·çš„ã€‚ Hovorod æ€ä¹ˆè¿›è¡Œæ¨¡å‹åˆ†å‘ï¼Ÿ ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ‹·è´è®­ç»ƒä»£ç åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šã€‚ Hovorod å¯åŠ¨æ—¶å€™ï¼Œpython å’Œ C++ éƒ½åšäº†ä»€ä¹ˆï¼Ÿ ç­”æ¡ˆï¼špython ä¼šå¼•å…¥ C++åº“ï¼Œåˆå§‹åŒ–å„ç§å˜é‡å’Œé…ç½®ã€‚C++éƒ¨åˆ†ä¼šå¯¹ MPIï¼ŒGLOOä¸Šä¸‹æ–‡è¿›è¡Œåˆå§‹åŒ–ï¼Œå¯åŠ¨åå°è¿›ç¨‹å¤„ç†å†…éƒ¨é€šä¿¡ã€‚ å¦‚ä½•ç¡®ä¿ Hovorod å¯åŠ¨æ—¶å€™æ­¥éª¤ä¸€è‡´ï¼› ç­”æ¡ˆï¼š rank 0 ä¸Šçš„æ‰€æœ‰å‚æ•°åªåœ¨ rank 0 åˆå§‹åŒ–ï¼Œç„¶åå¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå³å˜é‡ä»ç¬¬ä¸€ä¸ªæµç¨‹å‘å…¶ä»–æµç¨‹ä¼ æ’­ï¼Œä»¥å®ç°å‚æ•°ä¸€è‡´æ€§åˆå§‹åŒ–ã€‚ ä¸‹ä¸€ç¯‡æ–‡ç« å°†æ·±å…¥åˆ°pythonä¸–ç•Œçœ‹çœ‹ã€‚\nreference: [1].https://www.cnblogs.com/rossiXYZ/p/14856543.html\n",
  "wordCount" : "6571",
  "inLanguage": "en",
  "datePublished": "2022-10-08T17:25:41+08:00",
  "dateModified": "2022-10-08T17:25:41+08:00",
  "author":[{
    "@type": "Person",
    "name": "Jian"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jianye0428.github.io/en/posts/notes/2022-10-08_horovod_2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jian's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jianye0428.github.io/favicon/jian_icon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jianye0428.github.io/en/" accesskey="h" title="Jian&#39;s Blog (Alt + H)">
                <img src="https://jianye0428.github.io/favicon/jian_icon.png" alt="logo" aria-label="logo"
                    height="30">Jian&#39;s Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://jianye0428.github.io/cn/" title="Chinese"
                            aria-label="Chinese">Chinese</a>
                    </li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jianye0428.github.io/en/myresume/" title="My Resume">
                    <span>My Resume</span>
                </a>
            </li>
            <li>
                <a href="https://jianye0428.github.io/en/tags/" title="ğŸ”–Tags">
                    <span>ğŸ”–Tags</span>
                </a>
            </li>
            <li>
                <a href="https://jianye0428.github.io/en/archives" title="ğŸ™‹ğŸ»â€â™‚ï¸Archive">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸Archive</span>
                </a>
            </li>
            <li>
                <a href="https://jianye0428.github.io/en/search/" title="ğŸ”Search (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://jianye0428.github.io/en/">Home</a>&nbsp;Â»&nbsp;<a href="https://jianye0428.github.io/en/posts/">Posts</a></div>
    <h1 class="post-title">
      æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥
    </h1>
    <div class="post-meta"><span title='2022-10-08 17:25:41 +0800 CST'>2022-10-08</span>&nbsp;Â·&nbsp;14 min&nbsp;Â·&nbsp;Jian&nbsp;|&nbsp;<a href="https://github.com/jianye0428/myblog/tree/main/content/posts/notes/2022-10-08_Horovod_2.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0-%e6%91%98%e8%a6%81" aria-label="0 æ‘˜è¦">0 æ‘˜è¦</a></li>
                    <li>
                        <a href="#1-horovod-%e7%ae%80%e4%bb%8b" aria-label="1 Horovod ç®€ä»‹">1 Horovod ç®€ä»‹</a></li>
                    <li>
                        <a href="#2-hovorod-%e6%9c%ba%e5%88%b6%e6%a6%82%e8%bf%b0" aria-label="2 Hovorod æœºåˆ¶æ¦‚è¿°">2 Hovorod æœºåˆ¶æ¦‚è¿°</a><ul>
                            
                    <li>
                        <a href="#21-horovod-%e6%9c%ba%e5%88%b6" aria-label="2.1 Horovod æœºåˆ¶">2.1 Horovod æœºåˆ¶</a></li></ul>
                    </li>
                    <li>
                        <a href="#3-%e7%a4%ba%e4%be%8b%e4%bb%a3%e7%a0%81" aria-label="3 ç¤ºä¾‹ä»£ç ">3 ç¤ºä¾‹ä»£ç </a><ul>
                            
                    <li>
                        <a href="#31--%e6%91%98%e8%a6%81%e4%bb%a3%e7%a0%81" aria-label="3.1  æ‘˜è¦ä»£ç ">3.1  æ‘˜è¦ä»£ç </a></li>
                    <li>
                        <a href="#32-horovodrun" aria-label="3.2 horovodrun">3.2 horovodrun</a></li></ul>
                    </li>
                    <li>
                        <a href="#4-%e8%bf%90%e8%a1%8c%e9%80%bb%e8%be%91" aria-label="4 è¿è¡Œé€»è¾‘">4 è¿è¡Œé€»è¾‘</a><ul>
                            
                    <li>
                        <a href="#41-%e5%bc%95%e5%85%a5python%e6%96%87%e4%bb%b6" aria-label="4.1 å¼•å…¥pythonæ–‡ä»¶">4.1 å¼•å…¥pythonæ–‡ä»¶</a></li>
                    <li>
                        <a href="#42--%e5%88%9d%e5%a7%8b%e5%8c%96-in-python" aria-label="4.2  åˆå§‹åŒ– in python">4.2  åˆå§‹åŒ– in python</a><ul>
                            
                    <li>
                        <a href="#421-%e5%bc%95%e5%85%a5so%e5%ba%93" aria-label="4.2.1 å¼•å…¥SOåº“">4.2.1 å¼•å…¥SOåº“</a><ul>
                            
                    <li>
                        <a href="#4211-so%e5%ba%93" aria-label="4.2.1.1 SOåº“">4.2.1.1 SOåº“</a></li>
                    <li>
                        <a href="#4222-so%e4%bd%9c%e7%94%a8" aria-label="4.2.2.2 SOä½œç”¨">4.2.2.2 SOä½œç”¨</a></li></ul>
                    </li>
                    <li>
                        <a href="#422-%e5%88%9d%e5%a7%8b%e5%8c%96%e9%85%8d%e7%bd%ae" aria-label="4.2.2 åˆå§‹åŒ–é…ç½®">4.2.2 åˆå§‹åŒ–é…ç½®</a></li>
                    <li>
                        <a href="#423-hvdinit-%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="4.2.3 hvd.init() åˆå§‹åŒ–">4.2.3 hvd.init() åˆå§‹åŒ–</a></li></ul>
                    </li>
                    <li>
                        <a href="#43-%e5%88%9d%e5%a7%8b%e5%8c%96-in-c" aria-label="4.3 åˆå§‹åŒ– in C&#43;&#43;">4.3 åˆå§‹åŒ– in C++</a><ul>
                            
                    <li>
                        <a href="#431-horovod_init_comm" aria-label="4.3.1 horovod_init_comm">4.3.1 horovod_init_comm</a></li>
                    <li>
                        <a href="#432-initializehorovodonce" aria-label="4.3.2 InitializeHorovodOnce">4.3.2 InitializeHorovodOnce</a></li>
                    <li>
                        <a href="#433-horovodglobalstate" aria-label="4.3.3 HorovodGlobalState">4.3.3 HorovodGlobalState</a></li></ul>
                    </li>
                    <li>
                        <a href="#43-hvd-%e6%a6%82%e5%bf%b5" aria-label="4.3 hvd æ¦‚å¿µ">4.3 hvd æ¦‚å¿µ</a></li>
                    <li>
                        <a href="#45--%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86" aria-label="4.5  æ•°æ®å¤„ç†">4.5  æ•°æ®å¤„ç†</a></li>
                    <li>
                        <a href="#46-%e5%b9%bf%e6%92%ad%e5%88%9d%e5%a7%8b%e5%8c%96%e5%8f%98%e9%87%8f" aria-label="4.6 å¹¿æ’­åˆå§‹åŒ–å˜é‡">4.6 å¹¿æ’­åˆå§‹åŒ–å˜é‡</a><ul>
                            
                    <li>
                        <a href="#461-%e5%b9%bf%e6%92%ad%e5%ae%9a%e4%b9%89" aria-label="4.6.1 å¹¿æ’­å®šä¹‰">4.6.1 å¹¿æ’­å®šä¹‰</a></li>
                    <li>
                        <a href="#462-broadcast_variables" aria-label="4.6.2 broadcast_variables">4.6.2 broadcast_variables</a></li>
                    <li>
                        <a href="#463-%e8%b0%83%e7%94%a8-mpi" aria-label="4.6.3 è°ƒç”¨ MPI">4.6.3 è°ƒç”¨ MPI</a></li>
                    <li>
                        <a href="#464-%e5%90%8c%e6%ad%a5%e5%8f%82%e6%95%b0" aria-label="4.6.4 åŒæ­¥å‚æ•°">4.6.4 åŒæ­¥å‚æ•°</a></li></ul>
                    </li>
                    <li>
                        <a href="#47-distributedoptimizer" aria-label="4.7 DistributedOptimizer">4.7 DistributedOptimizer</a></li>
                    <li>
                        <a href="#48-%e6%9c%aa%e6%9d%a5%e5%8f%af%e8%83%bd" aria-label="4.8 æœªæ¥å¯èƒ½">4.8 æœªæ¥å¯èƒ½</a></li></ul>
                    </li>
                    <li>
                        <a href="#5-%e6%80%bb%e7%bb%93" aria-label="5 æ€»ç»“">5 æ€»ç»“</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><p>reference:
[1].https://www.cnblogs.com/rossiXYZ/p/14856543.html</p>
<h2 id="0-æ‘˜è¦">0 æ‘˜è¦<a hidden class="anchor" aria-hidden="true" href="#0-æ‘˜è¦">#</a></h2>
<p>Horovod æ˜¯Uberäº2017å¹´å‘å¸ƒçš„ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ï¼Œåœ¨ä¸šç•Œå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚</p>
<p>æœ¬ç³»åˆ—å°†é€šè¿‡æºç åˆ†ææ¥å¸¦é¢†å¤§å®¶äº†è§£ Horovodã€‚ç³»åˆ—å¤§çº¦æœ‰15 ï½ 18 ç¯‡ï¼Œæœ¬æ–‡æ˜¯ç³»åˆ—ç¬¬äºŒç¯‡ï¼Œä»ç”¨æˆ·è§’åº¦åˆ‡å…¥ Horovodã€‚</p>
<p>å‰ä¸€ç¯‡å‚è§å¦‚ä¸‹ï¼š</p>
<p><a href="http://localhost:1313/posts/notes/2022-10-08_horovod_1/">æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[1] &ndash; åŸºç¡€çŸ¥è¯†</a></p>
<h2 id="1-horovod-ç®€ä»‹">1 Horovod ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#1-horovod-ç®€ä»‹">#</a></h2>
<p>Horovod æ˜¯Uberäº2017å¹´å‘å¸ƒçš„ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ï¼Œæ”¯æŒTensorFlowï¼ŒKerasï¼ŒPyTorchå’ŒMXNetã€‚Horovod çš„åå­—æ¥è‡ªäºä¿„å›½ä¼ ç»Ÿæ°‘é—´èˆè¹ˆï¼Œèˆè€…æ‰‹ç‰µæ‰‹å›´æˆä¸€ä¸ªåœˆè·³èˆï¼Œä¸åˆ†å¸ƒå¼ TensorFlow æµç¨‹ä½¿ç”¨ Horovod äº’ç›¸é€šä¿¡çš„åœºæ™¯å¾ˆåƒã€‚</p>
<p>å› ä¸ºå„ä¸ªæœºå™¨å­¦ä¹ æ¡†æ¶å¯¹äºåº•å±‚é›†åˆé€šä¿¡åº“ï¼ˆ ncclï¼Œopenmpiï¼Œgloo ç­‰ç­‰ï¼‰çš„åˆ©ç”¨æ°´å¹³å¯èƒ½å„ä¸ç›¸åŒï¼Œä½¿å¾—ä»–ä»¬æ— æ³•å……åˆ†åˆ©ç”¨è¿™äº›åº•å±‚é›†åˆé€šä¿¡åº“çš„å¨åŠ›ã€‚å› è€Œï¼Œhovorod å°±æ•´åˆè¿™äº›æ¡†æ¶ï¼Œæä¾›ä¸€ä¸ªæ˜“ç”¨é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>Uberçš„å·¥ç¨‹å¸ˆå°±æ˜¯æ ¹æ®FaceBookçš„ä¸€ç¯‡paperï¼šâ€œ<a href="https://research.fb.com/wp-content/uploads/2017/06/imagenet1kin1h5.pdf">Accurate, Large Minibatch SGD: Training ImageNet in 1 Hour</a>â€å’Œç™¾åº¦çš„ä¸€ç¯‡â€œ<a href="https://research.baidu.com/bringing-hpc-techniques-deep-learning/">Bringing HPC Techniques to Deep Learning</a>â€ æ”¹è¿›å¹¶å‘å¸ƒäº†å¼€æºæ¡†æ¶Horovodã€‚</p>
<p>Horovod ç›¸æ¯”äºç™¾åº¦çš„å·¥ä½œï¼Œå¹¶æ— å­¦æœ¯ä¸Šçš„è´¡çŒ®ã€‚ä½†æ˜¯ Horovod æ‰å®çš„å·¥ç¨‹å®ç°ï¼Œä½¿å¾—å®ƒå—åˆ°äº†æ›´å¤šçš„å…³æ³¨ã€‚å®ƒæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºå¯¹ RingAllReduce è¿›è¡Œäº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ï¼Œä½¿å…¶æ”¯æŒå¤šç§ä¸åŒçš„æ¡†æ¶ã€‚åŒæ—¶å¼•å…¥äº† Nvidia NCCLï¼Œå¯¹ GPU æ›´åŠ å‹å¥½ã€‚</p>
<p>Horovodä¾èµ–äºNvidiaçš„ NCCL2 åš All Reduceï¼Œä¾èµ–äºMPIåšè¿›ç¨‹é—´é€šä¿¡ï¼Œç®€åŒ–äº†åŒæ­¥å¤š GPU æˆ–å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼è®­ç»ƒçš„å¼€å‘æµç¨‹ã€‚ç”±äºä½¿ç”¨äº†NCCL2ï¼ŒHorovodä¹Ÿå¯ä»¥åˆ©ç”¨ä»¥ä¸‹åŠŸèƒ½ï¼šNVLINKï¼ŒRDMAï¼ŒGPUDirectRDMAï¼Œè‡ªåŠ¨æ£€æµ‹é€šä¿¡æ‹“æ‰‘ï¼Œèƒ½å¤Ÿå›é€€åˆ° PCIe å’Œ TCP/IP é€šä¿¡ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å‡ ä¸ªé—®é¢˜æ¥å¼•å¯¼åˆ†æï¼š</p>
<ul>
<li>Hovorod æ€ä¹ˆè¿›è¡Œæ•°æ®åˆ†å‰²ï¼Ÿ</li>
<li>Hovorod æ€ä¹ˆè¿›è¡Œè®­ç»ƒä»£ç åˆ†å‘ï¼Ÿ</li>
<li>Hovorod å¯åŠ¨æ—¶å€™ï¼Œpython å’Œ C++ éƒ½åšäº†ä»€ä¹ˆï¼Ÿ</li>
<li>å¦‚ä½•ç¡®ä¿ Hovorod å¯åŠ¨æ—¶å€™æ­¥éª¤ä¸€è‡´ï¼›</li>
</ul>
<h2 id="2-hovorod-æœºåˆ¶æ¦‚è¿°">2 Hovorod æœºåˆ¶æ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#2-hovorod-æœºåˆ¶æ¦‚è¿°">#</a></h2>
<h3 id="21-horovod-æœºåˆ¶">2.1 Horovod æœºåˆ¶<a hidden class="anchor" aria-hidden="true" href="#21-horovod-æœºåˆ¶">#</a></h3>
<p>Horovodä½¿ç”¨<strong>æ•°æ®å¹¶è¡ŒåŒ–</strong>ç­–ç•¥åœ¨GPUä¸Šåˆ†é…è®­ç»ƒã€‚</p>
<p>åœ¨æ•°æ®å¹¶è¡ŒåŒ–ä¸­ï¼Œä½œä¸šä¸­çš„æ¯ä¸ªGPUéƒ½ä¼šæ¥æ”¶å…¶è‡ªå·±çš„æ•°æ®æ‰¹å¤„ç†çš„ç‹¬ç«‹åˆ‡ç‰‡ï¼Œå³å®ƒçš„â€œæ‰¹å¤„ç†åˆ‡ç‰‡â€ã€‚ æ¯ä¸ªGPUéƒ½ä½¿ç”¨è‡ªå·±åˆ†é…åˆ°çš„æ•°æ®æ¥ç‹¬ç«‹è®¡ç®—ï¼Œè¿›è¡Œæ¢¯åº¦æ›´æ–°ã€‚</p>
<p>å‡å¦‚ä½¿ç”¨ä¸¤ä¸ªGPUï¼Œæ‰¹å¤„ç†å¤§å°ä¸º32ï¼Œåˆ™ç¬¬ä¸€ä¸ªGPUå°†å¤„ç†å‰16æ¡è®°å½•çš„æ­£å‘ä¼ æ’­å’Œå‘åä¼ æ’­ï¼Œä»¥åŠç¬¬äºŒä¸ªGPUå¤„ç†å16æ¡è®°å½•çš„æ­£å‘ä¼ æ’­å’Œå‘åä¼ æ’­ã€‚ç„¶åï¼Œè¿™äº›æ¢¯åº¦æ›´æ–°å°†åœ¨GPUä¹‹é—´å¹³å‡åœ¨ä¸€èµ·ï¼Œæœ€ååº”ç”¨äºæ¨¡å‹ã€‚</p>
<p>æ¯ä¸€ä¸ªè¿­ä»£çš„æ“ä½œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p>æ¯ä¸ª worker å°†ç»´æŠ¤è‡ªå·±çš„æ¨¡å‹æƒé‡å‰¯æœ¬å’Œè‡ªå·±çš„æ•°æ®é›†å‰¯æœ¬ã€‚</p>
</li>
<li>
<p>æ”¶åˆ°æ‰§è¡Œä¿¡å·åï¼Œæ¯ä¸ªå·¥ä½œè¿›ç¨‹éƒ½ä¼šä»æ•°æ®é›†ä¸­æå–ä¸€ä¸ªä¸ç›¸äº¤çš„æ‰¹æ¬¡ï¼Œå¹¶è®¡ç®—è¯¥æ‰¹æ¬¡çš„æ¢¯åº¦ã€‚</p>
</li>
<li>
<p>Workers ä½¿ç”¨ring all-reduceç®—æ³•æ¥åŒæ­¥å½¼æ­¤çš„æ¢¯åº¦ï¼Œä»è€Œåœ¨æœ¬åœ°æ‰€æœ‰èŠ‚ç‚¹ä¸Šè®¡ç®—åŒæ ·çš„å¹³å‡æ¢¯åº¦ã€‚</p>
<ol>
<li>
<p>å°†æ¯ä¸ªè®¾å¤‡ä¸Šçš„æ¢¯åº¦ tensor åˆ‡åˆ†æˆé•¿åº¦å¤§è‡´ç›¸ç­‰çš„ num_devices ä¸ªåˆ†ç‰‡ï¼Œåç»­æ¯ä¸€æ¬¡é€šä¿¡éƒ½å°†ç»™ä¸‹ä¸€ä¸ªé‚»å±…å‘é€ä¸€ä¸ªè‡ªå·±çš„åˆ†ç‰‡ï¼ˆåŒæ—¶ä»ä¸Šä¸€ä¸ªé‚»å±…æ¥å—ä¸€ä¸ªæ–°åˆ†ç‰‡ï¼‰ã€‚</p>
</li>
<li>
<p>ScatterReduce é˜¶æ®µï¼šé€šè¿‡ num_devices - 1 è½®é€šä¿¡å’Œç›¸åŠ ï¼Œåœ¨æ¯ä¸ª device ä¸Šéƒ½è®¡ç®—å‡ºä¸€ä¸ª tensor åˆ†ç‰‡çš„å’Œï¼Œå³æ¯ä¸ª device å°†æœ‰ä¸€ä¸ªå—ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰device ä¸­è¯¥å—ä¸­æ‰€æœ‰å€¼çš„æ€»å’Œï¼›å…·ä½“å¦‚ä¸‹ï¼š</p>
</li>
</ol>
<p><img loading="lazy" src="https://github.com/jianye0428/hello-hugo/raw/master/img/posts/notes/2022-10-08_Horovod_2/Horovod_2_scatter_reduce.png#center" alt="Scatter Reduce"  />
</p>
<ol start="3">
<li>AllGather é˜¶æ®µï¼šé€šè¿‡ num_devices - 1 è½®é€šä¿¡å’Œè¦†ç›–ï¼Œå°†ä¸Šä¸ªé˜¶æ®µè®¡ç®—å‡ºçš„æ¯ä¸ª tensor åˆ†ç‰‡çš„å’Œ å¹¿æ’­åˆ°å…¶ä»– deviceï¼›æœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½æ‹¥æœ‰æ‰€æœ‰tensoråˆ†ç‰‡å’Œã€‚å…·ä½“å¦‚ä¸‹ï¼š
<img loading="lazy" src="https://github.com/jianye0428/hello-hugo/raw/master/img/posts/notes/2022-10-08_Horovod_2/Horovod_2_allgather.png#center" alt="Allgather"  />
</li>
<li>åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šåˆå¹¶åˆ†ç‰‡ï¼Œå¾—åˆ°æ¢¯åº¦å’Œï¼Œç„¶åé™¤ä»¥ num_devicesï¼Œå¾—åˆ°å¹³å‡æ¢¯åº¦ï¼›</li>
</ol>
</li>
<li>
<p>æ¯ä¸ª worker å°† æ¢¯åº¦æ›´æ–° åº”ç”¨äºå…¶æ¨¡å‹çš„æœ¬åœ°å‰¯æœ¬ã€‚</p>
</li>
<li>
<p>æ‰§è¡Œä¸‹ä¸€ä¸ªbatchã€‚</p>
</li>
</ol>
<h2 id="3-ç¤ºä¾‹ä»£ç ">3 ç¤ºä¾‹ä»£ç <a hidden class="anchor" aria-hidden="true" href="#3-ç¤ºä¾‹ä»£ç ">#</a></h2>
<h3 id="31--æ‘˜è¦ä»£ç ">3.1  æ‘˜è¦ä»£ç <a hidden class="anchor" aria-hidden="true" href="#31--æ‘˜è¦ä»£ç ">#</a></h3>
<p>æˆ‘ä»¬æ­¤å¤„ç»™å‡ºå®˜ç½‘ç¤ºä¾‹ä»£ç éƒ¨åˆ†æ‘˜è¦ï¼Œå…·ä½“åˆ†æå‚è§ä¸‹é¢ä»£ç ä¸­çš„æ³¨é‡Šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">horovod.tensorflow.keras</span> <span class="k">as</span> <span class="nn">hvd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Horovod: initialize Horovod.</span>
</span></span><span class="line"><span class="cl"><span class="n">hvd</span><span class="o">.</span><span class="n">init</span><span class="p">()</span> <span class="c1"># åˆå§‹åŒ– Horovodï¼Œå¯åŠ¨ç›¸å…³çº¿ç¨‹å’ŒMPIçº¿ç¨‹</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Horovod: pin GPU to be used to process local rank (one GPU per process)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ä¾æ® local rank ä¸ºä¸åŒçš„è¿›ç¨‹åˆ†é…ä¸åŒçš„GPU</span>
</span></span><span class="line"><span class="cl"><span class="n">gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_memory_growth</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">gpus</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_visible_devices</span><span class="p">(</span><span class="n">gpus</span><span class="p">[</span><span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()],</span> <span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">mnist_images</span><span class="p">,</span> <span class="n">mnist_labels</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> \
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;mnist-</span><span class="si">%d</span><span class="s1">.npz&#39;</span> <span class="o">%</span> <span class="n">hvd</span><span class="o">.</span><span class="n">rank</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ‡åˆ†æ•°æ®  </span>
</span></span><span class="line"><span class="cl"><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">mnist_images</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">             <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">mnist_labels</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mnist_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Horovod: adjust learning rate based on number of GPUs.</span>
</span></span><span class="line"><span class="cl"><span class="n">scaled_lr</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">hvd</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="c1"># æ ¹æ®Workerçš„æ•°é‡å¢åŠ å­¦ä¹ ç‡çš„å¤§å°</span>
</span></span><span class="line"><span class="cl"><span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">scaled_lr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Horovod: add Horovod DistributedOptimizer.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æŠŠå¸¸è§„TensorFlow Optimizeré€šè¿‡HorovodåŒ…è£…èµ·æ¥ï¼Œè¿›è€Œä½¿ç”¨ ring-allreduce æ¥å¾—åˆ°å¹³å‡æ¢¯åº¦</span>
</span></span><span class="line"><span class="cl"><span class="n">opt</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">DistributedOptimizer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt</span><span class="p">,</span> <span class="n">backward_passes_per_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">average_aggregated_gradients</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Horovod: Specify `experimental_run_tf_function=False` to ensure TensorFlow</span>
</span></span><span class="line"><span class="cl"><span class="c1"># uses hvd.DistributedOptimizer() to compute gradients.</span>
</span></span><span class="line"><span class="cl"><span class="n">mnist_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">experimental_run_tf_function</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">hvd</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BroadcastGlobalVariablesCallback</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># å¹¿æ’­åˆå§‹åŒ–ï¼Œå°†æ¨¡å‹çš„å‚æ•°ä»ç¬¬ä¸€ä¸ªè®¾å¤‡ä¼ å‘å…¶ä»–è®¾å¤‡ï¼Œä»¥ä¿è¯åˆå§‹åŒ–æ¨¡å‹å‚æ•°çš„ä¸€è‡´æ€§</span>
</span></span><span class="line"><span class="cl">    <span class="n">hvd</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">MetricAverageCallback</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="n">hvd</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateWarmupCallback</span><span class="p">(</span><span class="n">initial_lr</span><span class="o">=</span><span class="n">scaled_lr</span><span class="p">,</span> <span class="n">warmup_epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Horovod: save checkpoints only on worker 0 to prevent other workers from corrupting them. # åªæœ‰è®¾å¤‡0éœ€è¦ä¿å­˜æ¨¡å‹å‚æ•°ä½œä¸ºcheckpoint</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span><span class="s1">&#39;./checkpoint-</span><span class="si">{epoch}</span><span class="s1">.h5&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Horovod: write logs on worker 0.</span>
</span></span><span class="line"><span class="cl"><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Train the model.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Horovod: adjust number of steps based on number of GPUs.</span>
</span></span><span class="line"><span class="cl"><span class="n">mnist_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">500</span> <span class="o">//</span> <span class="n">hvd</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-horovodrun">3.2 horovodrun<a hidden class="anchor" aria-hidden="true" href="#32-horovodrun">#</a></h3>
<p>Horovodè®­ç»ƒè„šæœ¬æœªä½œä¸ºPythonè„šæœ¬å¯åŠ¨ã€‚ ä¾‹å¦‚ï¼Œæ‚¨ä¸èƒ½ä½¿ç”¨<code>python train.py</code>è¿è¡Œæ­¤è„šæœ¬ã€‚ éœ€è¦é‡‡ç”¨ç‰¹æ®Šçš„CLIå‘½ä»¤ <code>horovodrun</code> æ¥å¯åŠ¨ï¼ˆè®­ç»ƒä»£ç  train.py éœ€è¦æ‰‹åŠ¨æ‹·è´åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä¸”ç›®å½•ç›¸åŒï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ horovodrun -np 4 -H localhost:4 python train.py
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-è¿è¡Œé€»è¾‘">4 è¿è¡Œé€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#4-è¿è¡Œé€»è¾‘">#</a></h2>
<p>æˆ‘ä»¬æŒ‰ç…§é¡ºåºæ¢³ç†ï¼Œçœ‹çœ‹åœ¨ç¨‹åºåˆå§‹åŒ–è¿‡ç¨‹èƒŒåéƒ½åšäº†ä»€ä¹ˆã€‚</p>
<h3 id="41-å¼•å…¥pythonæ–‡ä»¶">4.1 å¼•å…¥pythonæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#41-å¼•å…¥pythonæ–‡ä»¶">#</a></h3>
<p>å¦‚ä¸‹ä»£ç ä¼šå¼•å…¥å„ç§ç›¸å…³pythonæ–‡ä»¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">horovod.tensorflow.keras</span> <span class="k">as</span> <span class="nn">hvd</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42--åˆå§‹åŒ–-in-python">4.2  åˆå§‹åŒ– in python<a hidden class="anchor" aria-hidden="true" href="#42--åˆå§‹åŒ–-in-python">#</a></h3>
<p>python ä¸–ç•Œçš„åˆå§‹åŒ–ä½äº <code>horovod-master/horovod/mxnet/mpi_ops.py</code></p>
<h4 id="421-å¼•å…¥soåº“">4.2.1 å¼•å…¥SOåº“<a hidden class="anchor" aria-hidden="true" href="#421-å¼•å…¥soåº“">#</a></h4>
<h5 id="4211-soåº“">4.2.1.1 SOåº“<a hidden class="anchor" aria-hidden="true" href="#4211-soåº“">#</a></h5>
<p><code>horovod/tensorflow/mpi_ops.py</code> ä¹‹ä¸­ä¼šå¼•å…¥SOåº“ã€‚
æ¯”å¦‚ <code>dist-packages/horovod/tensorflow/mpi_lib.cpython-36m-x86_64-linux-gnu.so</code>ã€‚</p>
<p>SOåº“ å°±æ˜¯ horovod ä¸­ C++ ä»£ç ç¼–è¯‘å‡ºæ¥çš„ç»“æœã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_load_library</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Loads a .so file containing the specified operators.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">filename</span> <span class="o">=</span> <span class="n">resource_loader</span><span class="o">.</span><span class="n">get_path_to_datafile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">library</span> <span class="o">=</span> <span class="n">load_library</span><span class="o">.</span><span class="n">load_op_library</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">library</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check possible symbol not found error from tensorflow version mismatch</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">MPI_LIB</span> <span class="o">=</span> <span class="n">_load_library</span><span class="p">(</span><span class="s1">&#39;mpi_lib&#39;</span> <span class="o">+</span> <span class="n">get_ext_suffix</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">check_installed_version</span><span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">check_installed_version</span><span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="4222-soä½œç”¨">4.2.2.2 SOä½œç”¨<a hidden class="anchor" aria-hidden="true" href="#4222-soä½œç”¨">#</a></h5>
<p>å¼•å…¥åº“çš„ä½œç”¨æ˜¯è·å–åˆ° C++ çš„å‡½æ•°ï¼Œå¹¶ä¸”ç”¨ python å°è£…ä¸€ä¸‹ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ python ä¸–ç•Œä½¿ç”¨ C++ä»£ç äº†ã€‚</p>
<p>ç”±ä¸‹æ–‡å¯ä»¥çœ‹å‡ºæ¥ï¼Œpython çš„ _allreduce å‡½æ•°å°±ä¼šæŠŠåŠŸèƒ½è½¬å‘ç»™ C++ï¼Œç”± <code>MPI_LIB.horovod_allreduce</code> å®Œæˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_allreduce</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">Sum</span><span class="p">,</span> <span class="n">prescale_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">postscale_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">ignore_name_scope</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_executing_eagerly</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;HorovodAllreduce_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_normalize_name</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">MPI_LIB</span><span class="o">.</span><span class="n">horovod_allreduce</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">reduce_op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">prescale_factor</span><span class="o">=</span><span class="n">prescale_factor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">postscale_factor</span><span class="o">=</span><span class="n">postscale_factor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">ignore_name_scope</span><span class="o">=</span><span class="n">ignore_name_scope</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="422-åˆå§‹åŒ–é…ç½®">4.2.2 åˆå§‹åŒ–é…ç½®<a hidden class="anchor" aria-hidden="true" href="#422-åˆå§‹åŒ–é…ç½®">#</a></h4>
<p>æˆ‘ä»¬æ‘˜å½•äº†ä¸»è¦éƒ¨åˆ†ï¼Œå°±æ˜¯åˆå§‹åŒ– _HorovodBasicsï¼Œç„¶åä» _HorovodBasics å†…è·å–å„ç§å‡½æ•°ï¼Œå˜é‡å’Œé…ç½®ï¼Œæ¯”å¦‚æ˜¯å¦ç¼–è¯‘äº†mpiï¼Œglooç­‰ç­‰.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">horovod.common.basics</span> <span class="kn">import</span> <span class="n">HorovodBasics</span> <span class="k">as</span> <span class="n">_HorovodBasics</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_basics</span> <span class="o">=</span> <span class="n">_HorovodBasics</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s1">&#39;mpi_lib&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># import basic methods</span>
</span></span><span class="line"><span class="cl"><span class="n">init</span> <span class="o">=</span> <span class="n">_basics</span><span class="o">.</span><span class="n">init</span>
</span></span><span class="line"><span class="cl"><span class="n">size</span> <span class="o">=</span> <span class="n">_basics</span><span class="o">.</span><span class="n">size</span>
</span></span><span class="line"><span class="cl"><span class="n">local_size</span> <span class="o">=</span> <span class="n">_basics</span><span class="o">.</span><span class="n">local_size</span>
</span></span><span class="line"><span class="cl"><span class="n">rank</span> <span class="o">=</span> <span class="n">_basics</span><span class="o">.</span><span class="n">rank</span>
</span></span><span class="line"><span class="cl"><span class="n">local_rank</span> <span class="o">=</span> <span class="n">_basics</span><span class="o">.</span><span class="n">local_rank</span>
</span></span><span class="line"><span class="cl"><span class="n">mpi_built</span> <span class="o">=</span> <span class="n">_basics</span><span class="o">.</span><span class="n">mpi_built</span>
</span></span><span class="line"><span class="cl"><span class="n">gloo_enabled</span> <span class="o">=</span> <span class="n">_basics</span><span class="o">.</span><span class="n">gloo_enabled</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="423-hvdinit-åˆå§‹åŒ–">4.2.3 hvd.init() åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#423-hvdinit-åˆå§‹åŒ–">#</a></h4>
<p>é¦–å…ˆéœ€è¦ç”¨ <code>hvd.init()</code> æ¥åˆå§‹åŒ–ï¼Œhorovod ç®¡ç†çš„æ‰€æœ‰çŠ¶æ€éƒ½ä¼šä¼ åˆ° hvd å¯¹è±¡ä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Horovod: initialize Horovod.</span>
</span></span><span class="line"><span class="cl"><span class="n">hvd</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤„è°ƒç”¨çš„æ˜¯ HorovodBasics ä¸­çš„å‡½æ•°ï¼Œæˆ‘ä»¬çœ‹çœ‹åšäº†ä»€ä¹ˆã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™éƒ¨åˆ†ä¼šä¸€ç›´æ·±å…¥åˆ° C++ä¸–ç•Œï¼Œè°ƒç”¨äº†å¤§é‡çš„ MPI_LIB_CTYPES å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦è¿›å…¥åˆ° C++çš„ä¸–ç•Œçœ‹çœ‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;A function that initializes Horovod.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">mpi_built</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPI_LIB_CTYPES</span><span class="o">.</span><span class="n">horovod_mpi_built</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">_sizeof</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">Comm</span><span class="p">)</span> <span class="o">==</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">MPI_Comm</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">MPI_Comm</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">MPI_LIB_CTYPES</span><span class="o">.</span><span class="n">horovod_init_comm</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">MPI_Comm</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">comm_obj</span> <span class="o">=</span> <span class="n">MPI_Comm</span><span class="o">.</span><span class="n">from_address</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">_addressof</span><span class="p">(</span><span class="n">comm</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">MPI_LIB_CTYPES</span><span class="o">.</span><span class="n">horovod_init_comm</span><span class="p">(</span><span class="n">comm_obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">comm_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">MPI_LIB_CTYPES</span><span class="o">.</span><span class="n">horovod_init</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span> <span class="o">*</span> <span class="n">comm_size</span><span class="p">)(</span><span class="o">*</span><span class="n">comm</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">comm_size</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç›®å‰é€»è¾‘å¦‚ä¸‹å›¾ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl">           <span class="n">Import</span> <span class="n">python</span> <span class="n">files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           <span class="n">Import</span> <span class="n">C</span><span class="o">++</span> <span class="n">SO</span> <span class="n">files</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           <span class="n">Create</span> <span class="n">_HorovodBasics</span>
</span></span><span class="line"><span class="cl">                    <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span><span class="line"><span class="cl">                <span class="n">hvd</span><span class="o">.</span><span class="na">init</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">+</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span>              <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="n">C</span><span class="o">++</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="43-åˆå§‹åŒ–-in-c">4.3 åˆå§‹åŒ– in C++<a hidden class="anchor" aria-hidden="true" href="#43-åˆå§‹åŒ–-in-c">#</a></h3>
<h4 id="431-horovod_init_comm">4.3.1 horovod_init_comm<a hidden class="anchor" aria-hidden="true" href="#431-horovod_init_comm">#</a></h4>
<p>åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒHorovod ä¼šï¼š</p>
<ul>
<li>è°ƒç”¨ <code>MPI_Comm_dup</code> è·å–ä¸€ä¸ª Communicatorï¼Œè¿™æ ·å°±æœ‰äº†å’Œ MPI åè°ƒçš„åŸºç¡€ã€‚</li>
<li>ç„¶åè°ƒç”¨ <code>InitializeHorovodOnce</code>ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">void</span> <span class="n">horovod_init_comm</span><span class="p">(</span><span class="n">MPI_Comm</span> <span class="n">comm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">MPI_Comm_dup</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpi_context</span><span class="o">.</span><span class="n">mpi_comm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">InitializeHorovodOnce</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="432-initializehorovodonce">4.3.2 InitializeHorovodOnce<a hidden class="anchor" aria-hidden="true" href="#432-initializehorovodonce">#</a></h4>
<p>InitializeHorovodOnce æ˜¯åˆå§‹åŒ–çš„ä¸»è¦å·¥ä½œï¼Œä¸»è¦æ˜¯ï¼š</p>
<ul>
<li>ä¾æ®æ˜¯å¦ç¼–è¯‘äº† mpi æˆ–è€… glooï¼Œå¯¹å„è‡ªçš„ context è¿›è¡Œå¤„ç†ï¼Œä¸º globalstate åˆ›å»ºå¯¹åº”çš„ controllerï¼›</li>
<li>å¯åŠ¨äº†åå°çº¿ç¨‹ BackgroundThreadLoop ç”¨æ¥åœ¨å„ä¸ªworkerä¹‹é—´åè°ƒï¼›</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">void</span> <span class="n">horovod_init</span><span class="p">(</span><span class="n">const</span> <span class="nb">int</span><span class="o">*</span> <span class="n">ranks</span><span class="p">,</span> <span class="nb">int</span> <span class="n">nranks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">InitializeHorovodOnce</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">nranks</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">void</span> <span class="n">InitializeHorovodOnce</span><span class="p">(</span><span class="n">const</span> <span class="nb">int</span><span class="o">*</span> <span class="n">ranks</span><span class="p">,</span> <span class="nb">int</span> <span class="n">nranks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Ensure</span> <span class="n">background</span> <span class="n">thread</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">started</span> <span class="n">once</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">horovod_global</span><span class="o">.</span><span class="n">initialize_flag</span><span class="o">.</span><span class="n">test_and_set</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">horovod_global</span><span class="o">.</span><span class="n">control_operation</span> <span class="o">=</span> <span class="n">ParseControllerOpsFromEnv</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">horovod_global</span><span class="o">.</span><span class="n">cpu_operation</span> <span class="o">=</span> <span class="n">ParseCPUOpsFromEnv</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">#if HAVE_MPI // ä¾æ®æ˜¯å¦ç¼–è¯‘äº†MPIè¿›è¡Œå¤„ç†</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Enable</span> <span class="n">mpi</span> <span class="ow">is</span> <span class="n">it</span><span class="s1">&#39;s used either in cpu data transfer or controller</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">horovod_global</span><span class="o">.</span><span class="n">cpu_operation</span> <span class="o">==</span> <span class="n">LibType</span><span class="p">::</span><span class="n">MPI</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">horovod_global</span><span class="o">.</span><span class="n">control_operation</span> <span class="o">==</span> <span class="n">LibType</span><span class="p">::</span><span class="n">MPI</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">mpi_context</span><span class="o">.</span><span class="n">Enable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">horovod_global</span><span class="o">.</span><span class="n">control_operation</span> <span class="o">==</span> <span class="n">LibType</span><span class="p">::</span><span class="n">MPI</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="o">//</span> <span class="n">åˆ›å»ºä¸€ä¸ª</span> <span class="n">MPIController</span> <span class="n">å¯¹è±¡</span>
</span></span><span class="line"><span class="cl">      <span class="n">horovod_global</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">new</span> <span class="n">MPIController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">horovod_global</span><span class="o">.</span><span class="n">response_cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">horovod_global</span><span class="o">.</span><span class="n">tensor_queue</span><span class="p">,</span> <span class="n">horovod_global</span><span class="o">.</span><span class="n">timeline</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">horovod_global</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">,</span> <span class="n">horovod_global</span><span class="o">.</span><span class="n">group_table</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">mpi_context</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">horovod_global</span><span class="o">.</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">SetRanks</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">nranks</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#if HAVE_GLOO // ä¾æ®æ˜¯å¦ç¼–è¯‘äº† GLOO è¿›è¡Œå¤„ç†</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Enable</span> <span class="n">gloo</span> <span class="ow">is</span> <span class="n">it</span><span class="s1">&#39;s used either in cpu data transfer or controller</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">horovod_global</span><span class="o">.</span><span class="n">cpu_operation</span> <span class="o">==</span> <span class="n">LibType</span><span class="p">::</span><span class="n">GLOO</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">horovod_global</span><span class="o">.</span><span class="n">control_operation</span> <span class="o">==</span> <span class="n">LibType</span><span class="p">::</span><span class="n">GLOO</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">gloo_context</span><span class="o">.</span><span class="n">Enable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">horovod_global</span><span class="o">.</span><span class="n">control_operation</span> <span class="o">==</span> <span class="n">LibType</span><span class="p">::</span><span class="n">GLOO</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">horovod_global</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">new</span> <span class="n">GlooController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">horovod_global</span><span class="o">.</span><span class="n">response_cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">horovod_global</span><span class="o">.</span><span class="n">tensor_queue</span><span class="p">,</span> <span class="n">horovod_global</span><span class="o">.</span><span class="n">timeline</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">horovod_global</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">,</span> <span class="n">horovod_global</span><span class="o">.</span><span class="n">group_table</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">gloo_context</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Reset</span> <span class="n">initialization</span> <span class="n">flag</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">å¯åŠ¨åå°çº¿ç¨‹</span>
</span></span><span class="line"><span class="cl">    <span class="n">horovod_global</span><span class="o">.</span><span class="n">initialization_done</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">horovod_global</span><span class="o">.</span><span class="n">background_thread</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">thread</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">BackgroundThreadLoop</span><span class="p">,</span> <span class="n">std</span><span class="p">::</span><span class="n">ref</span><span class="p">(</span><span class="n">horovod_global</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Wait</span> <span class="n">to</span> <span class="n">ensure</span> <span class="n">that</span> <span class="n">the</span> <span class="n">background</span> <span class="n">thread</span> <span class="n">has</span> <span class="n">finished</span> <span class="n">initializing</span> <span class="n">MPI</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="err">!</span><span class="n">horovod_global</span><span class="o">.</span><span class="n">initialization_done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="p">::</span><span class="n">this_thread</span><span class="p">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="433-horovodglobalstate">4.3.3 HorovodGlobalState<a hidden class="anchor" aria-hidden="true" href="#433-horovodglobalstate">#</a></h4>
<p>åœ¨ C++ ä¸–ç•Œï¼ŒHorovodGlobalState èµ·åˆ°äº†<font color=red>é›†ä¸­ç®¡ç†å„ç§å…¨å±€å˜é‡</font>çš„ä½œç”¨ã€‚</p>
<p>HorovodGlobalState åœ¨ horovod ä¸­æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå…¶ä¸­çš„å…ƒç´ å¯ä»¥ä¾›ä¸åŒçš„çº¿ç¨‹è®¿é—®ã€‚HorovodGlobalState åœ¨åŠ è½½ C++ çš„ä»£ç æ—¶å€™å°±å·²ç»åˆ›å»ºäº†ï¼ŒåŒæ—¶åˆ›å»ºçš„è¿˜æœ‰å„ç§ contextï¼ˆmpi_context, nccl_context, gpu_contextï¼‰ã€‚</p>
<p>Horovod ä¸»è¦ä¼šåœ¨backgroundThreadLoop ä¸­å®Œæˆ HorovodGlobalState ä¸åŒå…ƒç´ åˆå§‹åŒ–ï¼Œæ¯”è¾ƒé‡è¦çš„æœ‰ï¼š</p>
<ul>
<li>controller ç®¡ç†æ€»ä½“é€šä¿¡æ§åˆ¶æµï¼›</li>
<li>tensor_queue ä¼šå¤„ç†ä»å‰ç«¯è¿‡æ¥çš„é€šä¿¡éœ€æ±‚ï¼ˆallreduceï¼Œbroadcast ç­‰)ï¼›</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// All the Horovod state that must be stored globally per-process.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">HorovodGlobalState</span> <span class="n">horovod_global</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if HAVE_MPI
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">MPIContext</span> <span class="n">mpi_context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if HAVE_GLOO
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">GlooContext</span> <span class="n">gloo_context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="p">....</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">OperationManager</span><span class="o">&gt;</span> <span class="n">op_manager</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>HorovodGlobalState æ‘˜è¦å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">HorovodGlobalState</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Background thread running MPI communication.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">background_thread</span><span class="p">;</span> <span class="c1">// åå°çº¿ç¨‹ï¼Œç”¨æ¥åœ¨å„ä¸ªworkerä¹‹é—´åè°ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">ParameterManager</span> <span class="n">parameter_manager</span><span class="p">;</span> <span class="c1">// ç»´æŠ¤åå°æ€»ä½“å‚æ•°é…ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Encapsulates the fusion buffers, handles resizing and auto-tuning of buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// size.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">FusionBufferManager</span> <span class="n">fusion_buffer</span><span class="p">;</span> <span class="c1">// èåˆtensorï¼Œä»¥ä¾¿ç¼©å‡é€šä¿¡å¼€é”€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">controller</span><span class="p">;</span> <span class="c1">//ç®¡ç†æ€»ä½“é€šä¿¡æ§åˆ¶æµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">TensorQueue</span> <span class="n">tensor_queue</span><span class="p">;</span> <span class="c1">//å¤„ç†ä»å‰ç«¯è¿‡æ¥çš„é€šä¿¡éœ€æ±‚ï¼ˆallreduceï¼Œbroadcast ç­‰ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Pointer to shared buffer for allgather
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span><span class="o">*</span> <span class="n">shared_buffer</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// LRU cache of Responses
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ResponseCache</span> <span class="n">response_cache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Information on registered groups.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">GroupTable</span> <span class="n">group_table</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">~</span><span class="n">HorovodGlobalState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Make sure that the destructor of the background thread is safe to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// call. If a thread is still joinable (not detached or complete) its
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// destructor cannot be called.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">background_thread</span><span class="p">.</span><span class="n">joinable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">shut_down</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">background_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç›®å‰å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">           <span class="n">Import</span> <span class="n">python</span> <span class="n">files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           <span class="n">Import</span> <span class="n">C</span><span class="o">++</span> <span class="n">SO</span> <span class="n">files</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           <span class="n">Create</span> <span class="n">_HorovodBasics</span>
</span></span><span class="line"><span class="cl">                    <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span><span class="line"><span class="cl">                <span class="n">hvd</span><span class="o">.</span><span class="na">init</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">+</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span>              <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-------------------------------------------------------------------------------------------------------------+</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span><span class="o">++</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>                                                          <span class="o">+-----------------------------+</span>
</span></span><span class="line"><span class="cl">                                                                               <span class="o">|</span>  <span class="n">HorovodGlobalState</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl">              <span class="n">horovod_init_comm</span>                                                <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">+</span>                             <span class="o">+------------------+</span>         <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>                             <span class="o">|</span> <span class="n">horovod_global</span> <span class="o">+---------&gt;</span> <span class="o">|</span>        <span class="n">TensorQueue</span>          <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>                             <span class="o">|</span>                  <span class="o">|</span>         <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>                             <span class="o">|</span>                  <span class="o">|</span>         <span class="o">|</span>        <span class="n">background_thread</span>    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                  <span class="o">|</span> <span class="n">mpi_context</span>      <span class="o">|</span>         <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">           <span class="n">InitializeHorovodOnce</span>   <span class="o">+------------&gt;</span> <span class="o">|</span>                  <span class="o">|</span>         <span class="o">|</span>        <span class="n">ParameterManager</span>     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">+</span>                             <span class="o">|</span>                  <span class="o">|</span>         <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>                             <span class="o">|</span> <span class="n">gloo_context</span>     <span class="o">|</span>         <span class="o">|</span>        <span class="n">FusionBufferManager</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>                             <span class="o">|</span>                  <span class="o">|</span>         <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>                             <span class="o">|</span>                  <span class="o">|</span>         <span class="o">|</span>        <span class="n">Controller</span>           <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>                             <span class="o">|</span> <span class="n">op_manager</span>       <span class="o">|</span>         <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">             <span class="n">background_threa</span>                     <span class="o">|</span>                  <span class="o">|</span>         <span class="o">|</span>        <span class="n">ResponseCache</span>        <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                  <span class="o">+------------------+</span>         <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                                               <span class="o">|</span>        <span class="n">shared_buffer</span>        <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                                               <span class="o">+-----------------------------+</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚å›¾ï¼š</p>
<p><img loading="lazy" src="https://github.com/jianye0428/hello-hugo/raw/master/img/posts/notes/2022-10-08_Horovod_2/Horovod_2_init_logic.png#center" alt="HOROVOD INIT LOGIC"  />
</p>
<p>è‡³æ­¤ï¼Œhorovod å·²ç»åˆå§‹åŒ–å®Œæˆï¼Œç”¨æˆ·ä»£ç å¯ä»¥ä½¿ç”¨äº†ã€‚</p>
<h3 id="43-hvd-æ¦‚å¿µ">4.3 hvd æ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#43-hvd-æ¦‚å¿µ">#</a></h3>
<p>åœ¨ç”¨æˆ·ä»£ç ä¸­ï¼Œæ¥ä¸‹æ¥æ˜¯rankæ¦‚å¿µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">hvd</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬ä»‹ç»ä¸‹å‡ ä¸ªç›¸å…³æ¦‚å¿µï¼š</p>
<ul>
<li>Horovodä¸ºè®¾å¤‡ä¸Šçš„æ¯ä¸ªGPUå¯åŠ¨äº†è¯¥è®­ç»ƒè„šæœ¬çš„ä¸€ä¸ªå‰¯æœ¬ã€‚<strong>local rank</strong>å°±æ˜¯åˆ†é…ç»™æŸä¸€å°è®¡ç®—æœºä¸Šæ¯ä¸ªæ‰§è¡Œè®­ç»ƒçš„å”¯ä¸€ç¼–å·ï¼ˆä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯è¿›ç¨‹å·æˆ–è€…GPUè®¾å¤‡çš„IDå·ï¼‰ï¼ŒèŒƒå›´æ˜¯ 0 åˆ° n-1ï¼Œå…¶ä¸­ n æ˜¯è¯¥è®¡ç®—æœºä¸ŠGPUè®¾å¤‡çš„æ•°é‡ã€‚</li>
<li>rank å¯ä»¥è®¤ä¸ºæ˜¯ä»£è¡¨åˆ†å¸ƒå¼ä»»åŠ¡é‡Œçš„ä¸€ä¸ªæ‰§è¡Œè®­ç»ƒçš„å”¯ä¸€å…¨å±€ç¼–å·ï¼ˆ<font color=red>ç”¨äºè¿›ç¨‹é—´é€šè®¯</font>ï¼‰ã€‚Rank 0 åœ¨Horovodä¸­é€šå¸¸å…·æœ‰ç‰¹æ®Šçš„æ„ä¹‰ï¼š<strong>å®ƒæ˜¯è´Ÿè´£æ­¤åŒæ­¥çš„è®¾å¤‡</strong>ã€‚
<ul>
<li>åœ¨ç™¾åº¦çš„å®ç°ä¸­ï¼Œä¸åŒ Rank çš„è§’è‰²æ˜¯ä¸ä¸€æ ·çš„ï¼ŒRank 0 ä¼šå……å½“ coordinator çš„è§’è‰²ã€‚å®ƒä¼šåè°ƒæ¥è‡ªå…¶ä»– Rank çš„ MPI è¯·æ±‚ï¼Œæ˜¯ä¸€ä¸ªå·¥ç¨‹ä¸Šçš„è€ƒé‡ã€‚è¿™ä¸€è®¾è®¡ä¹Ÿè¢«åæ¥çš„ Horovod é‡‡ç”¨ã€‚</li>
<li>Rank 0 ä¹Ÿç”¨æ¥æŠŠå‚æ•°å¹¿æ’­åˆ°å…¶ä»–è¿›ç¨‹ &amp; å­˜å‚¨ checkpointã€‚</li>
<li>world_sizeï¼šè¿›ç¨‹æ€»æ•°é‡ï¼Œä¼šç­‰åˆ°æ‰€æœ‰world_sizeä¸ªè¿›ç¨‹å°±ç»ªä¹‹åæ‰ä¼šå¼€å§‹è®­ç»ƒã€‚</li>
</ul>
</li>
</ul>
<p>hvd.init è¿™éƒ¨åˆ†çš„ç›®çš„å°±æ˜¯è®©<strong>å¹¶è¡Œè¿›ç¨‹</strong>ä»¬å¯ä»¥çŸ¥é“è‡ªå·±è¢«åˆ†é…çš„ rank / local rank ç­‰ä¿¡æ¯ï¼Œäºæ˜¯åç»­å¯ä»¥æ ¹æ® local rankï¼ˆæ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„ç¬¬å‡ å¼  GPU å¡ï¼‰ æ¥è®¾ç½®æ‰€éœ€çš„æ˜¾å­˜åˆ†é…ã€‚</p>
<h3 id="45--æ•°æ®å¤„ç†">4.5  æ•°æ®å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#45--æ•°æ®å¤„ç†">#</a></h3>
<p>æ¥ä¸‹æ¥æ˜¯æ•°æ®å¤„ç†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">mnist_images</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">             <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">mnist_labels</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦è¯´æ˜ï¼š</p>
<ul>
<li>
<p>é¦–å…ˆï¼Œè®­ç»ƒçš„æ•°æ®éœ€è¦æ”¾ç½®åœ¨ä»»ä½•èŠ‚ç‚¹éƒ½èƒ½è®¿é—®çš„åœ°æ–¹ã€‚</p>
</li>
<li>
<p>å…¶æ¬¡ï¼ŒHorovod éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œéœ€è¦åœ¨ä¸åŒæœºå™¨ä¸ŠæŒ‰Rankè¿›è¡Œåˆ‡åˆ†ï¼Œä»¥ä¿è¯æ¯ä¸ªGPUè¿›ç¨‹è®­ç»ƒçš„æ•°æ®é›†æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
</li>
<li>
<p>æ•°æ®é›†æœ¬ä½“éœ€è¦å‡ºäºæ•°æ®å¹¶è¡Œæ€§çš„éœ€æ±‚è€Œè¢«æ‹†åˆ†ä¸ºå¤šä¸ªåˆ†ç‰‡ï¼ŒHorovodçš„ä¸åŒå·¥ä½œèŠ‚ç‚¹éƒ½å°†åˆ†åˆ«è¯»å–è‡ªå·±çš„æ•°æ®é›†åˆ†ç‰‡ã€‚</p>
</li>
</ul>
<p>ä» PyTorch ç¤ºä¾‹è„šæœ¬çœ‹å¾—æ›´åŠ æ¸…æ¥šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Horovod: use DistributedSampler to partition the training data.</span>
</span></span><span class="line"><span class="cl"><span class="n">train_sampler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">DistributedSampler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">num_replicas</span><span class="o">=</span><span class="n">hvd</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">rank</span><span class="o">=</span><span class="n">hvd</span><span class="o">.</span><span class="n">rank</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">train_sampler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>DataLoader</code>çš„é‡‡æ ·å™¨ç»„ä»¶ä»è¦ç»˜åˆ¶çš„æ•°æ®é›†ä¸­è¿”å›å¯è¿­ä»£çš„ç´¢å¼•ã€‚ PyTorchä¸­çš„é»˜è®¤é‡‡æ ·å™¨æ˜¯é¡ºåºçš„ï¼Œè¿”å›åºåˆ—<code>0, 1, 2, â€¦, n</code> ã€‚ Horovodä½¿ç”¨å…¶<code>DistributedSampler</code>è¦†ç›–äº†æ­¤è¡Œä¸ºï¼Œè¯¥DistributedSamplerå¤„ç†è·¨è®¡ç®—æœºçš„æ•°æ®é›†åˆ†åŒºã€‚ <code>DistributedSampler</code>æœ¬èº«æ¥å—ä¸¤ä¸ªå‚æ•°ä½œä¸ºè¾“å…¥ï¼š <code>hvd.size()</code> (GPUçš„æ€»æ•°ï¼Œä¾‹å¦‚16)å’Œ<code>hvd.rank()</code> (ä»æ€»ä½“åˆ—è¡¨ä¸­åˆ†é…ç»™è¯¥è®¾å¤‡çš„IDï¼Œä¾‹å¦‚0â€¦15)ã€‚</p>
</li>
<li>
<p>Pytorchä½¿ç”¨çš„æ˜¯<strong>æ•°æ®åˆ†å¸ƒå¼è®­ç»ƒ</strong>ï¼Œæ¯ä¸ªè¿›ç¨‹å®é™…ä¸Šæ˜¯ç‹¬ç«‹åŠ è½½æ•°æ®çš„ï¼Œæ‰€ä»¥éœ€è¦åŠ è½½ç›¸åŒæ•°æ®é›†åç”¨ä¸€å®šçš„è§„åˆ™æ ¹æ®rankæ¥é¡ºåºåˆ‡å‰²è·å–ä¸åŒçš„æ•°æ®å­é›†ï¼ŒDistributedSamplerå°±æ˜¯ç”¨æ¥ç¡®ä¿dataloaderåªä¼šloadåˆ°æ•´ä¸ªæ•°æ®é›†çš„ä¸€ä¸ªç‰¹å®šå­é›†çš„åšæ³•(å®é™…ä¸Šä¸ç”¨Pytorchæä¾›çš„DistributedSamplerå·¥å…·ï¼Œè‡ªå·±åšåŠ è½½æ•°æ®ååˆ‡åˆ†word_sizeä¸ªå­é›†æŒ‰ranké¡ºåºæ‹¿åˆ°å­é›†æ•ˆæœä¹Ÿæ˜¯ä¸€æ ·)ã€‚</p>
</li>
<li>
<p>åŒæ—¶ä¸ºäº†èƒ½å¤ŸæŒ‰é¡ºåºåˆ’åˆ†æ•°æ®å­é›†ï¼Œæ‹¿åˆ°ä¸åŒéƒ¨åˆ†æ•°æ®ï¼Œæ‰€ä»¥æ•°æ®é›†ä¸èƒ½å¤Ÿè¿›è¡Œéšæœºæ‰“æ•£ï¼Œæ‰€ä»¥ç”¨äº†å‚æ•° <code>'shuffle': False</code>ã€‚</p>
</li>
</ul>
<h3 id="46-å¹¿æ’­åˆå§‹åŒ–å˜é‡">4.6 å¹¿æ’­åˆå§‹åŒ–å˜é‡<a hidden class="anchor" aria-hidden="true" href="#46-å¹¿æ’­åˆå§‹åŒ–å˜é‡">#</a></h3>
<p>ä»¥ä¸‹ä»£ç å®Œæˆå¹¿æ’­åˆå§‹åŒ–çš„åŠŸèƒ½ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">hvd</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">BroadcastGlobalVariablesCallback</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™å¥ä»£ç ä¿è¯çš„æ˜¯ rank 0 ä¸Šçš„æ‰€æœ‰å‚æ•°åªåœ¨ rank 0 åˆå§‹åŒ–ï¼Œç„¶åå¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå³å˜é‡ä»ç¬¬ä¸€ä¸ªæµç¨‹å‘å…¶ä»–æµç¨‹ä¼ æ’­ï¼Œä»¥å®ç°å‚æ•°ä¸€è‡´æ€§åˆå§‹åŒ–ã€‚</p>
<p>ä¸‹é¢å°±ä»‹ç»ä¸‹ Horvod ä¹‹ä¸­å¹¿æ’­çš„ä½¿ç”¨ã€‚</p>
<h4 id="461-å¹¿æ’­å®šä¹‰">4.6.1 å¹¿æ’­å®šä¹‰<a hidden class="anchor" aria-hidden="true" href="#461-å¹¿æ’­å®šä¹‰">#</a></h4>
<p>å¹¿æ’­çš„å…·ä½“å®ç°æ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BroadcastGlobalVariablesCallbackImpl</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">root_rank</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">(</span><span class="n">BroadcastGlobalVariablesCallbackImpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root_rank</span> <span class="o">=</span> <span class="n">root_rank</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">_executing_eagerly</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;variables&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># TensorFlow 2.0 or TensorFlow eager</span>
</span></span><span class="line"><span class="cl">                <span class="n">hvd</span><span class="o">.</span><span class="n">broadcast_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">root_rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">hvd</span><span class="o">.</span><span class="n">broadcast_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">variables</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">root_rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">bcast_op</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">broadcast_global_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">bcast_op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="462-broadcast_variables">4.6.2 broadcast_variables<a hidden class="anchor" aria-hidden="true" href="#462-broadcast_variables">#</a></h4>
<p>broadcast_variables è°ƒç”¨äº† _make_broadcast_group_fn å®ŒæˆåŠŸèƒ½ï¼Œå¯ä»¥çœ‹åˆ°å¯¹äº æ‰§è¡Œå›¾ çš„æ¯ä¸ªå˜é‡ï¼Œè°ƒç”¨äº† broadcastã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">broadcast_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">root_rank</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Broadcasts variables from root rank to all other processes.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Arguments:
</span></span></span><span class="line"><span class="cl"><span class="s2">        variables: variables for broadcast
</span></span></span><span class="line"><span class="cl"><span class="s2">        root_rank: rank of the process from which global variables will be broadcasted
</span></span></span><span class="line"><span class="cl"><span class="s2">                   to all other processes.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">broadcast_group</span> <span class="o">=</span> <span class="n">_make_broadcast_group_fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">broadcast_group</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">root_rank</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥åŠ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@_cache</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_make_broadcast_group_fn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">_executing_eagerly</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Eager mode will parallelize independent control flow</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">broadcast_group</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">root_rank</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">var</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">broadcast</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">root_rank</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_make_subgraph</span><span class="p">(</span><span class="n">broadcast_group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Graph mode requires an Op</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">broadcast_group</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">root_rank</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">broadcast</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">root_rank</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                              <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">broadcast_group</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="463-è°ƒç”¨-mpi">4.6.3 è°ƒç”¨ MPI<a hidden class="anchor" aria-hidden="true" href="#463-è°ƒç”¨-mpi">#</a></h4>
<p>broadcast å°±æ˜¯è°ƒç”¨äº† MPI å‡½æ•°çœŸæ­£å®Œæˆäº†åŠŸèƒ½ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">root_rank</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_name_scope</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;An op which broadcasts the input tensor on root rank to the same input tensor
</span></span></span><span class="line"><span class="cl"><span class="s2">    on all other Horovod processes.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    The broadcast operation is keyed by the name of the op. The tensor type and
</span></span></span><span class="line"><span class="cl"><span class="s2">    shape must be the same on all Horovod processes for a given name. The broadcast
</span></span></span><span class="line"><span class="cl"><span class="s2">    will not start until all processes are ready to send and receive the tensor.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">      A tensor of the same shape and type as `tensor`, with the value broadcasted
</span></span></span><span class="line"><span class="cl"><span class="s2">      from root rank.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_executing_eagerly</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;HorovodBroadcast_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_normalize_name</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">MPI_LIB</span><span class="o">.</span><span class="n">horovod_broadcast</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">root_rank</span><span class="o">=</span><span class="n">root_rank</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">ignore_name_scope</span><span class="o">=</span><span class="n">ignore_name_scope</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="464-åŒæ­¥å‚æ•°">4.6.4 åŒæ­¥å‚æ•°<a hidden class="anchor" aria-hidden="true" href="#464-åŒæ­¥å‚æ•°">#</a></h4>
<p>åœ¨åå°è¿›ç¨‹ä¸­ï¼Œä¼š<strong>æ ¹æ®æƒ…å†µå®šæœŸåŒæ­¥å‚æ•°</strong>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">RunLoopOnce</span><span class="p">(</span><span class="n">HorovodGlobalState</span><span class="o">&amp;</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¸šåŠ¡é€»è¾‘åŠŸèƒ½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">parameter_manager</span><span class="p">.</span><span class="n">IsAutoTuning</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">should_sync</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">.</span><span class="n">parameter_manager</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">tensor_names</span><span class="p">,</span> <span class="n">total_tensor_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// çœ‹çœ‹æ˜¯å¦éœ€è¦åŒæ­¥ï¼Œå¦‚æœéœ€è¦ï¼Œå°±åŒæ­¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">should_sync</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span><span class="p">.</span><span class="n">controller</span><span class="o">-&gt;</span><span class="n">SynchronizeParameters</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŒæ­¥å‚æ•°ä»£ç ä¹Ÿæ˜¯è°ƒç”¨äº† Bcast åŠŸèƒ½å®Œæˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Controller</span><span class="o">::</span><span class="n">SynchronizeParameters</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ParameterManager</span><span class="o">::</span><span class="n">Params</span> <span class="n">param</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">is_coordinator_</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// rank 0 æ‰§è¡Œæ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">param</span> <span class="o">=</span> <span class="n">parameter_manager_</span><span class="p">.</span><span class="n">GetParams</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">param_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Bcast</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">param_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Communicator</span><span class="o">::</span><span class="n">GLOBAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_coordinator_</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// worker æ‰§è¡Œæ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">parameter_manager_</span><span class="p">.</span><span class="n">SetParams</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="47-distributedoptimizer">4.7 DistributedOptimizer<a hidden class="anchor" aria-hidden="true" href="#47-distributedoptimizer">#</a></h3>
<p>æœ€åéœ€è¦é…ç½®DistributedOptimizerï¼Œè¿™å°±æ˜¯å…³é”®ç‚¹ä¹‹ä¸€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Horovod: add Horovod DistributedOptimizer.</span>
</span></span><span class="line"><span class="cl"><span class="n">opt</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">DistributedOptimizer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt</span><span class="p">,</span> <span class="n">backward_passes_per_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">average_aggregated_gradients</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>TF Optimizer æ˜¯æ¨¡å‹è®­ç»ƒçš„å…³é”®APIï¼Œå¯ä»¥è·å–åˆ°æ¯ä¸ªOPçš„æ¢¯åº¦å¹¶ç”¨æ¥æ›´æ–°æƒé‡ã€‚HVD åœ¨åŸå§‹ TF Optimizerçš„åŸºç¡€ä¸ŠåŒ…è£…äº†hvd.DistributedOptimizerã€‚</p>
<p>DistributedOptimizeråŒ…è£…å™¨å°†åŸå§‹ä¼˜åŒ–å™¨ä½œä¸ºè¾“å…¥ï¼Œå°†æ¢¯åº¦è®¡ç®—å§”æ‰˜ç»™å®ƒã€‚ å³DistributedOptimizerä¼šè°ƒç”¨åŸå§‹ä¼˜åŒ–å™¨è¿›è¡Œæ¢¯åº¦è®¡ç®—ã€‚è¿™æ ·ï¼Œåœ¨é›†ç¾¤ä¸­æ¯å°æœºå™¨éƒ½ä¼šç”¨åŸå§‹ä¼˜åŒ–å™¨å¾—åˆ°è‡ªå·±çš„æ¢¯åº¦ï¼ˆLocal Gradientï¼‰ã€‚</p>
<p><code>Horovod DistributedOptimizer</code>æ¥ä¸‹æ¥ä¼šä½¿ç”¨all-reduceæˆ–all-gatheræ¥å®Œæˆå…¨å±€æ¢¯åº¦å½’å¹¶ï¼Œç„¶åå°†è¿™äº›å¹³å‡æ¢¯åº¦åº”ç”¨äºæ‰€æœ‰è®¾å¤‡ã€‚</p>
<p>æˆ‘ä»¬æ¢³ç†ä¸‹å…¶ä¸­çš„è°ƒç”¨å…³ç³»ï¼š</p>
<ul>
<li>hvd.DistributedOptimizerç»§æ‰¿ keras Optimizerï¼Œåœ¨è®¡ç®—æ—¶å€™ï¼Œä¾ç„¶ç”±ä¼ å…¥çš„åŸå§‹ä¼˜åŒ–å™¨åšè®¡ç®—ã€‚</li>
<li>åœ¨å¾—åˆ°è®¡ç®—çš„æ¢¯åº¦ä¹‹åï¼Œè°ƒç”¨ hvd.allreduce æˆ–è€… hvd.allgather æ¥è®¡ç®—ã€‚</li>
<li>æœ€åå®æ–½è¿™äº›å¹³å‡ä¹‹åçš„æ¢¯åº¦ã€‚ä»è€Œå®ç°æ•´ä¸ªé›†ç¾¤çš„æ¢¯åº¦å½’å¹¶æ“ä½œã€‚</li>
</ul>
<p>å…·ä½“åæ–‡ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>
<h3 id="48-æœªæ¥å¯èƒ½">4.8 æœªæ¥å¯èƒ½<a hidden class="anchor" aria-hidden="true" href="#48-æœªæ¥å¯èƒ½">#</a></h3>
<p>Horovod ç›®å‰æ¶æ„çš„åŸºç¡€æ˜¯ï¼šæœºå™¨å­¦ä¹ çš„æ¨¡å‹å‚æ•°åœ¨ä¸€å¼  GPU ä¸Šå¯ä»¥å­˜ä¸‹ã€‚</p>
<p><strong>æœªæ¥æ˜¯å¦å¯ä»¥æŠŠæ¨¡å‹åˆ†ç‰‡ç»“åˆè¿›æ¥ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„çœ‹ç‚¹ã€‚</strong></p>
<p>å¦å¤–ï¼Œå¦‚æœæ¨¡å‹çš„å…¨è¿æ¥å±‚è¾ƒå¤šï¼Œåˆ™å…¨è¿æ¥å±‚çš„å¼ºè€¦åˆæ€§ç»“åˆ allreduce ç±»ä¼¼ bsp çš„åŒæ­¥æœºåˆ¶ï¼Œè¿˜æ˜¯ä¼šè®©ç½‘ç»œé€šä¿¡æ—¶é—´æˆä¸ºç“¶é¢ˆã€‚å› æ­¤ï¼Œåœ¨ ring-allreduce ç¯å¢ƒä¸‹ï¼ŒåŒæ­¥åè®®çš„æ”¹é€ ï¼Œæ¯”å¦‚åˆ©ç”¨ SSP æ¥æ›¿æ¢ BSPï¼Œæˆ–è€…åˆ©ç”¨æ¢¯åº¦å‹ç¼©æ¥åŠ å¿« allreduce è¿›ç¨‹ä¹Ÿæ˜¯å€¼å¾—æ¢ç´¢çš„æ–¹å‘ã€‚</p>
<h2 id="5-æ€»ç»“">5 æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#5-æ€»ç»“">#</a></h2>
<p>é’ˆå¯¹æ–‡åˆæå‡ºçš„å‡ ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç°åœ¨å›ç­”å¦‚ä¸‹ï¼š</p>
<ul>
<li>Hovorod æ€ä¹ˆè¿›è¡Œæ•°æ®åˆ†å‰²ï¼Ÿ
ç­”æ¡ˆï¼šæœ‰çš„æ¡†æ¶å¯ä»¥è‡ªåŠ¨åšæ•°æ®åˆ†å‰²ã€‚å¦‚æœæ¡†æ¶ä¸æä¾›ï¼Œåˆ™éœ€è¦ç”¨æˆ·è‡ªå·±è¿›è¡Œæ•°æ®åˆ†å‰²ï¼Œä»¥ä¿è¯æ¯ä¸ªGPUè¿›ç¨‹è®­ç»ƒçš„æ•°æ®é›†æ˜¯ä¸ä¸€æ ·çš„ã€‚</li>
<li>Hovorod æ€ä¹ˆè¿›è¡Œæ¨¡å‹åˆ†å‘ï¼Ÿ
ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ‹·è´è®­ç»ƒä»£ç åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šã€‚</li>
<li>Hovorod å¯åŠ¨æ—¶å€™ï¼Œpython å’Œ C++ éƒ½åšäº†ä»€ä¹ˆï¼Ÿ
ç­”æ¡ˆï¼špython ä¼šå¼•å…¥ C++åº“ï¼Œåˆå§‹åŒ–å„ç§å˜é‡å’Œé…ç½®ã€‚C++éƒ¨åˆ†ä¼šå¯¹ MPIï¼ŒGLOOä¸Šä¸‹æ–‡è¿›è¡Œåˆå§‹åŒ–ï¼Œå¯åŠ¨åå°è¿›ç¨‹å¤„ç†å†…éƒ¨é€šä¿¡ã€‚</li>
<li>å¦‚ä½•ç¡®ä¿ Hovorod å¯åŠ¨æ—¶å€™æ­¥éª¤ä¸€è‡´ï¼›
ç­”æ¡ˆï¼š rank 0 ä¸Šçš„æ‰€æœ‰å‚æ•°åªåœ¨ rank 0 åˆå§‹åŒ–ï¼Œç„¶åå¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå³å˜é‡ä»ç¬¬ä¸€ä¸ªæµç¨‹å‘å…¶ä»–æµç¨‹ä¼ æ’­ï¼Œä»¥å®ç°å‚æ•°ä¸€è‡´æ€§åˆå§‹åŒ–ã€‚</li>
</ul>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« å°†æ·±å…¥åˆ°pythonä¸–ç•Œçœ‹çœ‹ã€‚</p>
<p>reference:
[1].https://www.cnblogs.com/rossiXYZ/p/14856543.html</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jianye0428.github.io/en/tags/horovod/">Horovod</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://jianye0428.github.io/en/posts/notes/2022-10-09_horovod_3/">
    <span class="title"><i class="fas fa-angle-double-left"></i> Prev Page</span>
    <br>
    <span>æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ horovod(3) --- HorovodrunèƒŒååšäº†ä»€ä¹ˆ</span>
  </a>
  <a class="next" href="https://jianye0428.github.io/en/posts/notes/2022-10-08_horovod_1/">
    <span class="title">Next Page <i class="fas fa-angle-double-right"></i></span>
    <br>
    <span>æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[1] -- åŸºç¡€çŸ¥è¯†</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥ on twitter"
        href="https://twitter.com/intent/tweet/?text=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20Horovod%5b2%5d%20--%20%e4%bb%8e%e4%bd%bf%e7%94%a8%e8%80%85%e8%a7%92%e5%ba%a6%e5%88%87%e5%85%a5&amp;url=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-08_horovod_2%2f&amp;hashtags=Horovod">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥ on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-08_horovod_2%2f&amp;title=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20Horovod%5b2%5d%20--%20%e4%bb%8e%e4%bd%bf%e7%94%a8%e8%80%85%e8%a7%92%e5%ba%a6%e5%88%87%e5%85%a5&amp;summary=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20Horovod%5b2%5d%20--%20%e4%bb%8e%e4%bd%bf%e7%94%a8%e8%80%85%e8%a7%92%e5%ba%a6%e5%88%87%e5%85%a5&amp;source=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-08_horovod_2%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥ on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-08_horovod_2%2f&title=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20Horovod%5b2%5d%20--%20%e4%bb%8e%e4%bd%bf%e7%94%a8%e8%80%85%e8%a7%92%e5%ba%a6%e5%88%87%e5%85%a5">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥ on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-08_horovod_2%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥ on whatsapp"
        href="https://api.whatsapp.com/send?text=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20Horovod%5b2%5d%20--%20%e4%bb%8e%e4%bd%bf%e7%94%a8%e8%80%85%e8%a7%92%e5%ba%a6%e5%88%87%e5%85%a5%20-%20https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-08_horovod_2%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share æ·±åº¦å­¦ä¹ åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ Horovod[2] -- ä»ä½¿ç”¨è€…è§’åº¦åˆ‡å…¥ on telegram"
        href="https://telegram.me/share/url?text=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20Horovod%5b2%5d%20--%20%e4%bb%8e%e4%bd%bf%e7%94%a8%e8%80%85%e8%a7%92%e5%ba%a6%e5%88%87%e5%85%a5&amp;url=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-08_horovod_2%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>

  </footer>




<footer class="tc-container" id="comment">
    <div class="tc-title"><p class="c-title">Discussion</p></div>
    <div id="tcomments"></div>
</footer>
<script crossorigin="anonymous" src="/js/twikoo.min.b16100b7cf8a61759eab076a122482054e083087aad37c3be1fe2e293934dc34.js" integrity="sha256-sWEAt8&#43;KYXWeqwdqEiSCBU4IMIeq03w74f4uKTk03DQ="></script>
<script>
    twikoo.init({
        envId: 'https://my-repository-pink.vercel.app/',
        el: '#tcomments',
        region: 'ap-shanghai', 
        
        lang: 'zh-CN', 
    });
</script>

</article>
    </main>
    
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
