<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么 | Jian&#39;s Blog</title>
<meta name="keywords" content="Horovod">
<meta name="description" content="references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html 0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。 本系列将通过源码分析来带领大家了解 Ho">
<meta name="author" content="Jian">
<link rel="canonical" href="https://jianye0428.github.io/en/posts/notes/2022-10-09_horovod_3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.1ea9c8832138446635789668415e5c75b8a534b191ee749a44f5ab404c9f27c2.css" integrity="sha256-HqnIgyE4RGY1eJZoQV5cdbilNLGR7nSaRPWrQEyfJ8I=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jianye0428.github.io/favicon/jian_icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://jianye0428.github.io/favicon/jian_icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jianye0428.github.io/favicon/jian_icon.png">
<link rel="apple-touch-icon" href="https://jianye0428.github.io/favicon/apple-touch-icon.png">
<link rel="mask-icon" href="https://jianye0428.github.io/favicon/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://jianye0428.github.io/en/posts/notes/2022-10-09_horovod_3/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<meta name="baidu-site-verification" content="code-9oLyeix0aK" />
<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4a41bf85d719f0e8c3165fc76904f546";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>



<script defer crossorigin="anonymous" src="/js/katex.min.8f5024e83d2055dd60e021751066111b0057e230db34911dd56242d67f0a4c86.js" integrity="sha256-j1Ak6D0gVd1g4CF1EGYRGwBX4jDbNJEd1WJC1n8KTIY="></script>


<script defer crossorigin="anonymous" src="/js/auto-render.min.b09accad850e4e87b8a2fc8b93fae790def79172b68de72fd777958c52e566ad.js" integrity="sha256-sJrMrYUOToe4ovyLk/rnkN73kXK2jecv13eVjFLlZq0="></script>

<script>
    
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });

    
    window.WebFontConfig = {
        custom: {
            families: ['KaTeX_AMS', 'KaTeX_Caligraphic:n4,n7', 'KaTeX_Fraktur:n4,n7',
            'KaTeX_Main:n4,n7,i4,i7', 'KaTeX_Math:i4,i7', 'KaTeX_Script',
            'KaTeX_SansSerif:n4,n7,i4', 'KaTeX_Size1', 'KaTeX_Size2', 'KaTeX_Size3',
            'KaTeX_Size4', 'KaTeX_Typewriter'],
        },
    };
</script>


<script defer crossorigin="anonymous" src="/js/webfontloader.min.min.d1c6c39d18e2decb5c99dc9efc579098ab37b9654725df3f9c0737bc2dd00760.js" integrity="sha256-0cbDnRji3stcmdye/FeQmKs3uWVHJd8/nAc3vC3QB2A="></script>


 

<script async src="https://www.googletagmanager.com/gtag/js?id=G-C6GDZ56F4S"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-C6GDZ56F4S', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么" />
<meta property="og:description" content="references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html 0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。 本系列将通过源码分析来带领大家了解 Ho" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jianye0428.github.io/en/posts/notes/2022-10-09_horovod_3/" /><meta property="og:image" content="https://i.loli.net/2021/09/26/3OMGXylm8HUYJ6p.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-09T10:49:10&#43;08:00" />
<meta property="article:modified_time" content="2022-10-09T10:49:10&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://i.loli.net/2021/09/26/3OMGXylm8HUYJ6p.png"/>

<meta name="twitter:title" content="深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么"/>
<meta name="twitter:description" content="references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html 0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。 本系列将通过源码分析来带领大家了解 Ho"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://jianye0428.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么",
      "item": "https://jianye0428.github.io/en/posts/notes/2022-10-09_horovod_3/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么",
  "name": "深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么",
  "description": "references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html 0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。 本系列将通过源码分析来带领大家了解 Ho",
  "keywords": [
    "Horovod"
  ],
  "articleBody": "references: [1]. https://www.cnblogs.com/rossiXYZ/p/14881812.html\n0 摘要 Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。\n本系列将通过源码分析来带领大家了解 Horovod。本文是系列第三篇，从 python 开始进入 Horovod 世界，看看 Horovodrun 做了什么。\n前两篇链接如下：\n深度学习分布式训练框架 Horovod (1) — 基础知识\n深度学习分布式训练框架 horovod (2) — 从使用者角度切入\n1 背景知识 首先介绍一些相关背景知识。\n1.1 分布式体系 在设计并行计算机时，最直接的方式就是多个计算单元共享一个内存。共享内存的编程在数据交换和访问上有较大的优势，程序编写起来更加简单。但在扩展性上有较大的瓶颈。\n另一种方式为分布式内存。即每个计算单元有单独的内存，计算单元之间的数据访问通过互联网络去传输。这一架构在可移植性和扩展上会强很多，但消息的传递会成为程序设计中的难点。\n将这两点结合，即是分布式共享内存并行计算机的架构，也是当今最常用的体系结构。\n1.2 并行任务通信 并行任务通信一般分为P2P(Point-to-point communication)和 Collective communication。\nP2P通信这种模式只有一个sender和一个receiver，即点到点通信. Collective communication含多个sender多个receive Collective communication包含一些常见的原语\nbroadcast reduce，allreduce scatter，scatter reduce gather，allgather ring-base collectives ring-allreduce 传统Collective communication假设通信节点组成的topology是一颗fat tree，这样通信效率最高。但实际的通信topology可能比较复杂，并不是一个fat tree。因此一般用ring-based Collective communication。\n1.3 MPI MPI(Message Passing Interface) 是一种可以支持点对点和广播的通信协议，具体实现的库有很多，使用比较流行的包括 Open Mpi， Intel MPI 等等。\nMPI 是一种消息传递编程模型。消息传递指用户必须通过显式地发送和接收消息来实现处理器间的数据交换。在这种并行编程中，每个控制流均有自己独立的地址空间，不同的控制流之间不能直接访问彼此的地址空间，必须通过显式的消息传递来实现。这种编程方式是大规模并行处理机(MPP)和机群(Cluster)采用的主要编程方式。由于消息传递程序设计要求用户很好地分解问题，组织不同控制流间的数据交换，并行计算粒度大，特别适合于大规模可扩展并行算法。\nMPI 是基于进程的并行环境。进程拥有独立的虚拟地址空间和处理器调度，并且执行相互独立。MPI 设计为支持通过网络连接的机群系统，且通过消息传递来实现通信，消息传递是 MPI 的最基本特色。\n1.4 Open-MPI OpenMPI 是一种高性能消息传递库，最初是作为融合的技术和资源从其他几个项目（FT-MPI， LA-MPI， LAM/MPI， 以及 PACX-MPI），它是 MPI-2 标准的一个开源实现，由一些科研机构和企业一起开发和维护。因此，OpenMPI 能够从高性能社区中获得专业技术、工业技术和资源支持，来创建最好的 MPI 库。OpenMPI 提供给系统和软件供应商、程序开发者和研究人员很多便利。易于使用，并运行本身在各种各样的操作系统，网络互连，以及一批/调度系统。\n1.5 MPI 使用问题 因为MPI是分布式内存编程，在后面的开发中涉及节点间信息的传递。往往数据和程序是在多个节点上，所以需要保证执行命令时各节点之间信息的交换。\n具体使用之中，就有两个问题:\n这个多台机器Open-MPI是如何发现并建立连接的呢？ 多机多卡在训练过程中，传输环如何建立，这个也是决定了训练效率，那么Open-MPI如何去做呢？ 关于第一个问题：\n设置SSH免密登录可以免去操作中密码的输入。各节点生成私钥和公钥后需要认证，此时可以保证本机免密登录。将各个子节点的公钥文件发送给主节点，然后分别加入到主节点的认证文件中，此时可以保证主节点对各个子节点的免密登录。最后将认证文件传回到每个子节点，从而保证各个子节点对其他节点之间的免密登录。\n在 Open-MPI 启动的时候，可以指定--hostfile或者--host去指定要运行任务的 IP 或 Hostname，这样 Open-MPI 就会试图通过 ssh 免秘钥的方式试图去链接对方机器，并执行一系列命令，主要是为了同步环境变量、当前路径以及下发启动命令。\n当然用户也可以通过其他方式给远程机器下发命令，这个可以通过环境变量OMPI_MCA_plm_rsh_agent指定。\n关于第二个问题：\n当所有的机器建立好连接，准备开始计算，为了能够最高效的去通信，Open-MPI中集成了组件——hwloc。该组件主要是为了单机硬件资源拓扑构建，进而构建最短路径通信。\n2 入口点 很多机器学习框架都会采用如下套路：shell脚本（可选），python端 和 C++端。\nShell脚本是启动运行的入口，负责解析参数，确认并且调用训练程序； Python是用户的接口，引入了C++库，封装了API，负责运行时和底层C++交互； C++实现底层训练逻辑； 以我们先看看 hordovodrun 脚本。\n2.1 如何运行 官方给出的 Hovorod 运行范例之一如下：\n1 horovodrun -np 2 -H localhost:4 --gloo python /horovod/examples/tensorflow2/tensorflow2_mnist.py 这里 -np 指的是进程的数量，localhost:4表示localhost节点上4个GPU。\n注意，如果虚拟机只有一个核。想要强行地达到并行的效果，可以使用 -np参数，它会自动帮你把一个核心切成多份处理器，每一个分布式处理就是一个slot。\n因此，我们可以从 horovodrun 这个命令入手看看。\n2.2 horovodrun 入口文件可以从 setup.py 看到，其就被映射成 horovod.runner.launch:run_commandline。\n1 2 3 4 5 6 entry_points={ 'console_scripts': [ 'horovodrun = horovod.runner.launch:run_commandline' ] } 所以我们看看 run_commandline\n2.3 run_commandline 该命令位于：horovod-master/horovod/runner/launch.py，我们摘录重要部分。\n1 2 3 def run_commandline(): args = parse_args() _run(args) 于是进入到 _run 函数。可以看到，Horovod 会依据是否是弹性训练来选择不同的路径。我们在此系列中，会首先分析 非弹性训练 _run_static。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 def _run(args): # if hosts are not specified, either parse from hostfile, or default as # localhost if not args.hosts and not args.host_discovery_script: if args.hostfile: args.hosts = hosts.parse_host_files(args.hostfile) else: # Set hosts to localhost if not specified args.hosts = 'localhost:{np}'.format(np=args.np) # Convert nics into set args.nics = set(args.nics.split(',')) if args.nics else None if _is_elastic(args): return _run_elastic(args) else: return _run_static(args) # 我们先看这里 2.4 非弹性训练 _run_static() 在 _run_static 之中做了如下操作：\n首先解析各种参数，得到 settings； 会调用 driver_service.get_common_interfaces 获取网卡以及其他host的信息，依据这些信息会进行slot分配，这部分很复杂，具体我们会有专文讲解（下一篇）。 这里有一个问题：为什么要得到 host, slot, rank 之间的关系信息？由于工程上的考虑，底层 C++ 世界中对于 rank 的角色做了区分：rank 0 是 master，rank n 是 worker，所以这些信息需要决定并且传递给 C++世界； 会根据是否在参数中传递运行函数来决定采取何种路径，一般默认没有运行参数，所以会执行_launch_job 来启动训练 job； 具体代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 def _run_static(args): settings = hvd_settings.Settings(verbose=2 if args.verbose else 0, ssh_port=args.ssh_port, ssh_identity_file=args.ssh_identity_file, extra_mpi_args=args.mpi_args, tcp_flag=args.tcp_flag, binding_args=args.binding_args, key=secret.make_secret_key(), start_timeout=tmout, num_proc=args.np, hosts=args.hosts, output_filename=args.output_filename, run_func_mode=args.run_func is not None, nics=args.nics,...) # 首先解析各种参数，得到 settings fn_cache = None if not args.disable_cache: params = '' if args.np: params += str(args.np) + ' ' if args.hosts: params += str(args.hosts) + ' ' if args.ssh_port: params += str(args.ssh_port) if args.ssh_identity_file: params += args.ssh_identity_file parameters_hash = hashlib.md5(params.encode('utf-8')).hexdigest() fn_cache = cache.Cache(CACHE_FOLDER, CACHE_STALENESS_THRESHOLD_MINUTES, parameters_hash) # 获取网卡以及其他host的信息，依据这些信息会进行slot分配 all_host_names, _ = hosts.parse_hosts_and_slots(args.hosts) remote_host_names = network.filter_local_addresses(all_host_names) nics = driver_service.get_common_interfaces(settings, all_host_names, remote_host_names, fn_cache) if args.run_func: # get the driver IPv4 address driver_ip = network.get_driver_ip(nics) run_func_server = KVStoreServer(verbose=settings.verbose) # 启动内部KV服务器 run_func_server_port = run_func_server.start_server() put_data_into_kvstore(driver_ip, run_func_server_port, 'runfunc', 'func', args.run_func) # 把'func', args.run_func存储成KV command = [sys.executable, '-m', 'horovod.runner.run_task', str(driver_ip), str(run_func_server_port)] try: _launch_job(args, settings, nics, command) results = [None] * args.np for i in range(args.np): results[i] = read_data_from_kvstore(driver_ip, run_func_server_port,'runfunc_result', str(i)) return results finally: run_func_server.shutdown_server() else: command = args.command _launch_job(args, settings, nics, command) # 我们重点讲解这里 return None 目前逻辑如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 +-----------+ |horovodrun | +-----+-----+ | | v +--------+--------+ | run_commandline | +----+------+-----+ | | +---------+ +--------+ | | | | v v +-----+--------+ +----+--------+ | _run_elastic | | _run_static | | | | | +--------------+ +-------------+ 至此，我们已经分析完成 horovod 的入口，下面会分析具体如何启动 Job。\n3 运行训练 Job 3.1 _launch_job _launch_job 会根据配置或者安装情况来进行具体调用。我们看到有三种可能：gloo, mpi, js。\njsrun的资料很难找，所以我们重点看看 gloo, mpi 这两种。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 def _launch_job(args, settings, nics, command): env = os.environ.copy() config_parser.set_env_from_args(env, args) def gloo_run_fn(): driver_ip = network.get_driver_ip(nics) gloo_run(settings, nics, env, driver_ip, command) def mpi_run_fn(): mpi_run(settings, nics, env, command) def js_run_fn(): js_run(settings, nics, env, command) run_controller(args.use_gloo, gloo_run_fn, args.use_mpi, mpi_run_fn, args.use_jsrun, js_run_fn, args.verbose) 3.2 run_controller run_controller 依然是一个中介函数，具体导入 gloo 或者 mpi。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 def run_controller(use_gloo, gloo_run, use_mpi, mpi_run, use_jsrun, js_run, verbosity): if use_gloo: gloo_run() elif use_mpi: mpi_run() elif use_jsrun: js_run() else: if mpi_built(verbose=verbose): if lsf.LSFUtils.using_lsf() and is_jsrun_installed(): js_run() else: mpi_run() elif gloo_built(verbose=verbose): gloo_run() 目前逻辑如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 +-----------+ |horovodrun | +-----+-----+ | | v +--------+--------+ | run_commandline | +----+------+-----+ | | +---------+ +--------+ | | | | v v +-----+--------+ +----+--------+ | _run_elastic | | _run_static | | | | | +--------------+ +------+------+ | | v +------+------+ | _launch_job | | | +------+------+ | | v +---------+--------+ | run_controller | | | +----+----+-----+--+ | | | +-------------+ | +--------+ | | | | | | v v v +------+---+ +------+----+ +---+-----+ | gloo_run | | mpi_run | | js_run | | | | | | | +----------+ +-----------+ +---------+ 于是我们下面就分为两个分支介绍：gloo \u0026 mpi。\n4 Gloo 实现 4.1 Gloo 简介 Gloo 是 facebook出品的一个类似MPI的集合通信库（https://github.com/facebookincubator/gloo）。\n集合通信库的主要特征是：大体上会遵照 MPI 提供的接口规定，实现了包括点对点通信（SEND,RECV等），集合通信（ REDUCE，BROADCAST，ALLREDUCE等）等相关接口，然后根据自己硬件或者是系统的需要，在底层实现上进行相应改动，保证接口的稳定和性能。\nGloo 为CPU和GPU提供了集合通信程序的优化实现。 它特别适用于GPU，因为它可以执行通信而无需使用GPUDirect 将数据传输到CPU的内存。 它还能够使用 NCCL 执行快速的节点内通信，并实现其自己的节点间例程计算。你不需要考虑内存数据的拷贝，只需要实现逻辑就可以。\nGloo 支持集合通信（collective Communication），并对其进行了优化。由于 GPU 之间可以直接进行数据交换，而无需经过 CPU 和内存，因此，在 GPU 上使用 gloo后端速度更快。\nHorovod 为什么会选择 Gloo？个人认为除了其功能的全面性和性能之外，基于它可以二次开发是一个亮点，比如下面我们所说的 Rendezvous 功能就被 Horovod 用来实现弹性训练（我们后文有专门讲解）。\nGloo 和 MPI 都起到了同样类似作用：\n一方面Horovod内集成了基于 Gloo 的AllReduce，类似于NCCL，都是用作梯度规约； 另一方面，Gloo 可以用来启动多个进程（Hovorod里用Rank表示），实现并行计算； 具体如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 +-----------------------+ +-----------------------+ +------------------------+ | gloo_run slot 1 | | gloo_run slot 2 | | gloo_run slot 3 | | | | | | | | +-------------------+ | | +------------------+ | | +------------------+ | | | python train.py | | | | python train.py | | | | python train.py | | +----+ +\u003c------+ +\u003c------+ +\u003c------+ | | | | | | | | | | | | | | | | +-------------------+ | | +------------------+ | | +------------------+ | | | | | | | | | | | +-----------------------+ +-----------------------+ +------------------------+ | | | | | | | v--------------------------------------------------------------------------------------\u003e Ring Allreduce on Gloo 4.2 Rendezvous 功能 4.2.1 Rendezvous 概念 在 Gloo 的文档中，如此说:\n1 2 3 4 5 6 The rendezvous process needs to happen exactly once per Gloo context. It makes participating Gloo processes exchange details for setting up their communication channels. For example, when the TCP transport is used, processes exchange IP address and port number details of listening sockets. Rendezvous can be executed by accessing a key/value store that is accessible by all participating processes. Every process is responsible for setting a number of keys and will wait until their peers have set their keys. The values stored against these keys hold the information that is passed to the transport layer. 大致意思是：\nGloo 在每一个 Gloo context 之中有一个 rendezvous process，Gloo 利用它来交换通讯需要的细节。\nRendezvous 具体实现是可以依靠访问一个 KVstore 来完成。具体细节就是通过 KVstore 来进行交互。\n以 Horovod 为例：\nHorovod 在进行容错 AllReduce 训练时，除了启动 worker 进程外，还会启动一个driver 进程。这个 driver 进程用于帮助 worker 调用 gloo 构造 AllReduce 通信环。 driver 进程中会创建一个带有 KVStore 的 RendezvousServer，driver 会将参与通信的 worker 的 ip 等信息存入 KVstore 中。 然后 worker 就可以调用 gloo 来访问 RendezvousServer 构造通信环了。 4.2.2 RendezvousServer 具体代码如下，可以看到是启动了RendezvousHTTPServer(就是继承拓展了 HTTPServer):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 class RendezvousServer: def __init__(self, verbose=0): self._httpd = None self._listen_thread = None self._verbose = verbose # Rendezvous function finds a available port, create http socket, # and start listening loop to handle request # self.httpd.init needs to be called after server start def start(self, handler_cls=RendezvousHandler): # 下面马上介绍 self._httpd, port = find_port( lambda addr: RendezvousHTTPServer( addr, handler_cls, self._verbose)) # start the listening loop self._listen_thread = in_thread(target=self._httpd.serve_forever) return port def init(self, host_alloc_plan): self._httpd.init(host_alloc_plan) def stop(self): self._httpd.shutdown() self._listen_thread.join() 4.2.3 KVStore KVStore 是由 KVStoreHandler 来体现，RendezvousHandler 继承了 KVStoreHandler，进而被 RendezvousServer 作为 handler 使用。\nKVStoreHandler 精简版代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 class KVStoreHandler(SimpleHTTPRequestHandler): # Override PUT handler def do_PUT(self): paths = self.path.split('/') _, scope, key = paths # Get body length content_length = int(self.headers['Content-Length']) value = self.rfile.read(content_length) self._put_value(scope, key, value) self.send_status_code(OK) def _put_value(self, scope, key, value): with self.server.cache_lock: scope_dict = self.server.cache.setdefault(scope, {}) scope_dict[key] = value 4.2.4 底层使用 Rendezvous 具体如何使用？简要的说：\nPython世界构建了一个 RendezvousServer，其地址配置在环境变量（或者其他方式）中。 在 C++ 世界中，比如 horovod/common/gloo/gloo_context.h，horovod/common/gloo/gloo_context.cc 之中有使用。即得到 Python 配置的 RendezvousServer 的地址端口等，然后构建 gloo 所需的 context。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #define HOROVOD_HOSTNAME \"HOROVOD_HOSTNAME\" #define HOROVOD_RANK \"HOROVOD_RANK\" #define HOROVOD_SIZE \"HOROVOD_SIZE\" #define HOROVOD_LOCAL_RANK \"HOROVOD_LOCAL_RANK\" #define HOROVOD_LOCAL_SIZE \"HOROVOD_LOCAL_SIZE\" #define HOROVOD_CROSS_RANK \"HOROVOD_CROSS_RANK\" #define HOROVOD_CROSS_SIZE \"HOROVOD_CROSS_SIZE\" #define HOROVOD_ELASTIC \"HOROVOD_ELASTIC\" ctx = Rendezvous(HOROVOD_GLOO_GLOBAL_PREFIX, rendezvous_addr_env, rendezvous_port, rank, size, dev, timeout); local_ctx = Rendezvous(HOROVOD_GLOO_LOCAL_PREFIX + hostname, rendezvous_addr_env, rendezvous_port, local_rank, local_size, dev, timeout); cross_ctx = Rendezvous(HOROVOD_GLOO_CROSS_PREFIX + std::to_string(local_rank), rendezvous_addr_env, rendezvous_port, cross_rank, cross_size, dev, timeout); 逻辑如下，C++世界会从python世界的获取到RendezvousServer的 IP，port：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 +---------------------\u003e System Env +------------------+ | addr, port, ... addr, port, ... | | + | | | | | | | | | | | | | | | | | Python | C++ | | | | | | | | | | | | v +---------+---------------+ | +------------+--------+ | RendezvousServer | | |GlooContext | | | | | | | | | | | | | | | | | RendezvousHandler | | | Rendezvous | | | | | | +-------------------------+ | +---------------------+ | + 4.3 Horovd 的 gloo 入口 gloo_run 是 horovod 之中，gloo 模块的 相关入口。\n注释说的很清楚：每一个 thread 将使用 ssh 命令在远程host之上启动训练job。\n1 2 3 4 5 6 def gloo_run(settings, nics, env, server_ip, command): # Each thread will use ssh command to launch the job on each remote host. If an # error occurs in one thread, entire process will be terminated. Otherwise, # threads will keep running and ssh session. exec_command = _exec_command_fn(settings) launch_gloo(command, exec_command, settings, nics, env, server_ip) 就是用 launch_gloo 来运行 exec_command。\n此时 command 参数类似 \"['python', 'train.py']\"。\n4.4 构建可执行环境 gloo_run 的第一部分是 exec_command = _exec_command_fn(settings)，就是基于各种配置来生成可以执行命令环境。如果是远程，就得生成相关远程可运行命令环境（包括切换目录，远程执行等等）。\n4.4.1 _exec_command_fn 具体又可以分为两部分：\n利用 get_remote_command 来生成相关远程可运行环境，比如在训练脚本前面加上 'ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no'； 调整输入输出，利用 safe_shell_exec.execute 来实现安全执行能力； 具体如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 def _exec_command_fn(settings): \"\"\" executes the jobs defined by run command on hosts. :param hosts_alloc: list of dict indicating the allocating info. For example, [{'Hostname':'worker-0', 'Rank': 0, 'Local_rank': 0, 'Cross_rank':0, 'Size':2, 'Local_size':1, 'Cross_size':2}, {'Hostname':'worker-1', 'Rank': 1, 'Local_rank': 0, 'Cross_rank':1, 'Size':2, 'Local_size':1, 'Cross_size':2} ] :type hosts_alloc: list(dict) :param remote_host_names: names that are resolved to one of the addresses of remote hosts interfaces. :param _run_command: command to execute \"\"\" def _exec_command(command, slot_info, events): index = slot_info.rank host_name = slot_info.hostname host_address = network.resolve_host_address(host_name) local_addresses = network.get_local_host_addresses() # 需要构建远程命令 if host_address not in local_addresses: local_command = quote('cd {pwd} \u003e /dev/null 2\u003e\u00261 ; {command}' .format(pwd=os.getcwd(), command=command)) command = get_remote_command(local_command, host=host_name, port=settings.ssh_port, identity_file=settings.ssh_identity_file) # Redirect output if requested # 调整输入输出，利用 safe_shell_exec.execute 来实现安全执行能力 stdout = stderr = None stdout_file = stderr_file = None if settings.output_filename: padded_rank = _pad_rank(index, settings.num_proc) output_dir_rank = os.path.join(settings.output_filename, 'rank.{rank}'.format(rank=padded_rank)) if not os.path.exists(output_dir_rank): os.mkdir(output_dir_rank) stdout_file = open(os.path.join(output_dir_rank, 'stdout'), 'w') stderr_file = open(os.path.join(output_dir_rank, 'stderr'), 'w') stdout = MultiFile([sys.stdout, stdout_file]) stderr = MultiFile([sys.stderr, stderr_file]) # 实现安全执行能力 exit_code = safe_shell_exec.execute(command, index=index, stdout=stdout, stderr=stderr, events=events,...) return exit_code, time.time() return _exec_command 4.4.2 get_remote_command 本函数是针对远程 host，获取如何在其上运行的方式。这个函数是比较新加入的，具体和 kubeflow mpi operator 也相关，以后有机会再分析。\n1 2 3 4 5 6 7 8 9 10 11 12 SSH_COMMAND_PREFIX = 'ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no' def get_ssh_command(local_command, host, port=None, identity_file=None, timeout_s=None): port_arg = f'-p {port}' if port is not None else '' identity_file_arg = f'-i {identity_file}' if identity_file is not None else '' timeout_arg = f'-o ConnectTimeout={timeout_s}' if timeout_s is not None else '' return f'{SSH_COMMAND_PREFIX} {host} {port_arg} {identity_file_arg} {timeout_arg} {local_command}' def get_remote_command(local_command, host, port=None, identity_file=None, timeout_s=None): return f'{env_util.KUBEFLOW_MPI_EXEC} {host} {local_command}' if env_util.is_kubeflow_mpi() \\ else get_ssh_command(local_command, host, port, identity_file, timeout_s) 大致逻辑如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 command : python train.py + | | v +---------+-------------+ | | | get_remote_command | | | +---------+-------------+ | | v ssh -o ... python train.py + | | | v +---------+--------------+ |safe_shell_exec.execute | | | +------------------------+ 4.5 使用 gloo 执行命令 获取到了可执行环境 exec_command 与 执行命令 command 之后，就可以使用 gloo 来执行命令了。\n每个 command 都是被 exec_command 来执行。\nlaunch_gloo 来获取命令，各种配置信息，网卡信息（nics，比如 {’lo’}），host信息等，然后开始运行，就是开始运行我们的训练代码了，具体是：\n建立 RendezvousServer，这个会被底层 Gloo C++ 环境使用到; host_alloc_plan = get_host_assignments 来根据host进行分配slot，就是horovod的哪个rank应该在哪个host上的哪个slot之上运行； get_run_command 获取到可执行命令； slot_info_to_command_fn 来得到在slot之上可执行的 slot command； 依据 slot_info_to_command_fn 构建 args_list，这个 list 之中，每一个arg就是一个 slot command； 多线程执行，在每一个 exec_command 之上执行每一个 arg（slot command）； 代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 def launch_gloo(command, exec_command, settings, nics, env, server_ip): \"\"\" Launches the given command multiple times using gloo. Each command is launched via exec_command. :param command: command to launch :param exec_command: means to execute a single command :param settings: settings for the distribution :param nics: common interfaces :param env: environment to use :param server_ip: ip to use for rendezvous server \"\"\" # Make the output directory if it does not exist if settings.output_filename: _mkdir_p(settings.output_filename) # start global rendezvous server and get port that it is listening on # 建立 RendezvousServer，这个会被底层 Gloo C++ 环境使用到 rendezvous = RendezvousServer(settings.verbose) # allocate processes into slots # 来根据host进行分配slot，就是horovod的哪个rank应该在哪个host上的哪个slot之上运行 hosts = parse_hosts(settings.hosts) host_alloc_plan = get_host_assignments(hosts, settings.num_proc) # start global rendezvous server and get port that it is listening on global_rendezv_port = rendezvous.start() rendezvous.init(host_alloc_plan) # 获取到可执行命令 run_command = get_run_command(command, server_ip, nics, global_rendezv_port) # 得到在slot之上可执行的 slot command slot_info_to_command = _slot_info_to_command_fn(run_command, env) event = register_shutdown_event() # 依据 slot_info_to_command_fn 构建 args_list，这个 list 之中，每一个arg就是一个 slot command args_list = [[slot_info_to_command(slot_info), slot_info, [event]] for slot_info in host_alloc_plan] # If an error occurs in one thread, entire process will be terminated. # Otherwise, threads will keep running. # 多线程执行，在每一个 exec_command 之上执行每一个 arg（slot command） res = threads.execute_function_multithreaded(exec_command, args_list, block_until_all_done=True) for name, value in sorted(res.items(), key=lambda item: item[1][1]): exit_code, timestamp = value 具体 HostInfo.from_string 信息如下：\n1 2 3 4 5 6 7 8 9 10 class HostInfo: def __init__(self, hostname, slots): self.hostname = hostname self.slots = slots @staticmethod def from_string(host_string): hostname, slots = host_string.strip().split(':') return HostInfo(hostname, int(slots)) 4.5.1.2 分配方案 get_host_assignments 会依据 host 和 process capacities (slots) 来给 Horovod 之中的进程分配，即给出一个 horovod rank 和 slot 的对应关系。设置了几个 np，就有几个 slot。\n给出的分配方案类似如下，这样就知道了哪个rank对应于哪个host上的哪个slot：\n1 2 3 4 [ SlotInfo(hostname='h1', rank=0, local_rank=0, cross_rank=0, size=2, local_size=2, coress_size=1), SlotInfo(hostname='h2', rank=1, local_rank=0, cross_rank=0, size=2, local_size=2, coress_size=1), ] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 def get_host_assignments(hosts, min_np, max_np=None): \"\"\"Assign hosts with process capacities (slots) to ranks in the Horovod process. This function will try to allocate as many as possible processes on the same host to leverage local network. :param hosts: list of HostInfo objects describing host and slot capacity :type hosts: list[HostInfo] :param min_np: minimum number of processes to be allocated :param max_np: (optional) maximum number of processes to be allocated :return: a list of the allocation of process on hosts in a `SlotInfo` object. :rtype: list[SlotInfo] \"\"\" host_ranks = [] cross_ranks = collections.defaultdict(dict) rank = 0 # 依据 hosts 信息构建 rank, local rank, cross rank(hierarchical allreduce所需要) for host_info in hosts: ranks = [] for local_rank in range(host_info.slots): if rank == max_np: break ranks.append(rank) rank += 1 cross_ranks_at_local = cross_ranks[local_rank] cross_ranks_at_local[host_info.hostname] = len(cross_ranks_at_local) host_ranks.append((host_info, ranks)) world_size = rank # 给出一个 horovod rank 和 slot 的对应关系。返回一个alloc_list，每个SlotInfo包括各种rank信息 alloc_list = [] for host_info, ranks in host_ranks: local_size = len(ranks) for local_rank, rank in enumerate(ranks): cross_ranks_at_local = cross_ranks[local_rank] cross_rank = cross_ranks_at_local[host_info.hostname] cross_size = len(cross_ranks_at_local) alloc_list.append( SlotInfo( hostname=host_info.hostname, rank=rank, local_rank=local_rank, cross_rank=cross_rank, size=world_size, local_size=local_size, cross_size=cross_size)) return alloc_list 4.5.2 得到运行命令 get_run_command 是从环境变量中得到 Gloo 的变量，然后加到 command 之上。此步完成之后，得到类似如下命令：\n1 HOROVOD_GLOO_RENDEZVOUS_ADDR=1.1.1.1 HOROVOD_GLOO_RENDEZVOUS_PORT=2222 HOROVOD_CPU_OPERATIONS=gloo HOROVOD_GLOO_IFACE=lo HOROVOD_CONTROLLER=gloo python train.py 可以把这个格式缩写为：{horovod_gloo_env} command。\n代码为：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 def create_run_env_vars(server_ip, nics, port, elastic=False): # 从环境变量中得到 Gloo 的变量 run_envs = { 'HOROVOD_GLOO_RENDEZVOUS_ADDR': server_ip, 'HOROVOD_GLOO_RENDEZVOUS_PORT': port, 'HOROVOD_CONTROLLER': \"gloo\", 'HOROVOD_CPU_OPERATIONS': \"gloo\", 'HOROVOD_GLOO_IFACE': list(nics)[0], # TODO: add multiple ifaces in future 'NCCL_SOCKET_IFNAME': ','.join(nics), } if elastic: run_envs[\"HOROVOD_ELASTIC\"] = \"1\" return run_envs def get_run_command(command, server_ip, nics, port, elastic=False): env_vars = create_run_env_vars(server_ip, nics, port, elastic) env_string = \" \".join( [f\"{k}={str(v)}\" for k, v in env_vars.items()]) run_command = ( '{env_string} ' '{command}' # expect a lot of environment variables .format(env_string=env_string, command=' '.join(quote(par) for par in command))) return run_command 4.5.3 得到slot运行命令 得到运行命令之后，这里会结合 horovod env 和 env，以及slot 分配情况 进一步修改为适合 gloo 运行的方式。就是可以在具体每一个slot上运行的命令。\n可以把这个格式缩写为：{horovod_gloo_env} {horovod_rendez_env} {env} run_command。\n此步完成之后，得到类似如下：\n1 2 3 4 HOROVOD_HOSTNAME=1.1.1.1 HOROVOD_RANK=1 HOROVOD_SIZE=2 HOROVOD_LOCAL_RANK=1 SHELL=/bin/bash PATH=XXXX USER=xxx PWD=xxx SSH_CONNECTION=\"1.1.1.1 11 2.2.2.2 22\" HOME=xxx SSH_CLIENZT=xxxx HOROVOD_GLOO_IFACE=lo NCCL_SOCKET_IFNAME=lo HOROVOD_GLOO_RENDEZVOUS_ADDR=1.1.1.1 HOROVOD_GLOO_RENDEZVOUS_PORT=2222 HOROVOD_CPU_OPERATIONS=gloo HOROVOD_GLOO_IFACE=lo HOROVOD_CONTROLLER=gloo python train.py 具体代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 def _slot_info_to_command_fn(run_command, env): # TODO: Workaround for over-buffered outputs. Investigate how mpirun avoids this problem. env = copy.copy(env) # copy env so we do not leak env modifications env['PYTHONUNBUFFERED'] = '1' def slot_info_to_command(slot_info): \"\"\" Given a slot_info, creates a command used by gloo to launch a single job. :param slot_info: host and slot to execute the run command on :return: \"\"\" env_vars = create_slot_env_vars(slot_info) horovod_rendez_env = \" \".join( [f\"{k}={str(v)}\" for k, v in env_vars.items()]) return '{horovod_env} {env} {run_command}' .format( horovod_env=horovod_rendez_env, env=' '.join(['%s=%s' % (key, quote(value)) for key, value in env.items() if env_util.is_exportable(key)]), run_command=run_command) return slot_info_to_command 4.5.4 多线程调用命令 这就是启动了多线程进行调用。gloo_run 的注释说的很清楚：在调用 execute_function_multithreaded 时，每一个thread将使用 ssh 命令在远程host之上启动训练job。\n回忆下之前我们在“构建可执行环境” 中提到：利用 get_remote_command 来生成相关远程可运行环境，比如在训练脚本前面加上 ‘ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no’。大家就理解了如何在远端执行。\n在本地运行，则命令大致为：\n1 2 3 4 5 cd /code directory \u003e /dev/null 2 \u003e\u00261 HOROVOD_HOSTNAME=1.1.1.1 HOROVOD_RANK=1 HOROVOD_SIZE=2 HOROVOD_LOCAL_RANK=1 SHELL=/bin/bash PATH=XXXX USER=xxx PWD=xxx SSH_CONNECTION=\"1.1.1.1 11 2.2.2.2 22\" HOME=xxx SSH_CLIENZT=xxxx HOROVOD_GLOO_IFACE=lo NCCL_SOCKET_IFNAME=lo HOROVOD_GLOO_RENDEZVOUS_ADDR=1.1.1.1 HOROVOD_GLOO_RENDEZVOUS_PORT=2222 HOROVOD_CPU_OPERATIONS=gloo HOROVOD_GLOO_IFACE=lo HOROVOD_CONTROLLER=gloo python train.py 在远端运行，命令就需要加上 ssh 信息，大致为：\n1 2 3 4 5 6 ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no 1.1.1.1 cd /code directory \u003e /dev/null 2 \u003e\u00261 HOROVOD_HOSTNAME=1.1.1.1 HOROVOD_RANK=1 HOROVOD_SIZE=2 HOROVOD_LOCAL_RANK=1 SHELL=/bin/bash PATH=XXXX USER=xxx PWD=xxx SSH_CONNECTION=\"1.1.1.1 11 2.2.2.2 22\" HOME=xxx SSH_CLIENZT=xxxx HOROVOD_GLOO_IFACE=lo NCCL_SOCKET_IFNAME=lo HOROVOD_GLOO_RENDEZVOUS_ADDR=1.1.1.1 HOROVOD_GLOO_RENDEZVOUS_PORT=2222 HOROVOD_CPU_OPERATIONS=gloo HOROVOD_GLOO_IFACE=lo HOROVOD_CONTROLLER=gloo python train.py execute_function_multithreaded 具体代码如下，其中：\nfn 就是前面提到的程序运行环境（能力）exec_command。 fn(*arg[:-1]) 就是在 exec_command 之中运行slot_info_to_command。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 def execute_function_multithreaded(fn, args_list, block_until_all_done=True, max_concurrent_executions=1000): \"\"\" Executes fn in multiple threads each with one set of the args in the args_list. :param fn: function to be executed :type fn: :param args_list: :type args_list: list(list) :param block_until_all_done: if is True, function will block until all the threads are done and will return the results of each thread's execution. :type block_until_all_done: bool :param max_concurrent_executions: :type max_concurrent_executions: int :return: If block_until_all_done is False, returns None. If block_until_all_done is True, function returns the dict of results. { index: execution result of fn with args_list[index] } :rtype: dict \"\"\" result_queue = queue.Queue() worker_queue = queue.Queue() for i, arg in enumerate(args_list): arg.append(i) worker_queue.put(arg) def fn_execute(): while True: try: arg = worker_queue.get(block=False) except queue.Empty: return exec_index = arg[-1] # fn 就是前面提到的程序运行环境（能力）exec_command # fn(*arg[:-1])是在 exec_command 之中运行 slot_info_to_command res = fn(*arg[:-1]) result_queue.put((exec_index, res)) threads = [] number_of_threads = min(max_concurrent_executions, len(args_list)) # 在多线程中执行 fn_execute for _ in range(number_of_threads): thread = in_thread(target=fn_execute, daemon=not block_until_all_done) threads.append(thread) # Returns the results only if block_until_all_done is set. # 如果有设置，则 block 等待 results = None if block_until_all_done: # Because join() cannot be interrupted by signal, a single join() # needs to be separated into join()s with timeout in a while loop. have_alive_child = True while have_alive_child: have_alive_child = False for t in threads: t.join(0.1) if t.is_alive(): have_alive_child = True results = {} while not result_queue.empty(): item = result_queue.get() results[item[0]] = item[1] return results python train.py 就会进入到我们的训练代码。\n大致逻辑如下图，可以看到，结合了各种信息之后，构建了一个可以执行的结果，然后多host执行：\n图左面，是从 参数中获取 host 等信息，然后解析出 slot 信息； 图右边，是从 python train.py 这个待运行的命令，基于各种配置来生成可以执行命令环境。如果是远程，就得生成 相关远程可运行命令环境（包括切换目录，远程执行等等）； 图中间，是从 python train.py 这个待运行的命令，经过添加 env 信息，gloo 信息。然后结合 左面的 slot 信息 和 右面 的可以执行命令环境 之后，得到了可以在多线程上运行，从而在 多slot 运行的命令。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 args : '10.11.11.11:4,10.11.11.12:4' python train.py command : python train.py + + + | | | | | | v v v +----------+--------+ +----------+----------+ +---------+-------------+ | parse_hosts | | get_run_command | | | +----------+--------+ | | | get_remote_command | | +----------+----------+ | | | | +---------+-------------+ v | | +------------+-----------+ v | | get_host_assignments | v | | gloo python train.py +------------+-----------+ + ssh -o ... python train.py | | + | | | v | | | | SlotInfo(hostname='h2', rank=1) v v + +-----------+---------------+ +---------+--------------+ | | _slot_info_to_command_fn | |safe_shell_exec.execute | +-----------------------\u003e | | | | +-----------+---------------+ +---------+--------------+ | | | | v | | HOROVOD_CONTROLLER=gloo python train.py | + | | | | | v | +-------------+-------------------+ | | | | | execute_function_multithreaded | \u003c---------------+ | | +---------------------------------+ 图示如下：\n4.6 C++举例 我们给出一个底层代码，大家就进一步了解 Gloo 可以起到什么作用。\n这个就是 Horovod 之中，rank 0 最终给其他 rank 发送构建好的 Tensor。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 void GlooController::SendFinalTensors(ResponseList\u0026 response_list) { // Notify all nodes which tensors we'd like to reduce at this step. std::string encoded_response; ResponseList::SerializeToString(response_list, encoded_response); // Boardcast the response length int encoded_response_length = (int)encoded_response.length() + 1; { gloo::BroadcastOptions opts(gloo_context_.ctx); opts.setOutput(\u0026encoded_response_length, 1); opts.setRoot(RANK_ZERO); gloo::broadcast(opts); // 广播给其他rank } // Boardcast the response { gloo::BroadcastOptions opts(gloo_context_.ctx); opts.setOutput((uint8_t*)(encoded_response.c_str()), encoded_response_length); opts.setRoot(RANK_ZERO); gloo::broadcast(opts); // 广播给其他rank } } 5 Mpi 实现 5.1 openmpi 库 horovod 这里主要依赖 openmpi。\nMPI：英文全称是Message Passing Interface，MPI是一个跨语言的通讯协议，用于编写并行计算机。支持点对点和广播。MPI是一个信息传递应用程序接口，包括协议和和语义说明，他们指明其如何在各种实现中发挥其特性。MPI的目标是高性能，大规模性，和可移植性。 openMPI：英文全称是open Message Passing Interface。openMPI是MPI的一种实现，一种库项目。 MPI在Hovorod的角色比较特殊：\n一方面Horovod内集成了基于MPI的AllReduce，类似于NCCL，都是用作梯度规约；\n另一方面，MPI可以用来在所有机器上启动多个进程(Hovorod里用Rank表示)，实现并行计算；\n5.2 mpi_run 函数 此部分代码位于：horovod/runner/mpi_run.py。\n首先摘录其关键代码如下，可以看出来其核心是运行 mpirun 命令。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # 我是下面大段代码中的关键代码！ mpirun_command = ( 'mpirun {basic_args} ' '-np {num_proc}{ppn_arg}{hosts_arg} ' '{binding_args} ' '{mpi_args} ' '{mpi_ssh_args} ' '{tcp_intf_arg} ' '{nccl_socket_intf_arg} ' '{output_filename_arg} ' '{env} {extra_mpi_args} {command}' .format(basic_args=basic_args, num_proc=settings.num_proc, ppn_arg=ppn_arg, hosts_arg=hosts_arg, binding_args=binding_args, mpi_args=' '.join(mpi_impl_flags), tcp_intf_arg=tcp_intf_arg, nccl_socket_intf_arg=nccl_socket_intf_arg, mpi_ssh_args=mpi_ssh_args, output_filename_arg=' '.join(output), env=env_list, extra_mpi_args=settings.extra_mpi_args if settings.extra_mpi_args else '', command=' '.join(quote(par) for par in command)) ) # Execute the mpirun command. if settings.run_func_mode: exit_code = safe_shell_exec.execute(mpirun_command, env=env, stdout=stdout, stderr=stderr) else: os.execve('/bin/sh', ['/bin/sh', '-c', mpirun_command], env) 就是依据各种配置以及参数来构建 mpirun 命令的所有参数，比如 ssh 的参数，mpi 参数，nccl 参数等等。\n最后得到的 mpirun 命令举例如下：\n1 2 3 4 mpirun --allow-run-as-root --np 2 -bind-to none -map-by slot \\ -x NCCL_DEBUG=INFO -x LD_LIBRARY_PATH -x PATH \\ -mca pml ob1 -mca btl ^openib \\ python train.py 具体代码如下，具体是：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 # 上面代码是我之中的片段 def mpi_run(settings, nics, env, command, stdout=None, stderr=None): \"\"\" Runs mpi_run. Args: settings: Settings for running MPI. Note: settings.num_proc and settings.hosts must not be None. nics: Interfaces to include by MPI. env: Environment dictionary to use for running command. command: Command and arguments to run as a list of string. stdout: Stdout of the mpi process. Only used when settings.run_func_mode is True. stderr: Stderr of the mpi process. Only used when settings.run_func_mode is True. \"\"\" # 得到各种配置 mpi_impl_flags, impl_binding_args, mpi = _get_mpi_implementation_flags(settings.tcp_flag, env=env) impi = _IMPI_IMPL == mpi # 处理ssh参数 ssh_args = [] if settings.ssh_port: ssh_args += [f'-p {settings.ssh_port}'] if settings.ssh_identity_file: ssh_args += [f'-i {settings.ssh_identity_file}'] mpi_ssh_args = '' if ssh_args: joined_ssh_args = ' '.join(ssh_args) mpi_ssh_args = f'-bootstrap=ssh -bootstrap-exec-args \\\"{joined_ssh_args}\\\"' if impi else f'-mca plm_rsh_args \\\"{joined_ssh_args}\\\"' # 处理网络配置，网卡信息等 tcp_intf_arg = '-mca btl_tcp_if_include {nics}'.format( nics=','.join(nics)) if nics and not impi else '' nccl_socket_intf_arg = '-{opt} NCCL_SOCKET_IFNAME={nics}'.format( opt='genv' if impi else 'x', nics=','.join(nics)) if nics else '' # 处理host信息 # On large cluster runs (e.g. Summit), we need extra settings to work around OpenMPI issues host_names, host_to_slots = hosts.parse_hosts_and_slots(settings.hosts) if not impi and host_names and len(host_names) \u003e= _LARGE_CLUSTER_THRESHOLD: mpi_impl_flags.append('-mca plm_rsh_no_tree_spawn true') mpi_impl_flags.append('-mca plm_rsh_num_concurrent {}'.format(len(host_names))) # if user does not specify any hosts, mpirun by default uses local host. # There is no need to specify localhost. hosts_arg = '-{opt} {hosts}'.format(opt='hosts' if impi else 'H', hosts=','.join(host_names) if host_names and impi else settings.hosts) # 处理ppn配置 ppn_arg = ' ' if host_to_slots and impi: ppn = host_to_slots[host_names[0]] for h_name in host_names[1:]: ppn_arg = ' -ppn {} '.format(ppn) # 处理超时配置 if settings.prefix_output_with_timestamp and not impi: mpi_impl_flags.append('--timestamp-output') binding_args = settings.binding_args if settings.binding_args and not impi else ' '.join(impl_binding_args) # 配置需要root身份运行 basic_args = '-l' if impi else '--allow-run-as-root --tag-output' output = [] if settings.output_filename: output.append('-outfile-pattern' if impi else '--output-filename') output.append(settings.output_filename) # 构建环境信息列表 env_list = '' if impi else ' '.join( '-x %s' % key for key in sorted(env.keys()) if env_util.is_exportable(key)) # 构建最终的 MPI 命令 # Pass all the env variables to the mpirun command. mpirun_command = ( 'mpirun {basic_args} ' '-np {num_proc}{ppn_arg}{hosts_arg} ' '{binding_args} ' '{mpi_args} ' '{mpi_ssh_args} ' '{tcp_intf_arg} ' '{nccl_socket_intf_arg} ' '{output_filename_arg} ' '{env} {extra_mpi_args} {command}' # expect a lot of environment variables .format(basic_args=basic_args, num_proc=settings.num_proc, ppn_arg=ppn_arg, hosts_arg=hosts_arg, binding_args=binding_args, mpi_args=' '.join(mpi_impl_flags), tcp_intf_arg=tcp_intf_arg, nccl_socket_intf_arg=nccl_socket_intf_arg, mpi_ssh_args=mpi_ssh_args, output_filename_arg=' '.join(output), env=env_list, extra_mpi_args=settings.extra_mpi_args if settings.extra_mpi_args else '', command=' '.join(quote(par) for par in command)) ) # we need the driver's PATH and PYTHONPATH in env to run mpirun, # env for mpirun is different to env encoded in mpirun_command for var in ['PATH', 'PYTHONPATH']: if var not in env and var in os.environ: # copy env so we do not leak env modifications env = copy.copy(env) # copy var over from os.environ env[var] = os.environ[var] # Execute the mpirun command. if settings.run_func_mode: exit_code = safe_shell_exec.execute(mpirun_command, env=env, stdout=stdout, stderr=stderr) else: os.execve('/bin/sh', ['/bin/sh', '-c', mpirun_command], env) 5.3 mpirun命令 因为 mpi_run 使用的是 mpirun 命令来运行，所以我们介绍一下。\nmpirun是MPI程序的启动脚本，它简化了并行进程的启动过程，尽可能屏蔽了底层的实现细节，从而为用户提供了一个通用的MPI并行机制。\n在用mpirun命令执行并行程序时，参数-np指明了需要并行运行的进程个数。mpirun首先在本地结点上启动一个进程，然后根据/usr/local/share/machines.LINUX文件中所列出的主机，为每个主机启动一个进程。若进程数比可用的并行节点数多，则多余的进程将重新按照上述规则进行。按这个机制分配好进程后，一般会给每个节点分一个固定的标号，类似于身份证了，后续在消息传递中会用到。\n这里需要说明的是，实际运行的\norterun(Open MPI SPMD / MPMD启动器; mpirun / mpiexec只是它的符号链接)\n命令举例如下：\n1 2 3 4 5 mpirun -np 4 \\ -bind-to none -map-by slot \\ -x NCCL_DEBUG=INFO -x LD_LIBRARY_PATH -x PATH \\ -mca pml ob1 -mca btl ^openib \\ python train.py 6 总结 对比 gloo 和 mpi 的实现，我们还是能看出来区别。\n6.1 gloo gloo 只是一个库，需要 horovod 来完成命令分发功能。\ngloo 需要 horovod 自己实现本地运行和远端运行方式，即 get_remote_command 函数 实现 'ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no'。\ngloo 需要实现 RendezvousServer，底层会利用 RendezvousServer 进行通讯。\n6.2 mpi mpi 则功能强大很多，只要把命令配置成被 mpirun 包装，openmpi 就可以自行完成命令分发执行。说到底，horovod 是一个 mpirun 程序，即使运行了 tensor flow，也是一个mpi程序，可以互相交互。\n",
  "wordCount" : "10891",
  "inLanguage": "en",
  "datePublished": "2022-10-09T10:49:10+08:00",
  "dateModified": "2022-10-09T10:49:10+08:00",
  "author":[{
    "@type": "Person",
    "name": "Jian"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jianye0428.github.io/en/posts/notes/2022-10-09_horovod_3/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jian's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jianye0428.github.io/favicon/jian_icon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jianye0428.github.io/en/" accesskey="h" title="Jian&#39;s Blog (Alt + H)">
                <img src="https://jianye0428.github.io/favicon/jian_icon.png" alt="logo" aria-label="logo"
                    height="30">Jian&#39;s Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://jianye0428.github.io/cn/" title="Chinese"
                            aria-label="Chinese">Chinese</a>
                    </li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jianye0428.github.io/en/myresume/" title="My Resume">
                    <span>My Resume</span>
                </a>
            </li>
            <li>
                <a href="https://jianye0428.github.io/en/tags/" title="🔖Tags">
                    <span>🔖Tags</span>
                </a>
            </li>
            <li>
                <a href="https://jianye0428.github.io/en/archives" title="🙋🏻‍♂️Archive">
                    <span>🙋🏻‍♂️Archive</span>
                </a>
            </li>
            <li>
                <a href="https://jianye0428.github.io/en/search/" title="🔍Search (Alt &#43; /)" accesskey=/>
                    <span>🔍Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://jianye0428.github.io/en/">Home</a>&nbsp;»&nbsp;<a href="https://jianye0428.github.io/en/posts/">Posts</a></div>
    <h1 class="post-title">
      深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么
    </h1>
    <div class="post-meta"><span title='2022-10-09 10:49:10 +0800 CST'>2022-10-09</span>&nbsp;·&nbsp;22 min&nbsp;·&nbsp;Jian&nbsp;|&nbsp;<a href="https://github.com/jianye0428/myblog/tree/main/content/posts/notes/2022-10-09_Horovod_3.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0-%e6%91%98%e8%a6%81" aria-label="0 摘要">0 摘要</a></li>
                    <li>
                        <a href="#1-%e8%83%8c%e6%99%af%e7%9f%a5%e8%af%86" aria-label="1 背景知识">1 背景知识</a><ul>
                            
                    <li>
                        <a href="#11-%e5%88%86%e5%b8%83%e5%bc%8f%e4%bd%93%e7%b3%bb" aria-label="1.1 分布式体系">1.1 分布式体系</a></li>
                    <li>
                        <a href="#12-%e5%b9%b6%e8%a1%8c%e4%bb%bb%e5%8a%a1%e9%80%9a%e4%bf%a1" aria-label="1.2 并行任务通信">1.2 并行任务通信</a></li>
                    <li>
                        <a href="#13-mpi" aria-label="1.3 MPI">1.3 MPI</a></li>
                    <li>
                        <a href="#14-open-mpi" aria-label="1.4 Open-MPI">1.4 Open-MPI</a></li>
                    <li>
                        <a href="#15-mpi-%e4%bd%bf%e7%94%a8%e9%97%ae%e9%a2%98" aria-label="1.5 MPI 使用问题">1.5 MPI 使用问题</a></li></ul>
                    </li>
                    <li>
                        <a href="#2-%e5%85%a5%e5%8f%a3%e7%82%b9" aria-label="2 入口点">2 入口点</a><ul>
                            
                    <li>
                        <a href="#21-%e5%a6%82%e4%bd%95%e8%bf%90%e8%a1%8c" aria-label="2.1 如何运行">2.1 如何运行</a></li>
                    <li>
                        <a href="#22-horovodrun" aria-label="2.2 horovodrun">2.2 horovodrun</a></li>
                    <li>
                        <a href="#23-run_commandline" aria-label="2.3 run_commandline">2.3 run_commandline</a></li>
                    <li>
                        <a href="#24-%e9%9d%9e%e5%bc%b9%e6%80%a7%e8%ae%ad%e7%bb%83-_run_static" aria-label="2.4 非弹性训练 _run_static()">2.4 非弹性训练 _run_static()</a></li></ul>
                    </li>
                    <li>
                        <a href="#3-%e8%bf%90%e8%a1%8c%e8%ae%ad%e7%bb%83-job" aria-label="3 运行训练 Job">3 运行训练 Job</a><ul>
                            
                    <li>
                        <a href="#31-_launch_job" aria-label="3.1 _launch_job">3.1 _launch_job</a></li>
                    <li>
                        <a href="#32-run_controller" aria-label="3.2 run_controller">3.2 run_controller</a></li></ul>
                    </li>
                    <li>
                        <a href="#4-gloo-%e5%ae%9e%e7%8e%b0" aria-label="4 Gloo 实现">4 Gloo 实现</a><ul>
                            
                    <li>
                        <a href="#41-gloo-%e7%ae%80%e4%bb%8b" aria-label="4.1 Gloo 简介">4.1 Gloo 简介</a></li>
                    <li>
                        <a href="#42-rendezvous-%e5%8a%9f%e8%83%bd" aria-label="4.2 Rendezvous 功能">4.2 Rendezvous 功能</a><ul>
                            
                    <li>
                        <a href="#421-rendezvous-%e6%a6%82%e5%bf%b5" aria-label="4.2.1 Rendezvous 概念">4.2.1 Rendezvous 概念</a></li>
                    <li>
                        <a href="#422-rendezvousserver" aria-label="4.2.2 RendezvousServer">4.2.2 RendezvousServer</a></li>
                    <li>
                        <a href="#423-kvstore" aria-label="4.2.3 KVStore">4.2.3 KVStore</a></li>
                    <li>
                        <a href="#424-%e5%ba%95%e5%b1%82%e4%bd%bf%e7%94%a8" aria-label="4.2.4 底层使用">4.2.4 底层使用</a></li></ul>
                    </li>
                    <li>
                        <a href="#43-horovd-%e7%9a%84-gloo-%e5%85%a5%e5%8f%a3" aria-label="4.3 Horovd 的 gloo 入口">4.3 Horovd 的 gloo 入口</a></li>
                    <li>
                        <a href="#44-%e6%9e%84%e5%bb%ba%e5%8f%af%e6%89%a7%e8%a1%8c%e7%8e%af%e5%a2%83" aria-label="4.4 构建可执行环境">4.4 构建可执行环境</a><ul>
                            
                    <li>
                        <a href="#441-_exec_command_fn" aria-label="4.4.1 _exec_command_fn">4.4.1 _exec_command_fn</a></li>
                    <li>
                        <a href="#442-get_remote_command" aria-label="4.4.2 get_remote_command">4.4.2 get_remote_command</a></li></ul>
                    </li>
                    <li>
                        <a href="#45-%e4%bd%bf%e7%94%a8-gloo-%e6%89%a7%e8%a1%8c%e5%91%bd%e4%bb%a4" aria-label="4.5 使用 gloo 执行命令">4.5 使用 gloo 执行命令</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#4512-%e5%88%86%e9%85%8d%e6%96%b9%e6%a1%88" aria-label="4.5.1.2 分配方案">4.5.1.2 分配方案</a></li></ul>
                        
                    <li>
                        <a href="#452-%e5%be%97%e5%88%b0%e8%bf%90%e8%a1%8c%e5%91%bd%e4%bb%a4" aria-label="4.5.2 得到运行命令">4.5.2 得到运行命令</a></li>
                    <li>
                        <a href="#453-%e5%be%97%e5%88%b0slot%e8%bf%90%e8%a1%8c%e5%91%bd%e4%bb%a4" aria-label="4.5.3 得到slot运行命令">4.5.3 得到slot运行命令</a></li>
                    <li>
                        <a href="#454-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e8%b0%83%e7%94%a8%e5%91%bd%e4%bb%a4" aria-label="4.5.4 多线程调用命令">4.5.4 多线程调用命令</a></li></ul>
                    </li>
                    <li>
                        <a href="#46-c%e4%b8%be%e4%be%8b" aria-label="4.6 C&#43;&#43;举例">4.6 C++举例</a></li></ul>
                    </li>
                    <li>
                        <a href="#5-mpi-%e5%ae%9e%e7%8e%b0" aria-label="5 Mpi 实现">5 Mpi 实现</a><ul>
                            
                    <li>
                        <a href="#51-openmpi-%e5%ba%93" aria-label="5.1 openmpi 库">5.1 openmpi 库</a></li>
                    <li>
                        <a href="#52-mpi_run-%e5%87%bd%e6%95%b0" aria-label="5.2 mpi_run 函数">5.2 mpi_run 函数</a></li>
                    <li>
                        <a href="#53-mpirun%e5%91%bd%e4%bb%a4" aria-label="5.3 mpirun命令">5.3 mpirun命令</a></li></ul>
                    </li>
                    <li>
                        <a href="#6-%e6%80%bb%e7%bb%93" aria-label="6 总结">6 总结</a><ul>
                            
                    <li>
                        <a href="#61-gloo" aria-label="6.1 gloo">6.1 gloo</a></li>
                    <li>
                        <a href="#62-mpi" aria-label="6.2 mpi">6.2 mpi</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><p>references:
[1]. <a href="https://www.cnblogs.com/rossiXYZ/p/14881812.html">https://www.cnblogs.com/rossiXYZ/p/14881812.html</a></p>
<h2 id="0-摘要">0 摘要<a hidden class="anchor" aria-hidden="true" href="#0-摘要">#</a></h2>
<p>Horovod 是Uber于2017年发布的一个易于使用的高性能的分布式训练框架，在业界得到了广泛应用。</p>
<p>本系列将通过源码分析来带领大家了解 Horovod。本文是系列第三篇，从 python 开始进入 Horovod 世界，看看 Horovodrun 做了什么。</p>
<p>前两篇链接如下：</p>
<p><a href="https://www.cnblogs.com/rossiXYZ/p/14856464.html">深度学习分布式训练框架 Horovod (1) &mdash; 基础知识</a></p>
<p><a href="https://www.cnblogs.com/rossiXYZ/p/14856543.html">深度学习分布式训练框架 horovod (2) &mdash; 从使用者角度切入</a></p>
<h2 id="1-背景知识">1 背景知识<a hidden class="anchor" aria-hidden="true" href="#1-背景知识">#</a></h2>
<p>首先介绍一些相关背景知识。</p>
<h3 id="11-分布式体系">1.1 分布式体系<a hidden class="anchor" aria-hidden="true" href="#11-分布式体系">#</a></h3>
<p>在设计并行计算机时，<u>最直接的方式就是<mark>多个计算单元共享一个内存</mark></u>。共享内存的编程在数据交换和访问上有较大的优势，程序编写起来更加简单。<font color=red>但在扩展性上有较大的瓶颈</font>。</p>
<p>另一种方式为<font color=red><strong>分布式内存</strong></font>。即<u>每个计算单元有单独的内存，计算单元之间的数据访问通过互联网络去传输</u>。这一架构在可移植性和扩展上会强很多，但<u>消息的传递</u>会成为程序设计中的难点。</p>
<p>将这两点结合，即是<u><font color=red><strong>分布式共享内存并行计算机的架构</strong></font></u>，也是当今最常用的体系结构。</p>
<h3 id="12-并行任务通信">1.2 并行任务通信<a hidden class="anchor" aria-hidden="true" href="#12-并行任务通信">#</a></h3>
<p>并行任务通信一般分为<font color=red><strong>P2P</strong>(Point-to-point communication)</font>和 <font color=red><strong>Collective communication</strong></font>。</p>
<ul>
<li>P2P通信这种模式只有一个sender和一个receiver，即点到点通信.</li>
<li>Collective communication含多个sender多个receive</li>
</ul>
<p>Collective communication包含一些常见的原语</p>
<ul>
<li>broadcast</li>
<li>reduce，allreduce</li>
<li>scatter，scatter reduce</li>
<li>gather，allgather</li>
<li>ring-base collectives</li>
<li>ring-allreduce</li>
</ul>
<p>传统Collective communication假设通信节点组成的topology是一颗fat tree，这样通信效率最高。但实际的通信topology可能比较复杂，并不是一个fat tree。因此一般用<mark><strong>ring-based Collective communication</strong></mark>。</p>
<h3 id="13-mpi">1.3 MPI<a hidden class="anchor" aria-hidden="true" href="#13-mpi">#</a></h3>
<p><mark>MPI(Message Passing Interface)</mark> 是一种可以支持点对点和广播的通信协议，具体实现的库有很多，使用比较流行的包括 Open Mpi， Intel MPI 等等。</p>
<p>MPI 是一种<u>消息传递编程模型</u>。消息传递指用户必须通过显式地发送和接收消息来实现处理器间的数据交换。在这种并行编程中，<font color=red>每个控制流均有自己独立的地址空间，不同的控制流之间不能直接访问彼此的地址空间，必须通过显式的消息传递来实现</font>。这种编程方式是<mark>大规模并行处理机(MPP)</mark>和<mark>机群(Cluster)</mark>采用的主要编程方式。由于消息传递程序设计要求用户很好地分解问题，组织不同控制流间的数据交换，并行计算粒度大，特别适合于大规模可扩展并行算法。</p>
<p>MPI 是<mark>基于进程的并行环境。进程拥有独立的虚拟地址空间和处理器调度，并且执行相互独立</mark>。MPI 设计为支持通过网络连接的机群系统，且通过消息传递来实现通信，消息传递是 MPI 的最基本特色。</p>
<h3 id="14-open-mpi">1.4 Open-MPI<a hidden class="anchor" aria-hidden="true" href="#14-open-mpi">#</a></h3>
<p>OpenMPI 是一种高性能消息传递库，最初是作为融合的技术和资源从其他几个项目（FT-MPI， LA-MPI， LAM/MPI， 以及 PACX-MPI），它是 MPI-2 标准的一个开源实现，由一些科研机构和企业一起开发和维护。因此，OpenMPI 能够从高性能社区中获得专业技术、工业技术和资源支持，来创建最好的 MPI 库。OpenMPI 提供给系统和软件供应商、程序开发者和研究人员很多便利。易于使用，并运行本身在各种各样的操作系统，网络互连，以及一批/调度系统。</p>
<h3 id="15-mpi-使用问题">1.5 MPI 使用问题<a hidden class="anchor" aria-hidden="true" href="#15-mpi-使用问题">#</a></h3>
<p>因为MPI是<u>分布式内存编程</u>，在后面的开发中涉及节点间信息的传递。往往数据和程序是在多个节点上，所以需要保证执行命令时各节点之间信息的交换。</p>
<p>具体使用之中，就有两个问题:</p>
<ul>
<li>这个多台机器Open-MPI是如何发现并建立连接的呢？</li>
<li>多机多卡在训练过程中，传输环如何建立，这个也是决定了训练效率，那么Open-MPI如何去做呢？</li>
</ul>
<p>关于第一个问题：</p>
<p>设置<font color=red>SSH免密登录</font>可以免去操作中密码的输入。各节点生成私钥和公钥后需要认证，此时可以保证本机免密登录。将各个子节点的公钥文件发送给主节点，然后分别加入到主节点的认证文件中，此时可以保证主节点对各个子节点的免密登录。最后将认证文件传回到每个子节点，从而保证各个子节点对其他节点之间的免密登录。</p>
<p>在 Open-MPI 启动的时候，可以指定<code>--hostfile</code>或者<code>--host</code>去指定要运行任务的 IP 或 Hostname，这样 Open-MPI 就会试图通过 ssh 免秘钥的方式试图去链接对方机器，并执行一系列命令，主要是为了<strong>同步环境变量、当前路径以及下发启动命令</strong>。</p>
<p>当然用户也可以通过其他方式给远程机器下发命令，这个可以通过环境变量<code>OMPI_MCA_plm_rsh_agent</code>指定。</p>
<p>关于第二个问题：</p>
<p>当所有的机器建立好连接，准备开始计算，为了能够最高效的去通信，Open-MPI中集成了组件——<a href="https://github.com/open-mpi/hwloc">hwloc</a>。该组件主要是<font color=red><strong>为了单机硬件资源拓扑构建，进而构建最短路径通信</strong></font>。</p>
<h2 id="2-入口点">2 入口点<a hidden class="anchor" aria-hidden="true" href="#2-入口点">#</a></h2>
<p>很多机器学习框架都会采用如下套路：shell脚本（可选），python端 和 C++端。</p>
<ul>
<li>Shell脚本是启动运行的入口，负责解析参数，确认并且调用训练程序；</li>
<li>Python是用户的接口，引入了C++库，封装了API，负责运行时和底层C++交互；</li>
<li>C++实现底层训练逻辑；</li>
</ul>
<p>以我们先看看 hordovodrun 脚本。</p>
<h3 id="21-如何运行">2.1 如何运行<a hidden class="anchor" aria-hidden="true" href="#21-如何运行">#</a></h3>
<p>官方给出的 Hovorod 运行范例之一如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">horovodrun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">2</span> <span class="o">-</span><span class="n">H</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">4</span> <span class="o">--</span><span class="n">gloo</span> <span class="n">python</span> <span class="o">/</span><span class="n">horovod</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">tensorflow2</span><span class="o">/</span><span class="n">tensorflow2_mnist</span><span class="o">.</span><span class="n">py</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里 -np 指的是<strong>进程的数量</strong>，localhost:4<strong>表示localhost节点上4个GPU</strong>。</p>
<p>注意，如果虚拟机只有一个核。想要强行地达到并行的效果，可以使用 -np参数，它会自动帮你把一个核心切成多份处理器，每一个分布式处理就是一个slot。</p>
<p>因此，我们可以从 horovodrun 这个命令入手看看。</p>
<h3 id="22-horovodrun">2.2 horovodrun<a hidden class="anchor" aria-hidden="true" href="#22-horovodrun">#</a></h3>
<p>入口文件可以从 setup.py 看到，其就被映射成 horovod.runner.launch:run_commandline。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">entry_points</span><span class="o">={</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;console_scripts&#39;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;horovodrun = horovod.runner.launch:run_commandline&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以我们看看 run_commandline</p>
<h3 id="23-run_commandline">2.3 run_commandline<a hidden class="anchor" aria-hidden="true" href="#23-run_commandline">#</a></h3>
<p>该命令位于：horovod-master/horovod/runner/launch.py，我们摘录重要部分。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_commandline</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">_run</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>于是进入到 _run 函数。可以看到，Horovod 会依据是否是弹性训练来选择不同的路径。我们在此系列中，会首先分析 非弹性训练 _run_static。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># if hosts are not specified, either parse from hostfile, or default as</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># localhost</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">hosts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">host_discovery_script</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">hostfile</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="n">hosts</span><span class="o">.</span><span class="n">parse_host_files</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hostfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Set hosts to localhost if not specified</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="s1">&#39;localhost:</span><span class="si">{np}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert nics into set</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="o">.</span><span class="n">nics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">nics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nics</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">_is_elastic</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_run_elastic</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_run_static</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="c1"># 我们先看这里</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-非弹性训练-_run_static">2.4 非弹性训练 _run_static()<a hidden class="anchor" aria-hidden="true" href="#24-非弹性训练-_run_static">#</a></h3>
<p>在 _run_static 之中做了如下操作：</p>
<ul>
<li>首先解析各种参数，得到 settings；</li>
<li>会调用 <code>driver_service.get_common_interfaces</code> 获取网卡以及其他host的信息，依据这些信息会进行slot分配，这部分很复杂，具体我们会有专文讲解（下一篇）。</li>
<li>这里有一个问题：为什么要得到 host, slot, rank 之间的关系信息？由于工程上的考虑，底层 C++ 世界中对于 rank 的角色做了区分：<code>rank 0</code> 是 master，<code>rank n</code> 是 worker，所以这些信息需要决定并且传递给 C++世界；</li>
<li>会根据是否在参数中传递运行函数来决定采取何种路径，一般默认没有运行参数，所以会执行_launch_job 来启动训练 job；</li>
</ul>
<p>具体代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_run_static</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">settings</span> <span class="o">=</span> <span class="n">hvd_settings</span><span class="o">.</span><span class="n">Settings</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">2</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">ssh_port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ssh_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">ssh_identity_file</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ssh_identity_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">extra_mpi_args</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">mpi_args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">tcp_flag</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tcp_flag</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">binding_args</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">binding_args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">key</span><span class="o">=</span><span class="n">secret</span><span class="o">.</span><span class="n">make_secret_key</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">start_timeout</span><span class="o">=</span><span class="n">tmout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">num_proc</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">hosts</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">hosts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">output_filename</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">run_func_mode</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">run_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">nics</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nics</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	  <span class="c1"># 首先解析各种参数，得到 settings</span>
</span></span><span class="line"><span class="cl">    <span class="n">fn_cache</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">disable_cache</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">params</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">hosts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">params</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hosts</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ssh_port</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">params</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ssh_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ssh_identity_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">params</span> <span class="o">+=</span> <span class="n">args</span><span class="o">.</span><span class="n">ssh_identity_file</span>
</span></span><span class="line"><span class="cl">        <span class="n">parameters_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">fn_cache</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">Cache</span><span class="p">(</span><span class="n">CACHE_FOLDER</span><span class="p">,</span> <span class="n">CACHE_STALENESS_THRESHOLD_MINUTES</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">parameters_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取网卡以及其他host的信息，依据这些信息会进行slot分配</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_host_names</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hosts</span><span class="o">.</span><span class="n">parse_hosts_and_slots</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hosts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">remote_host_names</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">filter_local_addresses</span><span class="p">(</span><span class="n">all_host_names</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nics</span> <span class="o">=</span> <span class="n">driver_service</span><span class="o">.</span><span class="n">get_common_interfaces</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">all_host_names</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">remote_host_names</span><span class="p">,</span> <span class="n">fn_cache</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">run_func</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># get the driver IPv4 address</span>
</span></span><span class="line"><span class="cl">        <span class="n">driver_ip</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">get_driver_ip</span><span class="p">(</span><span class="n">nics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_func_server</span> <span class="o">=</span> <span class="n">KVStoreServer</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="c1"># 启动内部KV服务器</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_func_server_port</span> <span class="o">=</span> <span class="n">run_func_server</span><span class="o">.</span><span class="n">start_server</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">put_data_into_kvstore</span><span class="p">(</span><span class="n">driver_ip</span><span class="p">,</span> <span class="n">run_func_server_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="s1">&#39;runfunc&#39;</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">run_func</span><span class="p">)</span> <span class="c1"># 把&#39;func&#39;, args.run_func存储成KV</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;horovod.runner.run_task&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">driver_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_func_server_port</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">_launch_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">np</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_data_from_kvstore</span><span class="p">(</span><span class="n">driver_ip</span><span class="p">,</span> <span class="n">run_func_server_port</span><span class="p">,</span><span class="s1">&#39;runfunc_result&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_func_server</span><span class="o">.</span><span class="n">shutdown_server</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span>
</span></span><span class="line"><span class="cl">        <span class="n">_launch_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span> <span class="c1"># 我们重点讲解这里</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>目前逻辑如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">              <span class="o">+-----------+</span>
</span></span><span class="line"><span class="cl">              <span class="o">|</span><span class="n">horovodrun</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">              <span class="o">+-----+-----+</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span><span class="line"><span class="cl">           <span class="o">+--------+--------+</span>
</span></span><span class="line"><span class="cl">           <span class="o">|</span> <span class="n">run_commandline</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">           <span class="o">+----+------+-----+</span>
</span></span><span class="line"><span class="cl">                <span class="o">|</span>      <span class="o">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">+---------+</span>      <span class="o">+--------+</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span>                         <span class="o">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span>                         <span class="o">|</span>
</span></span><span class="line"><span class="cl">      <span class="n">v</span>                         <span class="n">v</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+--------+</span>           <span class="o">+----+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">_run_elastic</span> <span class="o">|</span>           <span class="o">|</span> <span class="n">_run_static</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------+</span>           <span class="o">+-------------+</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，我们已经分析完成 horovod 的入口，下面会分析具体如何启动 Job。</p>
<h2 id="3-运行训练-job">3 运行训练 Job<a hidden class="anchor" aria-hidden="true" href="#3-运行训练-job">#</a></h2>
<h3 id="31-_launch_job">3.1 _launch_job<a hidden class="anchor" aria-hidden="true" href="#31-_launch_job">#</a></h3>
<p>_launch_job 会根据配置或者安装情况来进行具体调用。我们看到有三种可能：gloo, mpi, js。</p>
<p>jsrun的资料很难找，所以我们重点看看 gloo, mpi 这两种。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_launch_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">config_parser</span><span class="o">.</span><span class="n">set_env_from_args</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">gloo_run_fn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">driver_ip</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">get_driver_ip</span><span class="p">(</span><span class="n">nics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">gloo_run</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">driver_ip</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mpi_run_fn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">mpi_run</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">js_run_fn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">js_run</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">run_controller</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">use_gloo</span><span class="p">,</span> <span class="n">gloo_run_fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">args</span><span class="o">.</span><span class="n">use_mpi</span><span class="p">,</span> <span class="n">mpi_run_fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">args</span><span class="o">.</span><span class="n">use_jsrun</span><span class="p">,</span> <span class="n">js_run_fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-run_controller">3.2 run_controller<a hidden class="anchor" aria-hidden="true" href="#32-run_controller">#</a></h3>
<p>run_controller 依然是一个中介函数，具体导入 gloo 或者 mpi。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_controller</span><span class="p">(</span><span class="n">use_gloo</span><span class="p">,</span> <span class="n">gloo_run</span><span class="p">,</span> <span class="n">use_mpi</span><span class="p">,</span> <span class="n">mpi_run</span><span class="p">,</span> <span class="n">use_jsrun</span><span class="p">,</span> <span class="n">js_run</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">use_gloo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">gloo_run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">use_mpi</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mpi_run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">use_jsrun</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">js_run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mpi_built</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">lsf</span><span class="o">.</span><span class="n">LSFUtils</span><span class="o">.</span><span class="n">using_lsf</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_jsrun_installed</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">js_run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mpi_run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">gloo_built</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">gloo_run</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>目前逻辑如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">              <span class="o">+-----------+</span>
</span></span><span class="line"><span class="cl">              <span class="o">|</span><span class="n">horovodrun</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">              <span class="o">+-----+-----+</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="o">|</span>
</span></span><span class="line"><span class="cl">                    <span class="n">v</span>
</span></span><span class="line"><span class="cl">           <span class="o">+--------+--------+</span>
</span></span><span class="line"><span class="cl">           <span class="o">|</span> <span class="n">run_commandline</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">           <span class="o">+----+------+-----+</span>
</span></span><span class="line"><span class="cl">                <span class="o">|</span>      <span class="o">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">+---------+</span>      <span class="o">+--------+</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span>                         <span class="o">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span>                         <span class="o">|</span>
</span></span><span class="line"><span class="cl">      <span class="n">v</span>                         <span class="n">v</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+--------+</span>           <span class="o">+----+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">_run_elastic</span> <span class="o">|</span>           <span class="o">|</span> <span class="n">_run_static</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------+</span>           <span class="o">+------+------+</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">v</span>
</span></span><span class="line"><span class="cl">                           <span class="o">+------+------+</span>
</span></span><span class="line"><span class="cl">                           <span class="o">|</span> <span class="n">_launch_job</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                           <span class="o">|</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl">                           <span class="o">+------+------+</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">v</span>
</span></span><span class="line"><span class="cl">                        <span class="o">+---------+--------+</span>
</span></span><span class="line"><span class="cl">                        <span class="o">|</span>  <span class="n">run_controller</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl">                        <span class="o">|</span>                  <span class="o">|</span>
</span></span><span class="line"><span class="cl">                        <span class="o">+----+----+-----+--+</span>
</span></span><span class="line"><span class="cl">                             <span class="o">|</span>    <span class="o">|</span>     <span class="o">|</span>
</span></span><span class="line"><span class="cl">               <span class="o">+-------------+</span>    <span class="o">|</span>     <span class="o">+--------+</span>
</span></span><span class="line"><span class="cl">               <span class="o">|</span>                  <span class="o">|</span>              <span class="o">|</span>
</span></span><span class="line"><span class="cl">               <span class="o">|</span>                  <span class="o">|</span>              <span class="o">|</span>
</span></span><span class="line"><span class="cl">               <span class="n">v</span>                  <span class="n">v</span>              <span class="n">v</span>
</span></span><span class="line"><span class="cl">        <span class="o">+------+---+</span>       <span class="o">+------+----+</span>     <span class="o">+---+-----+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">gloo_run</span> <span class="o">|</span>       <span class="o">|</span>   <span class="n">mpi_run</span> <span class="o">|</span>     <span class="o">|</span> <span class="n">js_run</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>          <span class="o">|</span>       <span class="o">|</span>           <span class="o">|</span>     <span class="o">|</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl">        <span class="o">+----------+</span>       <span class="o">+-----------+</span>     <span class="o">+---------+</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>于是我们下面就分为两个分支介绍：gloo &amp; mpi。</p>
<h2 id="4-gloo-实现">4 Gloo 实现<a hidden class="anchor" aria-hidden="true" href="#4-gloo-实现">#</a></h2>
<h3 id="41-gloo-简介">4.1 Gloo 简介<a hidden class="anchor" aria-hidden="true" href="#41-gloo-简介">#</a></h3>
<p>Gloo 是 facebook出品的一个类似MPI的集合通信库（https://github.com/facebookincubator/gloo）。</p>
<p>集合通信库的主要特征是：大体上会遵照 MPI 提供的接口规定，实现了包括<strong>点对点通信</strong>（SEND,RECV等），<strong>集合通信</strong>（ REDUCE，BROADCAST，ALLREDUCE等）等相关接口，然后根据自己硬件或者是系统的需要，在底层实现上进行相应改动，保证接口的稳定和性能。</p>
<p>Gloo 为CPU和GPU提供了集合通信程序的优化实现。 它特别适用于GPU，因为它可以执行通信而无需使用GPUDirect 将数据传输到CPU的内存。 它还能够使用 NCCL 执行快速的节点内通信，并实现其自己的节点间例程计算。你不需要考虑内存数据的拷贝，只需要实现逻辑就可以。</p>
<p>Gloo 支持集合通信（collective Communication），并对其进行了优化。由于 GPU 之间可以直接进行数据交换，而无需经过 CPU 和内存，因此，在 GPU 上使用 <strong>gloo后端</strong>速度更快。</p>
<p>Horovod 为什么会选择 Gloo？个人认为除了其功能的全面性和性能之外，基于它可以二次开发是一个亮点，比如下面我们所说的 Rendezvous 功能就被 Horovod 用来实现弹性训练（我们后文有专门讲解）。</p>
<p>Gloo 和 MPI 都起到了同样类似作用：</p>
<ul>
<li>一方面Horovod内集成了基于 Gloo 的AllReduce，类似于NCCL，都是用作梯度规约；</li>
<li>另一方面，Gloo 可以用来启动多个进程（Hovorod里用Rank表示），实现并行计算；</li>
</ul>
<p>具体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">   <span class="o">+-----------------------+</span>   <span class="o">+-----------------------+</span>  <span class="o">+------------------------+</span>
</span></span><span class="line"><span class="cl">   <span class="o">|</span>  <span class="n">gloo_run</span>      <span class="n">slot</span> <span class="mi">1</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">gloo_run</span>     <span class="n">slot</span> <span class="mi">2</span>   <span class="o">|</span>  <span class="o">|</span>  <span class="n">gloo_run</span>  <span class="n">slot</span> <span class="mi">3</span>      <span class="o">|</span>
</span></span><span class="line"><span class="cl">   <span class="o">|</span>                       <span class="o">|</span>   <span class="o">|</span>                       <span class="o">|</span>  <span class="o">|</span>                        <span class="o">|</span>
</span></span><span class="line"><span class="cl">   <span class="o">|</span> <span class="o">+-------------------+</span> <span class="o">|</span>   <span class="o">|</span> <span class="o">+------------------+</span>  <span class="o">|</span>  <span class="o">|</span> <span class="o">+------------------+</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl">   <span class="o">|</span> <span class="o">|</span> <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>   <span class="o">|</span> <span class="o">|</span>   <span class="o">|</span> <span class="o">|</span>  <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span> <span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span> <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>  <span class="o">|</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+----+</span>                   <span class="o">+&lt;------+</span>                  <span class="o">+&lt;------+</span>                  <span class="o">+&lt;------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>  <span class="o">|</span> <span class="o">|</span>                   <span class="o">|</span> <span class="o">|</span>   <span class="o">|</span> <span class="o">|</span>                  <span class="o">|</span>  <span class="o">|</span>  <span class="o">|</span> <span class="o">|</span>                  <span class="o">|</span>   <span class="o">|</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>  <span class="o">|</span> <span class="o">+-------------------+</span> <span class="o">|</span>   <span class="o">|</span> <span class="o">+------------------+</span>  <span class="o">|</span>  <span class="o">|</span> <span class="o">+------------------+</span>   <span class="o">|</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>  <span class="o">|</span>                       <span class="o">|</span>   <span class="o">|</span>                       <span class="o">|</span>  <span class="o">|</span>                        <span class="o">|</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>  <span class="o">+-----------------------+</span>   <span class="o">+-----------------------+</span>  <span class="o">+------------------------+</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>                                                                                      <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>                                                                                      <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>                                                                                      <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="n">v</span><span class="o">--------------------------------------------------------------------------------------&gt;</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">Ring</span> <span class="n">Allreduce</span> <span class="n">on</span> <span class="n">Gloo</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42-rendezvous-功能">4.2 Rendezvous 功能<a hidden class="anchor" aria-hidden="true" href="#42-rendezvous-功能">#</a></h3>
<h4 id="421-rendezvous-概念">4.2.1 Rendezvous 概念<a hidden class="anchor" aria-hidden="true" href="#421-rendezvous-概念">#</a></h4>
<p>在 Gloo 的文档中，如此说:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The rendezvous process needs to happen exactly once per Gloo context.
</span></span><span class="line"><span class="cl">It makes participating Gloo processes exchange details for setting up their communication channels. For example, when the TCP transport is used, processes exchange IP address and port number details of listening sockets.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Rendezvous can be executed by accessing a key/value store that is accessible by all participating processes. Every process is responsible for setting a number of keys and will wait until their peers have set their keys. The values stored against these keys hold
</span></span><span class="line"><span class="cl">the information that is passed to the transport layer.
</span></span></code></pre></td></tr></table>
</div>
</div><p>大致意思是：</p>
<p>Gloo 在每一个 Gloo context 之中有一个 rendezvous process，Gloo 利用它来<strong>交换通讯需要的细节</strong>。</p>
<p>Rendezvous 具体实现是可以依靠访问一个 KVstore 来完成。具体细节就是通过 KVstore 来进行交互。</p>
<p>以 Horovod 为例：</p>
<ul>
<li>Horovod 在进行容错 AllReduce 训练时，除了启动 <strong>worker 进程</strong>外，还会启动一个<strong>driver 进程</strong>。这个 driver 进程用于帮助 worker 调用 gloo 构造 AllReduce 通信环。</li>
<li>driver 进程中会创建一个带有 KVStore 的 RendezvousServer，driver 会将参与通信的 worker 的 ip 等信息存入 KVstore 中。</li>
<li>然后 worker 就可以调用 gloo 来访问 RendezvousServer 构造通信环了。</li>
</ul>
<h4 id="422-rendezvousserver">4.2.2 RendezvousServer<a hidden class="anchor" aria-hidden="true" href="#422-rendezvousserver">#</a></h4>
<p>具体代码如下，可以看到是启动了RendezvousHTTPServer(就是继承拓展了 HTTPServer):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RendezvousServer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_httpd</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_listen_thread</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Rendezvous function finds a available port, create http socket,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># and start listening loop to handle request</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># self.httpd.init needs to be called after server start</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler_cls</span><span class="o">=</span><span class="n">RendezvousHandler</span><span class="p">):</span> <span class="c1"># 下面马上介绍</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_httpd</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">find_port</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">lambda</span> <span class="n">addr</span><span class="p">:</span> <span class="n">RendezvousHTTPServer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">addr</span><span class="p">,</span> <span class="n">handler_cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># start the listening loop</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_listen_thread</span> <span class="o">=</span> <span class="n">in_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">port</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_alloc_plan</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_httpd</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">host_alloc_plan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_httpd</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_listen_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="423-kvstore">4.2.3 KVStore<a hidden class="anchor" aria-hidden="true" href="#423-kvstore">#</a></h4>
<p>KVStore 是由 KVStoreHandler 来体现，RendezvousHandler 继承了 KVStoreHandler，进而被 RendezvousServer 作为 handler 使用。</p>
<p>KVStoreHandler 精简版代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">KVStoreHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Override PUT handler</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_PUT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">paths</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Get body length</span>
</span></span><span class="line"><span class="cl">        <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_put_value</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">send_status_code</span><span class="p">(</span><span class="n">OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_put_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">cache_lock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="424-底层使用">4.2.4 底层使用<a hidden class="anchor" aria-hidden="true" href="#424-底层使用">#</a></h4>
<p>Rendezvous 具体如何使用？简要的说：</p>
<ul>
<li>Python世界构建了一个 RendezvousServer，其地址配置在环境变量（或者其他方式）中。</li>
<li>在 C++ 世界中，比如 horovod/common/gloo/gloo_context.h，horovod/common/gloo/gloo_context.cc 之中有使用。即得到 Python 配置的 RendezvousServer 的地址端口等，然后构建 gloo 所需的 context。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#define HOROVOD_HOSTNAME &#34;HOROVOD_HOSTNAME&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define HOROVOD_RANK &#34;HOROVOD_RANK&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define HOROVOD_SIZE &#34;HOROVOD_SIZE&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define HOROVOD_LOCAL_RANK &#34;HOROVOD_LOCAL_RANK&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define HOROVOD_LOCAL_SIZE &#34;HOROVOD_LOCAL_SIZE&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define HOROVOD_CROSS_RANK &#34;HOROVOD_CROSS_RANK&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define HOROVOD_CROSS_SIZE &#34;HOROVOD_CROSS_SIZE&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define HOROVOD_ELASTIC &#34;HOROVOD_ELASTIC&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">ctx</span> <span class="o">=</span> <span class="n">Rendezvous</span><span class="p">(</span><span class="n">HOROVOD_GLOO_GLOBAL_PREFIX</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">rendezvous_addr_env</span><span class="p">,</span> <span class="n">rendezvous_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">local_ctx</span> <span class="o">=</span> <span class="n">Rendezvous</span><span class="p">(</span><span class="n">HOROVOD_GLOO_LOCAL_PREFIX</span> <span class="o">+</span> <span class="n">hostname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">rendezvous_addr_env</span><span class="p">,</span> <span class="n">rendezvous_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">local_rank</span><span class="p">,</span> <span class="n">local_size</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">cross_ctx</span> <span class="o">=</span> <span class="n">Rendezvous</span><span class="p">(</span><span class="n">HOROVOD_GLOO_CROSS_PREFIX</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">local_rank</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                         <span class="n">rendezvous_addr_env</span><span class="p">,</span> <span class="n">rendezvous_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cross_rank</span><span class="p">,</span> <span class="n">cross_size</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑如下，C++世界会从python世界的获取到RendezvousServer的 IP，port：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">          <span class="o">+---------------------&gt;</span>  <span class="n">System</span> <span class="n">Env</span>  <span class="o">+------------------+</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>  <span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="o">...</span>                     <span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="o">...</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">+</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>    <span class="n">Python</span>                  <span class="o">|</span>              <span class="n">C</span><span class="o">++</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="o">|</span>                            <span class="o">|</span>                          <span class="n">v</span>
</span></span><span class="line"><span class="cl"><span class="o">+---------+---------------+</span>            <span class="o">|</span>             <span class="o">+------------+--------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">RendezvousServer</span>        <span class="o">|</span>            <span class="o">|</span>             <span class="o">|</span><span class="n">GlooContext</span>          <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>                         <span class="o">|</span>            <span class="o">|</span>             <span class="o">|</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>                         <span class="o">|</span>            <span class="o">|</span>             <span class="o">|</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>                         <span class="o">|</span>            <span class="o">|</span>             <span class="o">|</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>    <span class="n">RendezvousHandler</span>    <span class="o">|</span>            <span class="o">|</span>             <span class="o">|</span>      <span class="n">Rendezvous</span>     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>                         <span class="o">|</span>            <span class="o">|</span>             <span class="o">|</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-------------------------+</span>            <span class="o">|</span>             <span class="o">+---------------------+</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">+</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="43-horovd-的-gloo-入口">4.3 Horovd 的 gloo 入口<a hidden class="anchor" aria-hidden="true" href="#43-horovd-的-gloo-入口">#</a></h3>
<p>gloo_run 是 horovod 之中，gloo 模块的 相关入口。</p>
<p>注释说的很清楚：每一个 thread 将使用 ssh 命令在远程host之上启动训练job。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gloo_run</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Each thread will use ssh command to launch the job on each remote host. If an</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># error occurs in one thread, entire process will be terminated. Otherwise,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># threads will keep running and ssh session.</span>
</span></span><span class="line"><span class="cl">    <span class="n">exec_command</span> <span class="o">=</span> <span class="n">_exec_command_fn</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">launch_gloo</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">exec_command</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>就是用 launch_gloo 来运行 exec_command。</p>
<p>此时 command 参数类似 <code>&quot;['python', 'train.py']&quot;</code>。</p>
<h3 id="44-构建可执行环境">4.4 构建可执行环境<a hidden class="anchor" aria-hidden="true" href="#44-构建可执行环境">#</a></h3>
<p>gloo_run 的第一部分是 <code>exec_command = _exec_command_fn(settings)</code>，就是基于各种配置来生成可以执行命令环境。如果是远程，就得生成相关远程可运行命令环境（包括切换目录，远程执行等等）。</p>
<h4 id="441-_exec_command_fn">4.4.1 _exec_command_fn<a hidden class="anchor" aria-hidden="true" href="#441-_exec_command_fn">#</a></h4>
<p>具体又可以分为两部分：</p>
<ul>
<li>利用 get_remote_command 来生成相关远程可运行环境，比如在训练脚本前面加上 <code>'ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no'</code>；</li>
<li>调整输入输出，利用 safe_shell_exec.execute 来实现安全执行能力；</li>
</ul>
<p>具体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_exec_command_fn</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    executes the jobs defined by run command on hosts.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param hosts_alloc: list of dict indicating the allocating info.
</span></span></span><span class="line"><span class="cl"><span class="s2">    For example,
</span></span></span><span class="line"><span class="cl"><span class="s2">        [{&#39;Hostname&#39;:&#39;worker-0&#39;, &#39;Rank&#39;: 0, &#39;Local_rank&#39;: 0, &#39;Cross_rank&#39;:0,
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#39;Size&#39;:2, &#39;Local_size&#39;:1, &#39;Cross_size&#39;:2},
</span></span></span><span class="line"><span class="cl"><span class="s2">        {&#39;Hostname&#39;:&#39;worker-1&#39;, &#39;Rank&#39;: 1, &#39;Local_rank&#39;: 0, &#39;Cross_rank&#39;:1,
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#39;Size&#39;:2, &#39;Local_size&#39;:1, &#39;Cross_size&#39;:2}
</span></span></span><span class="line"><span class="cl"><span class="s2">        ]
</span></span></span><span class="line"><span class="cl"><span class="s2">    :type hosts_alloc: list(dict)
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param remote_host_names: names that are resolved to one of the addresses
</span></span></span><span class="line"><span class="cl"><span class="s2">    of remote hosts interfaces.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param _run_command: command to execute
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">slot_info</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span> <span class="o">=</span> <span class="n">slot_info</span><span class="o">.</span><span class="n">rank</span>
</span></span><span class="line"><span class="cl">        <span class="n">host_name</span> <span class="o">=</span> <span class="n">slot_info</span><span class="o">.</span><span class="n">hostname</span>
</span></span><span class="line"><span class="cl">        <span class="n">host_address</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">resolve_host_address</span><span class="p">(</span><span class="n">host_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_addresses</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">get_local_host_addresses</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 需要构建远程命令</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">host_address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">local_addresses</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">local_command</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="s1">&#39;cd </span><span class="si">{pwd}</span><span class="s1"> &gt; /dev/null 2&gt;&amp;1 ; </span><span class="si">{command}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">command</span> <span class="o">=</span> <span class="n">get_remote_command</span><span class="p">(</span><span class="n">local_command</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">host</span><span class="o">=</span><span class="n">host_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">port</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ssh_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">identity_file</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ssh_identity_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Redirect output if requested</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 调整输入输出，利用 safe_shell_exec.execute 来实现安全执行能力</span>
</span></span><span class="line"><span class="cl">        <span class="n">stdout</span> <span class="o">=</span> <span class="n">stderr</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">stdout_file</span> <span class="o">=</span> <span class="n">stderr_file</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">output_filename</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">padded_rank</span> <span class="o">=</span> <span class="n">_pad_rank</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">num_proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">output_dir_rank</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">output_filename</span><span class="p">,</span> <span class="s1">&#39;rank.</span><span class="si">{rank}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">padded_rank</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir_rank</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_dir_rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">stdout_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir_rank</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">stderr_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir_rank</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">stdout</span> <span class="o">=</span> <span class="n">MultiFile</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stdout_file</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">stderr</span> <span class="o">=</span> <span class="n">MultiFile</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">stderr_file</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 实现安全执行能力</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit_code</span> <span class="o">=</span> <span class="n">safe_shell_exec</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                                <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_exec_command</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="442-get_remote_command">4.4.2 get_remote_command<a hidden class="anchor" aria-hidden="true" href="#442-get_remote_command">#</a></h4>
<p>本函数是针对远程 host，获取如何在其上运行的方式。这个函数是比较新加入的，具体和 kubeflow mpi operator 也相关，以后有机会再分析。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">SSH_COMMAND_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_ssh_command</span><span class="p">(</span><span class="n">local_command</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identity_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout_s</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">port_arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;-p </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">identity_file_arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;-i </span><span class="si">{</span><span class="n">identity_file</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">identity_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeout_arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;-o ConnectTimeout=</span><span class="si">{</span><span class="n">timeout_s</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">timeout_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">SSH_COMMAND_PREFIX</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">port_arg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">identity_file_arg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">timeout_arg</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">local_command</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_remote_command</span><span class="p">(</span><span class="n">local_command</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identity_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout_s</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">env_util</span><span class="o">.</span><span class="n">KUBEFLOW_MPI_EXEC</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">local_command</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">env_util</span><span class="o">.</span><span class="n">is_kubeflow_mpi</span><span class="p">()</span> \
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="n">get_ssh_command</span><span class="p">(</span><span class="n">local_command</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">identity_file</span><span class="p">,</span> <span class="n">timeout_s</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>大致逻辑如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">command</span>  <span class="o">:</span>  <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span>
</span></span><span class="line"><span class="cl">  <span class="o">+---------+-------------+</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span>                       <span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span>  <span class="n">get_remote_command</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span>                       <span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="o">+---------+-------------+</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="o">...</span> <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>
</span></span><span class="line"><span class="cl">            <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span>
</span></span><span class="line"><span class="cl">  <span class="o">+---------+--------------+</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span><span class="n">safe_shell_exec</span><span class="o">.</span><span class="na">execute</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="o">|</span>                        <span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="o">+------------------------+</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="45-使用-gloo-执行命令">4.5 使用 gloo 执行命令<a hidden class="anchor" aria-hidden="true" href="#45-使用-gloo-执行命令">#</a></h3>
<p>获取到了可执行环境 exec_command 与 执行命令 command 之后，就可以使用 gloo 来执行命令了。</p>
<p>每个 command 都是被 exec_command 来执行。</p>
<p>launch_gloo 来获取命令，各种配置信息，网卡信息（nics，比如 {&rsquo;lo&rsquo;}），host信息等，然后开始运行，就是开始运行我们的训练代码了，具体是：</p>
<ul>
<li>建立 RendezvousServer，这个会被底层 Gloo C++ 环境使用到;</li>
<li>host_alloc_plan = get_host_assignments 来根据host进行分配slot，就是horovod的哪个rank应该在哪个host上的哪个slot之上运行；</li>
<li>get_run_command 获取到可执行命令；</li>
<li>slot_info_to_command_fn 来得到在slot之上可执行的 slot command；</li>
<li>依据 slot_info_to_command_fn 构建 args_list，这个 list 之中，每一个arg就是一个 slot command；</li>
<li>多线程执行，在每一个 exec_command 之上执行每一个 arg（slot command）；</li>
</ul>
<p>代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">launch_gloo</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">exec_command</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Launches the given command multiple times using gloo.
</span></span></span><span class="line"><span class="cl"><span class="s2">    Each command is launched via exec_command.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param command: command to launch
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param exec_command: means to execute a single command
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param settings: settings for the distribution
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param nics: common interfaces
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param env: environment to use
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param server_ip: ip to use for rendezvous server
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Make the output directory if it does not exist</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">output_filename</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">_mkdir_p</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">output_filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># start global rendezvous server and get port that it is listening on</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 建立 RendezvousServer，这个会被底层 Gloo C++ 环境使用到</span>
</span></span><span class="line"><span class="cl">    <span class="n">rendezvous</span> <span class="o">=</span> <span class="n">RendezvousServer</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># allocate processes into slots</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 来根据host进行分配slot，就是horovod的哪个rank应该在哪个host上的哪个slot之上运行</span>
</span></span><span class="line"><span class="cl">    <span class="n">hosts</span> <span class="o">=</span> <span class="n">parse_hosts</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">hosts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">host_alloc_plan</span> <span class="o">=</span> <span class="n">get_host_assignments</span><span class="p">(</span><span class="n">hosts</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">num_proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># start global rendezvous server and get port that it is listening on</span>
</span></span><span class="line"><span class="cl">    <span class="n">global_rendezv_port</span> <span class="o">=</span> <span class="n">rendezvous</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">rendezvous</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">host_alloc_plan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取到可执行命令</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_command</span> <span class="o">=</span> <span class="n">get_run_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">global_rendezv_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 得到在slot之上可执行的 slot command</span>
</span></span><span class="line"><span class="cl">    <span class="n">slot_info_to_command</span> <span class="o">=</span> <span class="n">_slot_info_to_command_fn</span><span class="p">(</span><span class="n">run_command</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span> <span class="o">=</span> <span class="n">register_shutdown_event</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 依据 slot_info_to_command_fn 构建 args_list，这个 list 之中，每一个arg就是一个 slot command</span>
</span></span><span class="line"><span class="cl">    <span class="n">args_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">slot_info_to_command</span><span class="p">(</span><span class="n">slot_info</span><span class="p">),</span> <span class="n">slot_info</span><span class="p">,</span> <span class="p">[</span><span class="n">event</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">                 <span class="k">for</span> <span class="n">slot_info</span> <span class="ow">in</span> <span class="n">host_alloc_plan</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># If an error occurs in one thread, entire process will be terminated.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Otherwise, threads will keep running.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 多线程执行，在每一个 exec_command 之上执行每一个 arg（slot command）</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="o">=</span> <span class="n">threads</span><span class="o">.</span><span class="n">execute_function_multithreaded</span><span class="p">(</span><span class="n">exec_command</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">args_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="n">block_until_all_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit_code</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">value</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>具体 HostInfo.from_string 信息如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HostInfo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">slots</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">slots</span> <span class="o">=</span> <span class="n">slots</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="n">host_string</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">hostname</span><span class="p">,</span> <span class="n">slots</span> <span class="o">=</span> <span class="n">host_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">HostInfo</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">slots</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="4512-分配方案">4.5.1.2 分配方案<a hidden class="anchor" aria-hidden="true" href="#4512-分配方案">#</a></h5>
<p>get_host_assignments 会依据 host 和 process capacities (slots) 来给 Horovod 之中的进程分配，即给出一个 horovod rank 和 slot 的对应关系。设置了几个 np，就有几个 slot。</p>
<p>给出的分配方案类似如下，这样就知道了哪个rank对应于哪个host上的哪个slot：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[
</span></span><span class="line"><span class="cl">  SlotInfo(hostname=&#39;h1&#39;, rank=0, local_rank=0, cross_rank=0, size=2, local_size=2, coress_size=1),
</span></span><span class="line"><span class="cl">	SlotInfo(hostname=&#39;h2&#39;, rank=1, local_rank=0, cross_rank=0, size=2, local_size=2, coress_size=1),
</span></span><span class="line"><span class="cl">]
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_host_assignments</span><span class="p">(</span><span class="n">hosts</span><span class="p">,</span> <span class="n">min_np</span><span class="p">,</span> <span class="n">max_np</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Assign hosts with process capacities (slots) to ranks in the Horovod process.
</span></span></span><span class="line"><span class="cl"><span class="s2">    This function will try to allocate as many as possible processes on the same host to leverage local network.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param hosts: list of HostInfo objects describing host and slot capacity
</span></span></span><span class="line"><span class="cl"><span class="s2">    :type hosts: list[HostInfo]
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param min_np: minimum number of processes to be allocated
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param max_np: (optional) maximum number of processes to be allocated
</span></span></span><span class="line"><span class="cl"><span class="s2">    :return: a list of the allocation of process on hosts in a `SlotInfo` object.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :rtype: list[SlotInfo]
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">host_ranks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">cross_ranks</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 依据 hosts 信息构建 rank, local rank, cross rank(hierarchical allreduce所需要)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">host_info</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ranks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">local_rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">host_info</span><span class="o">.</span><span class="n">slots</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="n">max_np</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">ranks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">rank</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">cross_ranks_at_local</span> <span class="o">=</span> <span class="n">cross_ranks</span><span class="p">[</span><span class="n">local_rank</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">cross_ranks_at_local</span><span class="p">[</span><span class="n">host_info</span><span class="o">.</span><span class="n">hostname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cross_ranks_at_local</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">host_ranks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">host_info</span><span class="p">,</span> <span class="n">ranks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">world_size</span> <span class="o">=</span> <span class="n">rank</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 给出一个 horovod rank 和 slot 的对应关系。返回一个alloc_list，每个SlotInfo包括各种rank信息</span>
</span></span><span class="line"><span class="cl">    <span class="n">alloc_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">host_info</span><span class="p">,</span> <span class="n">ranks</span> <span class="ow">in</span> <span class="n">host_ranks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">local_rank</span><span class="p">,</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranks</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">cross_ranks_at_local</span> <span class="o">=</span> <span class="n">cross_ranks</span><span class="p">[</span><span class="n">local_rank</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">cross_rank</span> <span class="o">=</span> <span class="n">cross_ranks_at_local</span><span class="p">[</span><span class="n">host_info</span><span class="o">.</span><span class="n">hostname</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">cross_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cross_ranks_at_local</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">alloc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">SlotInfo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hostname</span><span class="o">=</span><span class="n">host_info</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">local_rank</span><span class="o">=</span><span class="n">local_rank</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cross_rank</span><span class="o">=</span><span class="n">cross_rank</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size</span><span class="o">=</span><span class="n">world_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">local_size</span><span class="o">=</span><span class="n">local_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cross_size</span><span class="o">=</span><span class="n">cross_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">alloc_list</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="452-得到运行命令">4.5.2 得到运行命令<a hidden class="anchor" aria-hidden="true" href="#452-得到运行命令">#</a></h4>
<p>get_run_command 是从环境变量中得到 Gloo 的变量，然后加到 command 之上。此步完成之后，得到类似如下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">HOROVOD_GLOO_RENDEZVOUS_ADDR</span><span class="o">=</span>1.1.1.1 <span class="nv">HOROVOD_GLOO_RENDEZVOUS_PORT</span><span class="o">=</span><span class="m">2222</span> <span class="nv">HOROVOD_CPU_OPERATIONS</span><span class="o">=</span>gloo <span class="nv">HOROVOD_GLOO_IFACE</span><span class="o">=</span>lo <span class="nv">HOROVOD_CONTROLLER</span><span class="o">=</span>gloo python train.py
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以把这个格式缩写为：{horovod_gloo_env} command。</p>
<p>代码为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_run_env_vars</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">elastic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 从环境变量中得到 Gloo 的变量</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_envs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;HOROVOD_GLOO_RENDEZVOUS_ADDR&#39;</span><span class="p">:</span> <span class="n">server_ip</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;HOROVOD_GLOO_RENDEZVOUS_PORT&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;HOROVOD_CONTROLLER&#39;</span><span class="p">:</span> <span class="s2">&#34;gloo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;HOROVOD_CPU_OPERATIONS&#39;</span><span class="p">:</span> <span class="s2">&#34;gloo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;HOROVOD_GLOO_IFACE&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">nics</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>   <span class="c1"># TODO: add multiple ifaces in future</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;NCCL_SOCKET_IFNAME&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nics</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">elastic</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_envs</span><span class="p">[</span><span class="s2">&#34;HOROVOD_ELASTIC&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">run_envs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_run_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">server_ip</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">elastic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">env_vars</span> <span class="o">=</span> <span class="n">create_run_env_vars</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">elastic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">env_string</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_command</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{env_string}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{command}</span><span class="s1">&#39;</span>  <span class="c1"># expect a lot of environment variables</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_string</span><span class="o">=</span><span class="n">env_string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">command</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">command</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">run_command</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="453-得到slot运行命令">4.5.3 得到slot运行命令<a hidden class="anchor" aria-hidden="true" href="#453-得到slot运行命令">#</a></h4>
<p>得到运行命令之后，这里会结合 horovod env 和 env，以及slot 分配情况 进一步修改为适合 gloo 运行的方式。就是可以在具体每一个slot上运行的命令。</p>
<p>可以把这个格式缩写为：{horovod_gloo_env} {horovod_rendez_env} {env} run_command。</p>
<p>此步完成之后，得到类似如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">HOROVOD_HOSTNAME</span><span class="o">=</span>1.1.1.1 <span class="nv">HOROVOD_RANK</span><span class="o">=</span><span class="m">1</span> <span class="nv">HOROVOD_SIZE</span><span class="o">=</span><span class="m">2</span> <span class="nv">HOROVOD_LOCAL_RANK</span><span class="o">=</span><span class="m">1</span> 
</span></span><span class="line"><span class="cl"><span class="nv">SHELL</span><span class="o">=</span>/bin/bash <span class="nv">PATH</span><span class="o">=</span>XXXX <span class="nv">USER</span><span class="o">=</span>xxx <span class="nv">PWD</span><span class="o">=</span>xxx <span class="nv">SSH_CONNECTION</span><span class="o">=</span><span class="s2">&#34;1.1.1.1 11 2.2.2.2 22&#34;</span> <span class="nv">HOME</span><span class="o">=</span>xxx <span class="nv">SSH_CLIENZT</span><span class="o">=</span>xxxx
</span></span><span class="line"><span class="cl"><span class="nv">HOROVOD_GLOO_IFACE</span><span class="o">=</span>lo <span class="nv">NCCL_SOCKET_IFNAME</span><span class="o">=</span>lo 
</span></span><span class="line"><span class="cl"><span class="nv">HOROVOD_GLOO_RENDEZVOUS_ADDR</span><span class="o">=</span>1.1.1.1 <span class="nv">HOROVOD_GLOO_RENDEZVOUS_PORT</span><span class="o">=</span><span class="m">2222</span> <span class="nv">HOROVOD_CPU_OPERATIONS</span><span class="o">=</span>gloo <span class="nv">HOROVOD_GLOO_IFACE</span><span class="o">=</span>lo <span class="nv">HOROVOD_CONTROLLER</span><span class="o">=</span>gloo python train.py
</span></span></code></pre></td></tr></table>
</div>
</div><p>具体代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_slot_info_to_command_fn</span><span class="p">(</span><span class="n">run_command</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># TODO: Workaround for over-buffered outputs. Investigate how mpirun avoids this problem.</span>
</span></span><span class="line"><span class="cl">    <span class="n">env</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>  <span class="c1"># copy env so we do not leak env modifications</span>
</span></span><span class="line"><span class="cl">    <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PYTHONUNBUFFERED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">slot_info_to_command</span><span class="p">(</span><span class="n">slot_info</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Given a slot_info, creates a command used by gloo to launch a single job.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param slot_info: host and slot to execute the run command on
</span></span></span><span class="line"><span class="cl"><span class="s2">        :return:
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">env_vars</span> <span class="o">=</span> <span class="n">create_slot_env_vars</span><span class="p">(</span><span class="n">slot_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">horovod_rendez_env</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">[</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{horovod_env}</span><span class="s1"> </span><span class="si">{env}</span><span class="s1"> </span><span class="si">{run_command}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">horovod_env</span><span class="o">=</span><span class="n">horovod_rendez_env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">env</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">quote</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                          <span class="k">if</span> <span class="n">env_util</span><span class="o">.</span><span class="n">is_exportable</span><span class="p">(</span><span class="n">key</span><span class="p">)]),</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_command</span><span class="o">=</span><span class="n">run_command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">slot_info_to_command</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="454-多线程调用命令">4.5.4 多线程调用命令<a hidden class="anchor" aria-hidden="true" href="#454-多线程调用命令">#</a></h4>
<p>这就是启动了多线程进行调用。gloo_run 的注释说的很清楚：在调用 execute_function_multithreaded 时，每一个thread将使用 ssh 命令在远程host之上启动训练job。</p>
<p>回忆下之前我们在“构建可执行环境” 中提到：利用 get_remote_command 来生成相关远程可运行环境，比如在训练脚本前面加上 &lsquo;ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no&rsquo;。大家就理解了如何在远端执行。</p>
<p>在本地运行，则命令大致为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> /code directory &gt; /dev/null <span class="m">2</span> &gt;<span class="p">&amp;</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">HOROVOD_HOSTNAME</span><span class="o">=</span>1.1.1.1 <span class="nv">HOROVOD_RANK</span><span class="o">=</span><span class="m">1</span> <span class="nv">HOROVOD_SIZE</span><span class="o">=</span><span class="m">2</span> <span class="nv">HOROVOD_LOCAL_RANK</span><span class="o">=</span><span class="m">1</span> 
</span></span><span class="line"><span class="cl"><span class="nv">SHELL</span><span class="o">=</span>/bin/bash <span class="nv">PATH</span><span class="o">=</span>XXXX <span class="nv">USER</span><span class="o">=</span>xxx <span class="nv">PWD</span><span class="o">=</span>xxx <span class="nv">SSH_CONNECTION</span><span class="o">=</span><span class="s2">&#34;1.1.1.1 11 2.2.2.2 22&#34;</span> <span class="nv">HOME</span><span class="o">=</span>xxx <span class="nv">SSH_CLIENZT</span><span class="o">=</span>xxxx
</span></span><span class="line"><span class="cl"><span class="nv">HOROVOD_GLOO_IFACE</span><span class="o">=</span>lo <span class="nv">NCCL_SOCKET_IFNAME</span><span class="o">=</span>lo 
</span></span><span class="line"><span class="cl"><span class="nv">HOROVOD_GLOO_RENDEZVOUS_ADDR</span><span class="o">=</span>1.1.1.1 <span class="nv">HOROVOD_GLOO_RENDEZVOUS_PORT</span><span class="o">=</span><span class="m">2222</span> <span class="nv">HOROVOD_CPU_OPERATIONS</span><span class="o">=</span>gloo <span class="nv">HOROVOD_GLOO_IFACE</span><span class="o">=</span>lo <span class="nv">HOROVOD_CONTROLLER</span><span class="o">=</span>gloo python train.py
</span></span></code></pre></td></tr></table>
</div>
</div><p>在远端运行，命令就需要加上 ssh 信息，大致为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ssh -o <span class="nv">PasswordAuthentication</span><span class="o">=</span>no -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no 1.1.1.1
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /code directory &gt; /dev/null <span class="m">2</span> &gt;<span class="p">&amp;</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">HOROVOD_HOSTNAME</span><span class="o">=</span>1.1.1.1 <span class="nv">HOROVOD_RANK</span><span class="o">=</span><span class="m">1</span> <span class="nv">HOROVOD_SIZE</span><span class="o">=</span><span class="m">2</span> <span class="nv">HOROVOD_LOCAL_RANK</span><span class="o">=</span><span class="m">1</span> 
</span></span><span class="line"><span class="cl"><span class="nv">SHELL</span><span class="o">=</span>/bin/bash <span class="nv">PATH</span><span class="o">=</span>XXXX <span class="nv">USER</span><span class="o">=</span>xxx <span class="nv">PWD</span><span class="o">=</span>xxx <span class="nv">SSH_CONNECTION</span><span class="o">=</span><span class="s2">&#34;1.1.1.1 11 2.2.2.2 22&#34;</span> <span class="nv">HOME</span><span class="o">=</span>xxx <span class="nv">SSH_CLIENZT</span><span class="o">=</span>xxxx
</span></span><span class="line"><span class="cl"><span class="nv">HOROVOD_GLOO_IFACE</span><span class="o">=</span>lo <span class="nv">NCCL_SOCKET_IFNAME</span><span class="o">=</span>lo 
</span></span><span class="line"><span class="cl"><span class="nv">HOROVOD_GLOO_RENDEZVOUS_ADDR</span><span class="o">=</span>1.1.1.1 <span class="nv">HOROVOD_GLOO_RENDEZVOUS_PORT</span><span class="o">=</span><span class="m">2222</span> <span class="nv">HOROVOD_CPU_OPERATIONS</span><span class="o">=</span>gloo <span class="nv">HOROVOD_GLOO_IFACE</span><span class="o">=</span>lo <span class="nv">HOROVOD_CONTROLLER</span><span class="o">=</span>gloo python train.py
</span></span></code></pre></td></tr></table>
</div>
</div><p>execute_function_multithreaded 具体代码如下，其中：</p>
<ul>
<li><code>fn</code> 就是前面提到的程序运行环境（能力）<code>exec_command</code>。</li>
<li><code>fn(*arg[:-1])</code> 就是在 <code>exec_command</code> 之中运行<code>slot_info_to_command</code>。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">execute_function_multithreaded</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">args_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">block_until_all_done</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">max_concurrent_executions</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Executes fn in multiple threads each with one set of the args in the
</span></span></span><span class="line"><span class="cl"><span class="s2">    args_list.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param fn: function to be executed
</span></span></span><span class="line"><span class="cl"><span class="s2">    :type fn:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param args_list:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :type args_list: list(list)
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param block_until_all_done: if is True, function will block until all the
</span></span></span><span class="line"><span class="cl"><span class="s2">    threads are done and will return the results of each thread&#39;s execution.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :type block_until_all_done: bool
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param max_concurrent_executions:
</span></span></span><span class="line"><span class="cl"><span class="s2">    :type max_concurrent_executions: int
</span></span></span><span class="line"><span class="cl"><span class="s2">    :return:
</span></span></span><span class="line"><span class="cl"><span class="s2">    If block_until_all_done is False, returns None. If block_until_all_done is
</span></span></span><span class="line"><span class="cl"><span class="s2">    True, function returns the dict of results.
</span></span></span><span class="line"><span class="cl"><span class="s2">        {
</span></span></span><span class="line"><span class="cl"><span class="s2">            index: execution result of fn with args_list[index]
</span></span></span><span class="line"><span class="cl"><span class="s2">        }
</span></span></span><span class="line"><span class="cl"><span class="s2">    :rtype: dict
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">worker_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">worker_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fn_execute</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">arg</span> <span class="o">=</span> <span class="n">worker_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="n">exec_index</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># fn 就是前面提到的程序运行环境（能力）exec_command</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># fn(*arg[:-1])是在 exec_command 之中运行 slot_info_to_command</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
</span></span><span class="line"><span class="cl">            <span class="n">result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">exec_index</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">number_of_threads</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_concurrent_executions</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args_list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 在多线程中执行 fn_execute</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_threads</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">thread</span> <span class="o">=</span> <span class="n">in_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">fn_execute</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="ow">not</span> <span class="n">block_until_all_done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Returns the results only if block_until_all_done is set.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果有设置，则 block 等待</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">block_until_all_done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Because join() cannot be interrupted by signal, a single join()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># needs to be separated into join()s with timeout in a while loop.</span>
</span></span><span class="line"><span class="cl">        <span class="n">have_alive_child</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">have_alive_child</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">have_alive_child</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="n">have_alive_child</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="n">result_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span> <span class="o">=</span> <span class="n">result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">results</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>python train.py 就会进入到我们的训练代码。</p>
<p>大致逻辑如下图，可以看到，结合了各种信息之后，构建了一个可以执行的结果，然后多host执行：</p>
<ul>
<li>图左面，是从 参数中获取 host 等信息，然后解析出 slot 信息；</li>
<li>图右边，是从 python train.py 这个待运行的命令，基于各种配置来生成可以执行命令环境。如果是远程，就得生成 相关远程可运行命令环境（包括切换目录，远程执行等等）；</li>
<li>图中间，是从 python train.py 这个待运行的命令，经过添加 env 信息，gloo 信息。然后结合 左面的 slot 信息 和 右面 的可以执行命令环境 之后，得到了可以在多线程上运行，从而在 多slot 运行的命令。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">args</span> <span class="o">:</span> <span class="err">&#39;</span><span class="mf">10.11.11.11</span><span class="o">:</span><span class="mi">4</span><span class="o">,</span><span class="mf">10.11.11.12</span><span class="o">:</span><span class="mi">4</span><span class="err">&#39;</span>            <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>                  <span class="n">command</span>  <span class="o">:</span>  <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                 <span class="o">+</span>                                     <span class="o">+</span>                                     <span class="o">+</span>
</span></span><span class="line"><span class="cl">                 <span class="o">|</span>                                     <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                 <span class="o">|</span>                                     <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                 <span class="n">v</span>                                     <span class="n">v</span>                                     <span class="n">v</span>
</span></span><span class="line"><span class="cl">      <span class="o">+----------+--------+</span>                 <span class="o">+----------+----------+</span>                <span class="o">+---------+-------------+</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span>    <span class="n">parse_hosts</span>    <span class="o">|</span>                 <span class="o">|</span>   <span class="n">get_run_command</span>   <span class="o">|</span>                <span class="o">|</span>                       <span class="o">|</span>
</span></span><span class="line"><span class="cl">      <span class="o">+----------+--------+</span>                 <span class="o">|</span>                     <span class="o">|</span>                <span class="o">|</span>  <span class="n">get_remote_command</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl">                 <span class="o">|</span>                          <span class="o">+----------+----------+</span>                <span class="o">|</span>                       <span class="o">|</span>
</span></span><span class="line"><span class="cl">                 <span class="o">|</span>                                     <span class="o">|</span>                           <span class="o">+---------+-------------+</span>
</span></span><span class="line"><span class="cl">                 <span class="n">v</span>                                     <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">    <span class="o">+------------+-----------+</span>                         <span class="n">v</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span>  <span class="n">get_host_assignments</span>  <span class="o">|</span>                                                               <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span>                        <span class="o">|</span>               <span class="n">gloo</span> <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>
</span></span><span class="line"><span class="cl">    <span class="o">+------------+-----------+</span>                         <span class="o">+</span>                          <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="o">...</span> <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>
</span></span><span class="line"><span class="cl">                 <span class="o">|</span>                                     <span class="o">|</span>                                     <span class="o">+</span>
</span></span><span class="line"><span class="cl">                 <span class="o">|</span>                                     <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                 <span class="n">v</span>                                     <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                       <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">    <span class="n">SlotInfo</span><span class="o">(</span><span class="n">hostname</span><span class="o">=</span><span class="err">&#39;</span><span class="n">h2</span><span class="err">&#39;</span><span class="o">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="o">)</span>                    <span class="n">v</span>                                     <span class="n">v</span>
</span></span><span class="line"><span class="cl">                 <span class="o">+</span>                         <span class="o">+-----------+---------------+</span>           <span class="o">+---------+--------------+</span>
</span></span><span class="line"><span class="cl">                 <span class="o">|</span>                         <span class="o">|</span> <span class="n">_slot_info_to_command_fn</span>  <span class="o">|</span>           <span class="o">|</span><span class="n">safe_shell_exec</span><span class="o">.</span><span class="na">execute</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                 <span class="o">+-----------------------&gt;</span> <span class="o">|</span>                           <span class="o">|</span>           <span class="o">|</span>                        <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                           <span class="o">+-----------+---------------+</span>           <span class="o">+---------+--------------+</span>
</span></span><span class="line"><span class="cl">                                                       <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                       <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                       <span class="n">v</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                                                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">HOROVOD_CONTROLLER</span><span class="o">=</span><span class="n">gloo</span> <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="na">py</span>            <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                       <span class="o">+</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                       <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                       <span class="o">|</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                                       <span class="n">v</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                         <span class="o">+-------------+-------------------+</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                         <span class="o">|</span>                                 <span class="o">|</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                         <span class="o">|</span> <span class="n">execute_function_multithreaded</span>  <span class="o">|</span> <span class="o">&lt;---------------+</span>
</span></span><span class="line"><span class="cl">                                         <span class="o">|</span>                                 <span class="o">|</span>
</span></span><span class="line"><span class="cl">                                         <span class="o">+---------------------------------+</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>图示如下：</p>
<p><img loading="lazy" src="https://github.com/jianye0428/hello-hugo/raw/master/img/posts/notes/2022-10-09_Horovod_3/Horovod-3_execute_function.png#center" alt="Execute function"  />
</p>
<h3 id="46-c举例">4.6 C++举例<a hidden class="anchor" aria-hidden="true" href="#46-c举例">#</a></h3>
<p>我们给出一个底层代码，大家就进一步了解 Gloo 可以起到什么作用。</p>
<p>这个就是 Horovod 之中，rank 0 最终给其他 rank 发送构建好的 Tensor。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">GlooController</span><span class="o">::</span><span class="n">SendFinalTensors</span><span class="p">(</span><span class="n">ResponseList</span><span class="o">&amp;</span> <span class="n">response_list</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Notify all nodes which tensors we&#39;d like to reduce at this step.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">encoded_response</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ResponseList</span><span class="o">::</span><span class="n">SerializeToString</span><span class="p">(</span><span class="n">response_list</span><span class="p">,</span> <span class="n">encoded_response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Boardcast the response length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">encoded_response_length</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">encoded_response</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">gloo</span><span class="o">::</span><span class="n">BroadcastOptions</span> <span class="n">opts</span><span class="p">(</span><span class="n">gloo_context_</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">opts</span><span class="p">.</span><span class="n">setOutput</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoded_response_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">opts</span><span class="p">.</span><span class="n">setRoot</span><span class="p">(</span><span class="n">RANK_ZERO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">gloo</span><span class="o">::</span><span class="n">broadcast</span><span class="p">(</span><span class="n">opts</span><span class="p">);</span> <span class="c1">// 广播给其他rank
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Boardcast the response
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">gloo</span><span class="o">::</span><span class="n">BroadcastOptions</span> <span class="n">opts</span><span class="p">(</span><span class="n">gloo_context_</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">opts</span><span class="p">.</span><span class="n">setOutput</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">encoded_response</span><span class="p">.</span><span class="n">c_str</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                   <span class="n">encoded_response_length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">opts</span><span class="p">.</span><span class="n">setRoot</span><span class="p">(</span><span class="n">RANK_ZERO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">gloo</span><span class="o">::</span><span class="n">broadcast</span><span class="p">(</span><span class="n">opts</span><span class="p">);</span> <span class="c1">// 广播给其他rank
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-mpi-实现">5 Mpi 实现<a hidden class="anchor" aria-hidden="true" href="#5-mpi-实现">#</a></h2>
<h3 id="51-openmpi-库">5.1 openmpi 库<a hidden class="anchor" aria-hidden="true" href="#51-openmpi-库">#</a></h3>
<p>horovod 这里主要依赖 openmpi。</p>
<ul>
<li>MPI：英文全称是Message Passing Interface，MPI是一个跨语言的通讯协议，用于编写并行计算机。支持点对点和广播。MPI是一个信息传递应用程序接口，包括协议和和语义说明，他们指明其如何在各种实现中发挥其特性。MPI的目标是高性能，大规模性，和可移植性。</li>
<li>openMPI：英文全称是open Message Passing Interface。openMPI是MPI的一种实现，一种库项目。</li>
</ul>
<p>MPI在Hovorod的角色比较特殊：</p>
<ul>
<li>
<p>一方面Horovod内集成了<strong>基于MPI的AllReduce</strong>，类似于NCCL，都是用作梯度规约；</p>
</li>
<li>
<p>另一方面，MPI可以用来在所有机器上<strong>启动多个进程(Hovorod里用Rank表示)，实现并行计算</strong>；</p>
</li>
</ul>
<h3 id="52-mpi_run-函数">5.2 mpi_run 函数<a hidden class="anchor" aria-hidden="true" href="#52-mpi_run-函数">#</a></h3>
<p>此部分代码位于：horovod/runner/mpi_run.py。</p>
<p>首先摘录其关键代码如下，可以看出来其核心是运行 mpirun 命令。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 我是下面大段代码中的关键代码！</span>
</span></span><span class="line"><span class="cl"><span class="n">mpirun_command</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;mpirun </span><span class="si">{basic_args}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;-np </span><span class="si">{num_proc}{ppn_arg}{hosts_arg}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{binding_args}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{mpi_args}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{mpi_ssh_args}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{tcp_intf_arg}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{nccl_socket_intf_arg}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{output_filename_arg}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{env}</span><span class="s1"> </span><span class="si">{extra_mpi_args}</span><span class="s1"> </span><span class="si">{command}</span><span class="s1">&#39;</span>  
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basic_args</span><span class="o">=</span><span class="n">basic_args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">num_proc</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">num_proc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">ppn_arg</span><span class="o">=</span><span class="n">ppn_arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">hosts_arg</span><span class="o">=</span><span class="n">hosts_arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">binding_args</span><span class="o">=</span><span class="n">binding_args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">mpi_args</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpi_impl_flags</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">tcp_intf_arg</span><span class="o">=</span><span class="n">tcp_intf_arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">nccl_socket_intf_arg</span><span class="o">=</span><span class="n">nccl_socket_intf_arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">mpi_ssh_args</span><span class="o">=</span><span class="n">mpi_ssh_args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">output_filename_arg</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="o">=</span><span class="n">env_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">extra_mpi_args</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">extra_mpi_args</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">extra_mpi_args</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">command</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">command</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Execute the mpirun command.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">run_func_mode</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">safe_shell_exec</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mpirun_command</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">mpirun_command</span><span class="p">],</span> <span class="n">env</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>就是依据各种配置以及参数来构建 mpirun 命令的所有参数，比如 ssh 的参数，mpi 参数，nccl 参数等等。</p>
<p>最后得到的 mpirun 命令举例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mpirun --allow-run-as-root --np <span class="m">2</span> -bind-to none -map-by slot <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -x <span class="nv">NCCL_DEBUG</span><span class="o">=</span>INFO -x LD_LIBRARY_PATH -x PATH <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -mca pml ob1 -mca btl ^openib <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    python train.py
</span></span></code></pre></td></tr></table>
</div>
</div><p>具体代码如下，具体是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 上面代码是我之中的片段</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mpi_run</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">nics</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Runs mpi_run.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        settings: Settings for running MPI.
</span></span></span><span class="line"><span class="cl"><span class="s2">                  Note: settings.num_proc and settings.hosts must not be None.
</span></span></span><span class="line"><span class="cl"><span class="s2">        nics: Interfaces to include by MPI.
</span></span></span><span class="line"><span class="cl"><span class="s2">        env: Environment dictionary to use for running command.
</span></span></span><span class="line"><span class="cl"><span class="s2">        command: Command and arguments to run as a list of string.
</span></span></span><span class="line"><span class="cl"><span class="s2">        stdout: Stdout of the mpi process.
</span></span></span><span class="line"><span class="cl"><span class="s2">                Only used when settings.run_func_mode is True.
</span></span></span><span class="line"><span class="cl"><span class="s2">        stderr: Stderr of the mpi process.
</span></span></span><span class="line"><span class="cl"><span class="s2">                Only used when settings.run_func_mode is True.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 得到各种配置</span>
</span></span><span class="line"><span class="cl">    <span class="n">mpi_impl_flags</span><span class="p">,</span> <span class="n">impl_binding_args</span><span class="p">,</span> <span class="n">mpi</span> <span class="o">=</span> <span class="n">_get_mpi_implementation_flags</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">tcp_flag</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">impi</span> <span class="o">=</span> <span class="n">_IMPI_IMPL</span> <span class="o">==</span> <span class="n">mpi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 处理ssh参数</span>
</span></span><span class="line"><span class="cl">    <span class="n">ssh_args</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ssh_port</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ssh_args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;-p </span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">ssh_port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ssh_identity_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ssh_args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;-i </span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">ssh_identity_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mpi_ssh_args</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">ssh_args</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">joined_ssh_args</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ssh_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mpi_ssh_args</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;-bootstrap=ssh -bootstrap-exec-args </span><span class="se">\&#34;</span><span class="si">{</span><span class="n">joined_ssh_args</span><span class="si">}</span><span class="se">\&#34;</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">impi</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;-mca plm_rsh_args </span><span class="se">\&#34;</span><span class="si">{</span><span class="n">joined_ssh_args</span><span class="si">}</span><span class="se">\&#34;</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 处理网络配置，网卡信息等    </span>
</span></span><span class="line"><span class="cl">    <span class="n">tcp_intf_arg</span> <span class="o">=</span> <span class="s1">&#39;-mca btl_tcp_if_include </span><span class="si">{nics}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">nics</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nics</span><span class="p">))</span> <span class="k">if</span> <span class="n">nics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">impi</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nccl_socket_intf_arg</span> <span class="o">=</span> <span class="s1">&#39;-</span><span class="si">{opt}</span><span class="s1"> NCCL_SOCKET_IFNAME=</span><span class="si">{nics}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;genv&#39;</span> <span class="k">if</span> <span class="n">impi</span> <span class="k">else</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">nics</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nics</span><span class="p">))</span> <span class="k">if</span> <span class="n">nics</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 处理host信息</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># On large cluster runs (e.g. Summit), we need extra settings to work around OpenMPI issues</span>
</span></span><span class="line"><span class="cl">    <span class="n">host_names</span><span class="p">,</span> <span class="n">host_to_slots</span> <span class="o">=</span> <span class="n">hosts</span><span class="o">.</span><span class="n">parse_hosts_and_slots</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">hosts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">impi</span> <span class="ow">and</span> <span class="n">host_names</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">host_names</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">_LARGE_CLUSTER_THRESHOLD</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mpi_impl_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-mca plm_rsh_no_tree_spawn true&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mpi_impl_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-mca plm_rsh_num_concurrent </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">host_names</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># if user does not specify any hosts, mpirun by default uses local host.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># There is no need to specify localhost.</span>
</span></span><span class="line"><span class="cl">    <span class="n">hosts_arg</span> <span class="o">=</span> <span class="s1">&#39;-</span><span class="si">{opt}</span><span class="s1"> </span><span class="si">{hosts}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;hosts&#39;</span> <span class="k">if</span> <span class="n">impi</span> <span class="k">else</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">hosts</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">host_names</span><span class="p">)</span> <span class="k">if</span> <span class="n">host_names</span> <span class="ow">and</span> <span class="n">impi</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">hosts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 处理ppn配置</span>
</span></span><span class="line"><span class="cl">    <span class="n">ppn_arg</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">host_to_slots</span> <span class="ow">and</span> <span class="n">impi</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ppn</span> <span class="o">=</span> <span class="n">host_to_slots</span><span class="p">[</span><span class="n">host_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">h_name</span> <span class="ow">in</span> <span class="n">host_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ppn_arg</span> <span class="o">=</span> <span class="s1">&#39; -ppn </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ppn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 处理超时配置    </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">prefix_output_with_timestamp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">impi</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mpi_impl_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--timestamp-output&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">binding_args</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">binding_args</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">binding_args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">impi</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">impl_binding_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 配置需要root身份运行</span>
</span></span><span class="line"><span class="cl">    <span class="n">basic_args</span> <span class="o">=</span> <span class="s1">&#39;-l&#39;</span> <span class="k">if</span> <span class="n">impi</span> <span class="k">else</span> <span class="s1">&#39;--allow-run-as-root --tag-output&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">output_filename</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-outfile-pattern&#39;</span> <span class="k">if</span> <span class="n">impi</span> <span class="k">else</span> <span class="s1">&#39;--output-filename&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">output_filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 构建环境信息列表    </span>
</span></span><span class="line"><span class="cl">    <span class="n">env_list</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">impi</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;-x </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">env_util</span><span class="o">.</span><span class="n">is_exportable</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 构建最终的 MPI 命令</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Pass all the env variables to the mpirun command.</span>
</span></span><span class="line"><span class="cl">    <span class="n">mpirun_command</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;mpirun </span><span class="si">{basic_args}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;-np </span><span class="si">{num_proc}{ppn_arg}{hosts_arg}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{binding_args}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{mpi_args}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{mpi_ssh_args}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{tcp_intf_arg}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{nccl_socket_intf_arg}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{output_filename_arg}</span><span class="s1"> &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;</span><span class="si">{env}</span><span class="s1"> </span><span class="si">{extra_mpi_args}</span><span class="s1"> </span><span class="si">{command}</span><span class="s1">&#39;</span>  <span class="c1"># expect a lot of environment variables</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basic_args</span><span class="o">=</span><span class="n">basic_args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">num_proc</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">num_proc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">ppn_arg</span><span class="o">=</span><span class="n">ppn_arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">hosts_arg</span><span class="o">=</span><span class="n">hosts_arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">binding_args</span><span class="o">=</span><span class="n">binding_args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">mpi_args</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpi_impl_flags</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">tcp_intf_arg</span><span class="o">=</span><span class="n">tcp_intf_arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">nccl_socket_intf_arg</span><span class="o">=</span><span class="n">nccl_socket_intf_arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">mpi_ssh_args</span><span class="o">=</span><span class="n">mpi_ssh_args</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">output_filename_arg</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="o">=</span><span class="n">env_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">extra_mpi_args</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">extra_mpi_args</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">extra_mpi_args</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">command</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">command</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># we need the driver&#39;s PATH and PYTHONPATH in env to run mpirun,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># env for mpirun is different to env encoded in mpirun_command</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># copy env so we do not leak env modifications</span>
</span></span><span class="line"><span class="cl">            <span class="n">env</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># copy var over from os.environ</span>
</span></span><span class="line"><span class="cl">            <span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Execute the mpirun command.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">run_func_mode</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">safe_shell_exec</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mpirun_command</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">mpirun_command</span><span class="p">],</span> <span class="n">env</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-mpirun命令">5.3 mpirun命令<a hidden class="anchor" aria-hidden="true" href="#53-mpirun命令">#</a></h3>
<p>因为 mpi_run 使用的是 mpirun 命令来运行，所以我们介绍一下。</p>
<p>mpirun是MPI程序的启动脚本，它简化了并行进程的启动过程，尽可能屏蔽了底层的实现细节，从而为用户提供了一个通用的MPI并行机制。</p>
<p>在用mpirun命令执行并行程序时，参数-np指明了需要并行运行的进程个数。mpirun首先在本地结点上启动一个进程，然后根据/usr/local/share/machines.LINUX文件中所列出的主机，为每个主机启动一个进程。若进程数比可用的并行节点数多，则多余的进程将重新按照上述规则进行。按这个机制分配好进程后，一般会给每个节点分一个固定的标号，类似于身份证了，后续在消息传递中会用到。</p>
<p>这里需要说明的是，实际运行的</p>
<p>orterun(Open MPI SPMD / MPMD启动器; mpirun / mpiexec只是它的符号链接)</p>
<p>命令举例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> \
</span></span><span class="line"><span class="cl">    <span class="o">-</span><span class="n">bind</span><span class="o">-</span><span class="n">to</span> <span class="n">none</span> <span class="o">-</span><span class="nb">map</span><span class="o">-</span><span class="n">by</span> <span class="n">slot</span> \
</span></span><span class="line"><span class="cl">    <span class="o">-</span><span class="n">x</span> <span class="n">NCCL_DEBUG</span><span class="o">=</span><span class="n">INFO</span> <span class="o">-</span><span class="n">x</span> <span class="n">LD_LIBRARY_PATH</span> <span class="o">-</span><span class="n">x</span> <span class="n">PATH</span> \
</span></span><span class="line"><span class="cl">    <span class="o">-</span><span class="n">mca</span> <span class="n">pml</span> <span class="n">ob1</span> <span class="o">-</span><span class="n">mca</span> <span class="n">btl</span> <span class="o">^</span><span class="n">openib</span> \
</span></span><span class="line"><span class="cl">    <span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="n">py</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-总结">6 总结<a hidden class="anchor" aria-hidden="true" href="#6-总结">#</a></h2>
<p>对比 gloo 和 mpi 的实现，我们还是能看出来区别。</p>
<h3 id="61-gloo">6.1 gloo<a hidden class="anchor" aria-hidden="true" href="#61-gloo">#</a></h3>
<p>gloo 只是一个库，需要 horovod 来完成命令分发功能。</p>
<p>gloo 需要 horovod 自己实现本地运行和远端运行方式，即 get_remote_command 函数 实现 <code>'ssh -o PasswordAuthentication=no -o StrictHostKeyChecking=no'</code>。</p>
<p>gloo 需要实现 RendezvousServer，底层会利用 RendezvousServer 进行通讯。</p>
<h3 id="62-mpi">6.2 mpi<a hidden class="anchor" aria-hidden="true" href="#62-mpi">#</a></h3>
<p>mpi 则功能强大很多，只要把命令配置成被 mpirun 包装，openmpi 就可以自行完成命令分发执行。说到底，horovod 是一个 mpirun 程序，即使运行了 tensor flow，也是一个mpi程序，可以互相交互。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jianye0428.github.io/en/tags/horovod/">Horovod</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://jianye0428.github.io/en/posts/notes/2022-10-09_transformer/">
    <span class="title"><i class="fas fa-angle-double-left"></i> Prev Page</span>
    <br>
    <span>Transformer Overview</span>
  </a>
  <a class="next" href="https://jianye0428.github.io/en/posts/notes/2022-10-08_horovod_2/">
    <span class="title">Next Page <i class="fas fa-angle-double-right"></i></span>
    <br>
    <span>深度学习分布式训练框架 Horovod[2] -- 从使用者角度切入</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share 深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么 on twitter"
        href="https://twitter.com/intent/tweet/?text=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20horovod%283%29%20---%20Horovodrun%e8%83%8c%e5%90%8e%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88&amp;url=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-09_horovod_3%2f&amp;hashtags=Horovod">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么 on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-09_horovod_3%2f&amp;title=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20horovod%283%29%20---%20Horovodrun%e8%83%8c%e5%90%8e%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88&amp;summary=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20horovod%283%29%20---%20Horovodrun%e8%83%8c%e5%90%8e%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88&amp;source=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-09_horovod_3%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么 on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-09_horovod_3%2f&title=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20horovod%283%29%20---%20Horovodrun%e8%83%8c%e5%90%8e%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么 on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-09_horovod_3%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么 on whatsapp"
        href="https://api.whatsapp.com/send?text=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20horovod%283%29%20---%20Horovodrun%e8%83%8c%e5%90%8e%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88%20-%20https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-09_horovod_3%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 深度学习分布式训练框架 horovod(3) --- Horovodrun背后做了什么 on telegram"
        href="https://telegram.me/share/url?text=%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83%e6%a1%86%e6%9e%b6%20horovod%283%29%20---%20Horovodrun%e8%83%8c%e5%90%8e%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88&amp;url=https%3a%2f%2fjianye0428.github.io%2fen%2fposts%2fnotes%2f2022-10-09_horovod_3%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>

  </footer>




<footer class="tc-container" id="comment">
    <div class="tc-title"><p class="c-title">Discussion</p></div>
    <div id="tcomments"></div>
</footer>
<script crossorigin="anonymous" src="/js/twikoo.min.b16100b7cf8a61759eab076a122482054e083087aad37c3be1fe2e293934dc34.js" integrity="sha256-sWEAt8&#43;KYXWeqwdqEiSCBU4IMIeq03w74f4uKTk03DQ="></script>
<script>
    twikoo.init({
        envId: 'https://my-repository-pink.vercel.app/',
        el: '#tcomments',
        region: 'ap-shanghai', 
        
        lang: 'zh-CN', 
    });
</script>

</article>
    </main>
    
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
